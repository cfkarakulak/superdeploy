"""
Project initialization V2 - with secrets.yml only
"""

import yaml
import click
import secrets
from datetime import datetime
from rich.console import Console
from cli.ui_components import show_header
from rich.prompt import Prompt, Confirm

console = Console()


@click.command(name="init")
@click.option("--project", "-p", required=True, help="Project name")
def init(project):
    """
    Initialize new project with secrets.yml

    Creates:
    - project.yml (infrastructure config)
    - secrets.yml (secret management)

    No more .env files!
    """
    show_header(
        title="Initialize Project V2",
        project=project,
        subtitle="Secret hierarchy + minimal config",
        console=console,
    )

    from cli.utils import get_project_root

    project_root = get_project_root()
    project_dir = project_root / "projects" / project

    # Check if project exists
    if project_dir.exists():
        console.print(f"[yellow]‚ö†Ô∏è  Project already exists: {project}[/yellow]")
        if not Confirm.ask("Overwrite?", default=False):
            return

    project_dir.mkdir(parents=True, exist_ok=True)

    # Interactive prompts
    console.print("\n[bold cyan]üìã Project Configuration[/bold cyan]\n")

    # GCP
    console.print("[bold]Cloud Provider:[/bold]")
    gcp_project = Prompt.ask("GCP Project ID", default="my-gcp-project")
    gcp_region = Prompt.ask("GCP Region", default="us-central1")

    # GitHub
    console.print("\n[bold]GitHub:[/bold]")
    github_org = Prompt.ask("GitHub Organization", default=f"{project}io")

    # Apps
    console.print("\n[bold]Applications:[/bold]")
    console.print("[dim]Enter app names (comma-separated)[/dim]")
    apps_input = Prompt.ask("Apps", default="api,services,storefront")
    app_names = [a.strip() for a in apps_input.split(",")]

    # App paths
    apps = {}
    for app_name in app_names:
        default_path = f"/path/to/{app_name}"
        app_path = Prompt.ask(f"  {app_name} path", default=default_path)
        apps[app_name] = {
            "path": app_path,
            "vm": "app",
            "port": 8000 if "api" in app_name else 3000,
        }

    # Generate project.yml
    project_config = {
        "project": {
            "name": project,
            "description": f"{project} project",
            "created_at": datetime.now().isoformat(),
            "ssl_email": f"admin@{project}.io",
        },
        "cloud": {
            "gcp": {
                "project_id": gcp_project,
                "region": gcp_region,
                "zone": f"{gcp_region}-a",
            },
            "ssh": {
                "key_path": "~/.ssh/superdeploy_deploy",
                "public_key_path": "~/.ssh/superdeploy_deploy.pub",
                "user": "superdeploy",
            },
        },
        "vms": {
            "core": {
                "count": 1,
                "machine_type": "e2-medium",
                "disk_size": 20,
                "services": ["rabbitmq", "postgres"],
            },
            "app": {
                "count": 1,
                "machine_type": "e2-medium",
                "disk_size": 30,
                "services": [],
            },
        },
        "addons": {
            "rabbitmq": {"version": "3.12-management-alpine"},
            "postgres": {"version": "15-alpine"},
            "caddy": {"version": "2-alpine"},
        },
        "apps": apps,
        "docker": {
            "registry": "docker.io",
            "organization": "your-docker-org",  # User needs to edit
        },
        "github": {"organization": github_org},
        "network": {
            "vpc_subnet": "10.1.0.0/16",
            "docker_subnet": "172.30.0.0/24",
        },
    }

    # Generate project.yml with proper formatting
    project_yml = project_dir / "project.yml"

    # Build formatted YAML with comments
    yml_lines = []
    yml_lines.append("# " + "=" * 77)
    yml_lines.append(f"# {project} - Project Configuration")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append(f"# Auto-generated by: superdeploy init -p {project}")
    yml_lines.append(f"# Edit this file, then run: superdeploy generate -p {project}")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append("")
    yml_lines.append("# Project Information")
    yml_lines.append(
        yaml.dump(
            {"project": project_config["project"]},
            default_flow_style=False,
            sort_keys=False,
        ).strip()
    )
    yml_lines.append("")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append("# Cloud Provider Configuration")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append(
        yaml.dump(
            {"cloud": project_config["cloud"]},
            default_flow_style=False,
            sort_keys=False,
        ).strip()
    )
    yml_lines.append("")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append("# VMs (Infrastructure)")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append(
        yaml.dump(
            {"vms": project_config["vms"]}, default_flow_style=False, sort_keys=False
        ).strip()
    )
    yml_lines.append("")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append("# Addons Configuration")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append(
        yaml.dump(
            {"addons": project_config["addons"]},
            default_flow_style=False,
            sort_keys=False,
        ).strip()
    )
    yml_lines.append("")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append("# Application Services")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append(
        yaml.dump(
            {"apps": project_config["apps"]}, default_flow_style=False, sort_keys=False
        ).strip()
    )
    yml_lines.append("")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append("# Docker Configuration")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append(
        yaml.dump(
            {"docker": project_config["docker"]},
            default_flow_style=False,
            sort_keys=False,
        ).strip()
    )
    yml_lines.append("")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append("# GitHub Configuration")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append(
        yaml.dump(
            {"github": project_config["github"]},
            default_flow_style=False,
            sort_keys=False,
        ).strip()
    )
    yml_lines.append("")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append("# Network Configuration")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append(
        yaml.dump(
            {"network": project_config["network"]},
            default_flow_style=False,
            sort_keys=False,
        ).strip()
    )
    yml_lines.append("")

    with open(project_yml, "w") as f:
        f.write("\n".join(yml_lines))

    console.print(f"\n[green]‚úì[/green] Created: {project_yml}")

    # Generate secrets.yml with template
    console.print("\n[bold cyan]üîê Generating secrets...[/bold cyan]\n")

    postgres_password = secrets.token_urlsafe(32)
    rabbitmq_password = secrets.token_urlsafe(32)

    passwords_config = {
        "secrets": {
            "shared": {
                "POSTGRES_HOST": "postgres",
                "POSTGRES_PORT": "5432",
                "POSTGRES_USER": f"{project}_user",
                "POSTGRES_PASSWORD": postgres_password,
                "POSTGRES_DB": f"{project}_db",
                "RABBITMQ_HOST": "rabbitmq",
                "RABBITMQ_PORT": "5672",
                "RABBITMQ_USER": f"{project}_user",
                "RABBITMQ_PASSWORD": rabbitmq_password,
            }
        },
        "env_aliases": {},
    }

    # Add app-specific sections with env_aliases templates
    for app_name in app_names:
        passwords_config["secrets"][app_name] = {}

        # Add env_aliases templates per app
        if "api" in app_name or "service" in app_name:
            # Python apps (Cara framework)
            passwords_config["env_aliases"][app_name] = {
                "DB_CONNECTION": "app",
                "DB_HOST": "POSTGRES_HOST",
                "DB_PORT": "POSTGRES_PORT",
                "DB_USERNAME": "POSTGRES_USER",
                "DB_PASSWORD": "POSTGRES_PASSWORD",
                "DB_DATABASE": "POSTGRES_DB",
            }
        elif "storefront" in app_name or "dashboard" in app_name:
            # Next.js apps
            passwords_config["env_aliases"][app_name] = {
                "NEXT_PUBLIC_API_CLIENT_URL": "http://10.1.0.2:8000/api",
                "API_BASE_URL": "http://10.1.0.2:8000",
                "NEXT_PUBLIC_API_BASE_URL": "http://10.1.0.2:8000",
                "NEXT_PUBLIC_API_URL": "http://10.1.0.2:8000",
                "NEXT_PUBLIC_API_SERVER_URL": "http://10.1.0.2:8000",
            }

    # Generate secrets.yml with beautiful formatting
    passwords_yml = project_dir / "secrets.yml"

    yml_lines = []
    yml_lines.append("# " + "=" * 77)
    yml_lines.append(f"# {project} - Secrets & Environment Aliases")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append(f"# Auto-generated by: superdeploy init -p {project}")
    yml_lines.append("# This file contains ALL secrets - DO NOT COMMIT TO GIT!")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append("")
    yml_lines.append("secrets:")
    yml_lines.append("  # " + "=" * 75)
    yml_lines.append("  # Shared Secrets (available to all apps)")
    yml_lines.append("  # " + "=" * 75)
    yml_lines.append("  shared:")
    yml_lines.append("    # PostgreSQL")
    yml_lines.append(
        f"    POSTGRES_HOST: {passwords_config['secrets']['shared']['POSTGRES_HOST']}"
    )
    yml_lines.append(
        f"    POSTGRES_PORT: '{passwords_config['secrets']['shared']['POSTGRES_PORT']}'"
    )
    yml_lines.append(
        f"    POSTGRES_USER: {passwords_config['secrets']['shared']['POSTGRES_USER']}"
    )
    yml_lines.append(
        f"    POSTGRES_PASSWORD: {passwords_config['secrets']['shared']['POSTGRES_PASSWORD']}"
    )
    yml_lines.append(
        f"    POSTGRES_DB: {passwords_config['secrets']['shared']['POSTGRES_DB']}"
    )
    yml_lines.append("    ")
    yml_lines.append("    # RabbitMQ")
    yml_lines.append(
        f"    RABBITMQ_HOST: {passwords_config['secrets']['shared']['RABBITMQ_HOST']}"
    )
    yml_lines.append(
        f"    RABBITMQ_PORT: '{passwords_config['secrets']['shared']['RABBITMQ_PORT']}'"
    )
    yml_lines.append(
        f"    RABBITMQ_USER: {passwords_config['secrets']['shared']['RABBITMQ_USER']}"
    )
    yml_lines.append(
        f"    RABBITMQ_PASSWORD: {passwords_config['secrets']['shared']['RABBITMQ_PASSWORD']}"
    )
    yml_lines.append("  ")
    yml_lines.append("  # " + "=" * 75)
    yml_lines.append("  # App-Specific Secrets")
    yml_lines.append("  # " + "=" * 75)
    yml_lines.append("  ")
    for app_name in app_names:
        yml_lines.append(f"  {app_name}: {{}}")
        yml_lines.append("  ")
    yml_lines.append("")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append("# Environment Variable Aliases (per app)")
    yml_lines.append("# " + "=" * 77)
    yml_lines.append("# These create aliases that reference secrets above")
    yml_lines.append(
        "# Format: ALIAS_NAME: SECRET_NAME (uppercase = reference, lowercase = static)"
    )
    yml_lines.append("# " + "=" * 77)
    yml_lines.append("")
    yml_lines.append("env_aliases:")
    for app_name in app_names:
        yml_lines.append(f"  # {app_name.title()} App")
        yml_lines.append(f"  {app_name}:")
        if app_name in passwords_config["env_aliases"]:
            for key, value in passwords_config["env_aliases"][app_name].items():
                yml_lines.append(f"    {key}: {value}")
        yml_lines.append("  ")

    with open(passwords_yml, "w") as f:
        f.write("\n".join(yml_lines))

    # Set restrictive permissions
    passwords_yml.chmod(0o600)

    console.print(f"[green]‚úì[/green] Created: {passwords_yml}")
    console.print("[dim]  Generated secure passwords for addons[/dim]")
    console.print("[yellow]  ‚ö†Ô∏è  Add app-specific secrets manually[/yellow]")

    # Summary
    console.print("\n[green]‚úÖ Project initialized![/green]")
    console.print("\n[bold]üìù Next steps:[/bold]")
    console.print("\n1. Edit secrets:")
    console.print(f"   nano {passwords_yml}")
    console.print("   [dim]Add app-specific secrets (API keys, etc.)[/dim]")
    console.print("\n2. Generate deployment files:")
    console.print(f"   superdeploy generate -p {project}")
    console.print("\n3. Deploy infrastructure:")
    console.print(f"   superdeploy up -p {project}")

    # Show passwords
    console.print("\n[bold cyan]üîë Generated Passwords:[/bold cyan]")
    console.print(
        f"[dim]PostgreSQL: {passwords_config['secrets']['shared']['POSTGRES_PASSWORD'][:20]}...[/dim]"
    )
    console.print(
        f"[dim]RabbitMQ:   {passwords_config['secrets']['shared']['RABBITMQ_PASSWORD'][:20]}...[/dim]"
    )
    console.print(
        "[yellow]‚ö†Ô∏è  These are saved in secrets.yml (DO NOT commit!)[/yellow]"
    )
