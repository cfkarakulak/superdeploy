# ═══════════════════════════════════════════════════════════════════════════
# {{PROJECT}} PROJECT - APPLICATION SERVICES
# ═══════════════════════════════════════════════════════════════════════════
# Auto-generated from template by superdeploy init
# These services are deployed selectively based on GitHub Actions input.
# ═══════════════════════════════════════════════════════════════════════════

networks:
  # Use the network created by docker-compose.core.yml
  {{PROJECT}}-network:
    external: true
    name: {{PROJECT}}-network

volumes:
{% for service in SERVICES_LIST %}
  {{service}}-data:
    name: {{PROJECT}}-{{service}}-data
{% endfor %}

services:
{% for service in SERVICES_LIST %}
  # ═══════════════════════════════════════════════════════════════════════════
  # {{service|upper}} Service
  # ═══════════════════════════════════════════════════════════════════════════
  {{service}}:
    image: ${DOCKER_REGISTRY}/${DOCKER_ORG}/{{service}}:${{'{'}}{{service|upper}}_IMAGE_TAG:-latest{{'}'}}
    container_name: {{PROJECT}}-{{service}}
    restart: unless-stopped
    # Environment variables injected via Forgejo workflow (from GitHub Secrets)
    volumes:
      - {{service}}-data:/app/data
    ports:
      - "${{'{'}}{{service|upper}}_PORT:-{{PORTS[service].external|default(8000)}}{{'}'}}:{{PORTS[service].internal|default(8000)}}"
    networks:
      - {{PROJECT}}-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:{{PORTS[service].internal|default(8000)}}/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 256M
    stop_grace_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.superdeploy.project={{PROJECT}}"
      - "com.superdeploy.service={{service}}"
      - "com.superdeploy.release=${RELEASE_VERSION:-unknown}"
      - "com.superdeploy.git.sha=${GIT_SHA:-unknown}"
      - "com.superdeploy.deployed.at=${DEPLOY_TIMESTAMP:-unknown}"
{% endfor %}
