---
# Core Services deployment - API, DB, Queue, Edge, Proxy Registry
# This role deploys the main application services (separate from Forgejo)

- name: Copy all compose files from local to remote
  copy:
    src: "../../../deploy/compose/vm1-core/"
    dest: "/opt/superdeploy/compose/"
    owner: superdeploy
    group: superdeploy
    mode: preserve

- name: Use full docker-compose.yml
  copy:
    src: "/opt/superdeploy/compose/docker-compose.full.yml"
    dest: "/opt/superdeploy/compose/docker-compose.yml"
    remote_src: yes
    owner: superdeploy
    group: superdeploy
    mode: '0644'

- name: Generate environment file
  template:
    src: core.env.j2
    dest: /opt/superdeploy/compose/.env
    owner: superdeploy
    group: superdeploy
    mode: '0600'

- name: Create systemd service for Docker Compose
  copy:
    content: |
      [Unit]
      Description=SuperDeploy Core Services
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/superdeploy/compose
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down
      User=superdeploy
      Group=superdeploy

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/superdeploy-core.service
    mode: '0644'

- name: Enable and start superdeploy-core service
  systemd:
    name: superdeploy-core
    enabled: yes
    state: started
    daemon_reload: yes

- name: Configure logrotate for Docker logs
  copy:
    content: |
      /opt/superdeploy/logs/*.log {
          daily
          missingok
          rotate 7
          compress
          delaycompress
          notifempty
          create 0644 superdeploy superdeploy
      }
    dest: /etc/logrotate.d/superdeploy
    mode: '0644'

