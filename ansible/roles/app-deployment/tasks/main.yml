---
# Core Services deployment - PostgreSQL, RabbitMQ, Caddy
# This role deploys the core infrastructure services (separate from app services)

- name: Clone superdeploy repository
  git:
    repo: "https://github.com/cfkarakulak/superdeploy.git"
    dest: "/opt/superdeploy"
    version: "master"
    force: yes
  become_user: superdeploy

- name: Ensure proper ownership of superdeploy directory
  file:
    path: /opt/superdeploy
    owner: superdeploy
    group: superdeploy
    recurse: yes

- name: Generate environment file for core services (Cheapa project)
  template:
    src: core.env.j2
    dest: /opt/superdeploy/projects/cheapa/compose/.env
    owner: superdeploy
    group: superdeploy
    mode: '0600'

- name: Create Docker network for Cheapa project
  shell: docker network create cheapa-network 2>/dev/null || true
  become_user: superdeploy

- name: Start core services (PostgreSQL, RabbitMQ, Caddy, Redis) for Cheapa
  shell: |
    cd /opt/superdeploy/projects/cheapa/compose
    export POSTGRES_USER="cheapa_user"
    export POSTGRES_PASSWORD="{{ lookup('env', 'POSTGRES_PASSWORD') }}"
    export POSTGRES_DB="cheapa_db"
    export RABBITMQ_USER="cheapa_user"
    export RABBITMQ_PASSWORD="{{ lookup('env', 'RABBITMQ_PASSWORD') }}"
    export REDIS_PASSWORD="{{ lookup('env', 'REDIS_PASSWORD') }}"
    docker compose -f docker-compose.core.yml up -d
  become_user: superdeploy
  environment:
    FORGEJO_DB_NAME: "forgejo"
    FORGEJO_DB_USER: "forgejo"
    FORGEJO_DB_PASSWORD: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"
    FORGEJO_SECRET_KEY: "dummy"

- name: Create systemd service for Cheapa core services persistence
  copy:
    content: |
      [Unit]
      Description=Cheapa Core Services (PostgreSQL, RabbitMQ, Redis, Caddy)
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/superdeploy/projects/cheapa/compose
      EnvironmentFile=/opt/superdeploy/projects/cheapa/compose/.env
      ExecStart=/usr/bin/docker compose -f docker-compose.core.yml up -d
      ExecStop=/usr/bin/docker compose -f docker-compose.core.yml stop
      User=superdeploy
      Group=superdeploy

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/cheapa-core.service
    mode: '0644'

- name: Enable cheapa-core service (for VM restart persistence)
  systemd:
    name: cheapa-core
    enabled: yes
    daemon_reload: yes

- name: Configure logrotate for Docker logs
  copy:
    content: |
      /opt/superdeploy/logs/*.log {
          daily
          missingok
          rotate 7
          compress
          delaycompress
          notifempty
          create 0644 superdeploy superdeploy
      }
    dest: /etc/logrotate.d/superdeploy
    mode: '0644'

