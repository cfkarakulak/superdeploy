---
# Core Services deployment - PostgreSQL, RabbitMQ, Caddy
# This role deploys the core infrastructure services (separate from app services)

- name: Copy compose directory from superdeploy repository
  synchronize:
    src: "../../../../compose/"
    dest: "/opt/superdeploy/compose/"
    delete: no
    recursive: yes
  delegate_to: localhost

- name: Fix ownership of compose directory
  file:
    path: /opt/superdeploy/compose
    owner: superdeploy
    group: superdeploy
    recurse: yes

- name: Generate environment file for core services
  template:
    src: core.env.j2
    dest: /opt/superdeploy/compose/.env
    owner: superdeploy
    group: superdeploy
    mode: '0600'

- name: Create Docker network for app services
  shell: docker network create app-network 2>/dev/null || true
  become_user: superdeploy

- name: Start core services (PostgreSQL, RabbitMQ, Caddy)
  shell: |
    cd /opt/superdeploy/compose
    export POSTGRES_USER=superdeploy
    export POSTGRES_PASSWORD="{{ lookup('env', 'POSTGRES_PASSWORD') }}"
    export POSTGRES_DB=superdeploy_db
    export RABBITMQ_USER=superdeploy
    export RABBITMQ_PASSWORD="{{ lookup('env', 'RABBITMQ_PASSWORD') }}"
    docker compose -f docker-compose.core.yml up -d postgres rabbitmq caddy
  become_user: superdeploy
  environment:
    FORGEJO_DB_NAME: "forgejo"
    FORGEJO_DB_USER: "forgejo"
    FORGEJO_DB_PASSWORD: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"
    FORGEJO_SECRET_KEY: "dummy"

- name: Create systemd service for core services persistence
  copy:
    content: |
      [Unit]
      Description=SuperDeploy Core Services (PostgreSQL, RabbitMQ, Caddy)
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/superdeploy/compose
      EnvironmentFile=/opt/superdeploy/compose/.env
      ExecStart=/usr/bin/docker compose -f docker-compose.core.yml up -d postgres rabbitmq caddy
      ExecStop=/usr/bin/docker compose -f docker-compose.core.yml stop postgres rabbitmq caddy
      User=superdeploy
      Group=superdeploy

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/superdeploy-core.service
    mode: '0644'

- name: Enable superdeploy-core service (for VM restart persistence)
  systemd:
    name: superdeploy-core
    enabled: yes
    daemon_reload: yes

- name: Configure logrotate for Docker logs
  copy:
    content: |
      /opt/superdeploy/logs/*.log {
          daily
          missingok
          rotate 7
          compress
          delaycompress
          notifempty
          create 0644 superdeploy superdeploy
      }
    dest: /etc/logrotate.d/superdeploy
    mode: '0644'

