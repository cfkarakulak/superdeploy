---
# Proxy VM tasks - VM-3 (SOCKS5 and HTTP proxies)

- name: Update package cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install essential packages
  apt:
    name:
      - curl
      - wget
      - git
      - unzip
      - htop
      - vim
      - ufw
      - chrony
      - python3-pip
      - software-properties-common
      - apt-transport-https
      - ca-certificates
      - gnupg
      - lsb-release
      - dante-server
      - tinyproxy
    state: present

- name: Configure swap (minimal for proxy)
  include_tasks: swap.yml

- name: Install Docker
  block:
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/debian/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add superdeploy user to docker group
      user:
        name: superdeploy
        groups: docker
        append: yes

- name: Configure UFW firewall
  block:
    - name: Reset UFW to defaults
      ufw:
        state: reset

    - name: Set UFW default policies
      ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: 'incoming', policy: 'deny' }
        - { direction: 'outgoing', policy: 'allow' }

    - name: Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: Allow proxy ports from worker VMs
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
        src: "{{ hostvars['vm-scrape-1']['ansible_default_ipv4']['address'] }}"
      loop:
        - '1080'  # SOCKS5
        - '3128'  # HTTP
        - '8888'  # Alternative HTTP

    - name: Enable UFW
      ufw:
        state: enabled

- name: Configure chrony for time synchronization
  block:
    - name: Start and enable chrony service
      systemd:
        name: chrony
        state: started
        enabled: yes

    - name: Configure chrony servers
      lineinfile:
        path: /etc/chrony/chrony.conf
        line: "{{ item }}"
        state: present
      loop:
        - "pool 0.debian.pool.ntp.org iburst"
        - "pool 1.debian.pool.ntp.org iburst"
        - "pool 2.debian.pool.ntp.org iburst"
        - "pool 3.debian.pool.ntp.org iburst"

- name: Create application directories
  file:
    path: "{{ item }}"
    state: directory
    owner: superdeploy
    group: superdeploy
    mode: '0755'
  loop:
    - /opt/superdeploy
    - /opt/superdeploy/compose
    - /opt/superdeploy/logs
    - /opt/superdeploy/data
    - /opt/superdeploy/proxy-config

- name: Copy Docker Compose files
  copy:
    src: "../../../deploy/compose/vm3-proxy/docker-compose.simple.yml"
    dest: "/opt/superdeploy/compose/docker-compose.yml"
    owner: superdeploy
    group: superdeploy
    mode: '0644'

- name: Generate environment file
  template:
    src: proxy.env.j2
    dest: /opt/superdeploy/compose/.env
    owner: superdeploy
    group: superdeploy
    mode: '0600'

- name: Create systemd service for Docker Compose
  copy:
    content: |
      [Unit]
      Description=SuperDeploy Proxy Services
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/superdeploy/compose
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down
      User=superdeploy
      Group=superdeploy

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/superdeploy-proxy.service
    mode: '0644'

- name: Create systemd service for IP monitoring
  copy:
    content: |
      [Unit]
      Description=SuperDeploy Proxy IP Monitor
      After=network.target

      [Service]
      Type=oneshot
      User=superdeploy
      Group=superdeploy
      WorkingDirectory=/opt/superdeploy/proxy-config
      ExecStart=/opt/superdeploy/proxy-config/monitor_ip.sh
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/superdeploy-proxy-ip-monitor.service
    mode: '0644'

- name: Create systemd timer for IP monitoring
  copy:
    content: |
      [Unit]
      Description=Run SuperDeploy Proxy IP Monitor every 5 minutes
      Requires=superdeploy-proxy-ip-monitor.service

      [Timer]
      OnBootSec=5min
      OnUnitActiveSec=5min
      Unit=superdeploy-proxy-ip-monitor.service

      [Install]
      WantedBy=timers.target
    dest: /etc/systemd/system/superdeploy-proxy-ip-monitor.timer
    mode: '0644'

- name: Enable and start services
  systemd:
    name: superdeploy-proxy
    enabled: yes
    state: started
    daemon_reload: yes

- name: Configure logrotate for Docker logs
  copy:
    content: |
      /opt/superdeploy/logs/*.log {
          daily
          missingok
          rotate 7
          compress
          delaycompress
          notifempty
          create 0644 superdeploy superdeploy
      }
    dest: /etc/logrotate.d/superdeploy-proxy
    mode: '0644'