---
# Core VM tasks - VM-1 (API, DB, Queue, Edge, Proxy Registry)

- name: Wait for dpkg lock to be released
  shell: |
    timeout=300
    while [ $timeout -gt 0 ]; do
      if ! fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; then
        echo "Lock released"
        exit 0
      fi
      echo "Waiting for dpkg lock... ($timeout seconds remaining)"
      sleep 5
      timeout=$((timeout - 5))
    done
    echo "Timeout waiting for dpkg lock"
    exit 1
  changed_when: false

- name: Update package cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  retries: 5
  delay: 10
  register: apt_update
  until: apt_update is success

- name: Install essential packages
  apt:
    name:
      - curl
      - wget
      - git
      - unzip
      - htop
      - vim
      - ufw
      - chrony
      - python3-pip
      - software-properties-common
      - apt-transport-https
      - ca-certificates
      - gnupg
      - lsb-release
    state: present
  retries: 5
  delay: 10
  register: apt_install
  until: apt_install is success

- name: Configure swap
  include_tasks: swap.yml

- name: Install Docker
  block:
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/debian/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add superdeploy user to docker group
      user:
        name: superdeploy
        groups: docker
        append: yes

- name: Configure UFW firewall
  block:
    - name: Reset UFW to defaults
      ufw:
        state: reset

    - name: Set UFW default policies
      ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: 'incoming', policy: 'deny' }
        - { direction: 'outgoing', policy: 'allow' }

    - name: Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: Allow HTTP/HTTPS
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - '80'
        - '443'

    - name: Allow API direct access
      ufw:
        rule: allow
        port: '8000'
        proto: tcp

    - name: Enable UFW
      ufw:
        state: enabled

- name: Configure chrony for time synchronization
  block:
    - name: Start and enable chrony service
      systemd:
        name: chrony
        state: started
        enabled: yes

    - name: Configure chrony servers
      lineinfile:
        path: /etc/chrony/chrony.conf
        line: "{{ item }}"
        state: present
      loop:
        - "pool 0.debian.pool.ntp.org iburst"
        - "pool 1.debian.pool.ntp.org iburst"
        - "pool 2.debian.pool.ntp.org iburst"
        - "pool 3.debian.pool.ntp.org iburst"

- name: Create application directories
  file:
    path: "{{ item }}"
    state: directory
    owner: superdeploy
    group: superdeploy
    mode: '0755'
  loop:
    - /opt/superdeploy
    - /opt/superdeploy/compose
    - /opt/superdeploy/logs
    - /opt/superdeploy/data
