version: '3.8'
networks:
  cheapa-network:
    name: cheapa-network
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.0.0/24
volumes:
  rabbitmq-data:
    name: cheapa-rabbitmq-data
  postgres-data:
    name: cheapa-postgres-data
  caddy-data:
    name: cheapa-caddy-data
  caddy-config:
    name: cheapa-caddy-config
services:
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: cheapa-rabbitmq
    restart: unless-stopped
    hostname: cheapa-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST}
    volumes:
    - rabbitmq-data:/var/lib/rabbitmq
    networks:
    - cheapa-network
    expose:
    - '5672'
    - '15672'
    healthcheck:
      test:
      - CMD-SHELL
      - rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    labels:
    - prometheus.scrape=true
    - prometheus.port=15692
    - prometheus.path=/metrics
    - project=cheapa
    - service=rabbitmq
  postgres:
    image: postgres:15-alpine
    container_name: cheapa-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
    - postgres-data:/var/lib/postgresql/data
    networks:
    - cheapa-network
    expose:
    - '5432'
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    labels:
    - prometheus.scrape=true
    - prometheus.port=9187
    - prometheus.path=/metrics
    - project=cheapa
    - service=postgres
  caddy:
    image: caddy:2-alpine
    container_name: cheapa-caddy
    restart: unless-stopped
    environment:
      CADDY_DOMAIN: ${CADDY_DOMAIN}
      CADDY_EMAIL: ${CADDY_EMAIL}
      CADDY_TLS_MODE: ${CADDY_TLS_MODE}
    volumes:
    - caddy-data:/data
    - caddy-config:/config
    - ./Caddyfile:/etc/caddy/Caddyfile:ro
    ports:
    - ${CADDY_HTTP_PORT}:80
    - ${CADDY_HTTPS_PORT}:443
    - ${CADDY_ADMIN_PORT}:2019
    networks:
    - cheapa-network
    healthcheck:
      test: CMD-SHELL wget --no-verbose --tries=1 --spider http://localhost:2019/config/
        || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.1'
    labels:
    - prometheus.scrape=true
    - prometheus.port=2019
    - prometheus.path=/metrics
    - project=cheapa
    - service=caddy
