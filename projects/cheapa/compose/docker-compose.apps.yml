# ═══════════════════════════════════════════════════════════════════════════
# cheapa PROJECT - APPLICATION SERVICES
# ═══════════════════════════════════════════════════════════════════════════
# Auto-generated from template by superdeploy init
# These services are deployed selectively based on GitHub Actions input.
# ═══════════════════════════════════════════════════════════════════════════

networks:
  # Use the network created by docker-compose.core.yml
  cheapa-network:
    external: true
    name: cheapa-network

volumes:

  api-data:
    name: cheapa-api-data

  dashboard-data:
    name: cheapa-dashboard-data

  services-data:
    name: cheapa-services-data


services:

  # ═══════════════════════════════════════════════════════════════════════════
  # API Service
  # ═══════════════════════════════════════════════════════════════════════════
  api:
    image: ${DOCKER_REGISTRY}/${DOCKER_ORG}/api:${API_IMAGE_TAG:-latest}
    container_name: cheapa-api
    restart: unless-stopped
    # Environment variables injected via Forgejo workflow (from GitHub Secrets)
    volumes:
      - api-data:/app/data
    ports:
      - "${API_PORT:-8000}:8000"
    networks:
      - cheapa-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 256M
    stop_grace_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.superdeploy.project=cheapa"
      - "com.superdeploy.service=api"
      - "com.superdeploy.release=${RELEASE_VERSION:-unknown}"
      - "com.superdeploy.git.sha=${GIT_SHA:-unknown}"
      - "com.superdeploy.deployed.at=${DEPLOY_TIMESTAMP:-unknown}"

  # ═══════════════════════════════════════════════════════════════════════════
  # DASHBOARD Service
  # ═══════════════════════════════════════════════════════════════════════════
  dashboard:
    image: ${DOCKER_REGISTRY}/${DOCKER_ORG}/dashboard:${DASHBOARD_IMAGE_TAG:-latest}
    container_name: cheapa-dashboard
    restart: unless-stopped
    # Environment variables injected via Forgejo workflow (from GitHub Secrets)
    volumes:
      - dashboard-data:/app/data
    ports:
      - "${DASHBOARD_PORT:-3002}:3000"
    networks:
      - cheapa-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 256M
    stop_grace_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.superdeploy.project=cheapa"
      - "com.superdeploy.service=dashboard"
      - "com.superdeploy.release=${RELEASE_VERSION:-unknown}"
      - "com.superdeploy.git.sha=${GIT_SHA:-unknown}"
      - "com.superdeploy.deployed.at=${DEPLOY_TIMESTAMP:-unknown}"

  # ═══════════════════════════════════════════════════════════════════════════
  # SERVICES Service
  # ═══════════════════════════════════════════════════════════════════════════
  services:
    image: ${DOCKER_REGISTRY}/${DOCKER_ORG}/services:${SERVICES_IMAGE_TAG:-latest}
    container_name: cheapa-services
    restart: unless-stopped
    # Environment variables injected via Forgejo workflow (from GitHub Secrets)
    volumes:
      - services-data:/app/data
    ports:
      - "${SERVICES_PORT:-9002}:8000"
    networks:
      - cheapa-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 256M
    stop_grace_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.superdeploy.project=cheapa"
      - "com.superdeploy.service=services"
      - "com.superdeploy.release=${RELEASE_VERSION:-unknown}"
      - "com.superdeploy.git.sha=${GIT_SHA:-unknown}"
      - "com.superdeploy.deployed.at=${DEPLOY_TIMESTAMP:-unknown}"
