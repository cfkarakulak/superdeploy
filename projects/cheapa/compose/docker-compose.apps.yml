version: '3.8'

networks:
  cheapa-network:
    name: cheapa-network
    external: true

services:
  api:
    image: ${DOCKER_REGISTRY:-docker.io}/${DOCKER_ORG}/${IMAGE_NAME:-api}:${API_IMAGE_TAG:-latest}
    container_name: cheapa-api
    restart: unless-stopped
    networks:
      - cheapa-network
    ports:
      - "8000:8000"
    environment:
      POSTGRES_HOST: cheapa-postgres
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_PORT: 5432
      
      RABBITMQ_HOST: cheapa-rabbitmq
      RABBITMQ_USER: ${RABBITMQ_USER}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_PORT: 5672
      
      REDIS_HOST: cheapa-redis
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_PORT: 6379
      
      API_SECRET_KEY: ${API_SECRET_KEY}
      API_DEBUG: ${API_DEBUG:-false}
      API_BASE_URL: ${API_BASE_URL}
      PUBLIC_URL: ${PUBLIC_URL}
      
      SENTRY_DSN: ${SENTRY_DSN:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.superdeploy.project=cheapa"
      - "com.superdeploy.service=api"
      - "com.superdeploy.release=${RELEASE_VERSION:-unknown}"
      - "com.superdeploy.git.sha=${GIT_SHA:-unknown}"
      - "com.superdeploy.deployed.at=${DEPLOY_TIMESTAMP:-unknown}"

  dashboard:
    image: ${DOCKER_REGISTRY:-docker.io}/${DOCKER_ORG}/dashboard:${DASHBOARD_IMAGE_TAG:-latest}
    container_name: cheapa-dashboard
    restart: unless-stopped
    networks:
      - cheapa-network
    ports:
      - "3000:3000"
    environment:
      API_BASE_URL: ${API_BASE_URL}
      PUBLIC_URL: ${PUBLIC_URL}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.superdeploy.project=cheapa"
      - "com.superdeploy.service=dashboard"
      - "com.superdeploy.release=${RELEASE_VERSION:-unknown}"

  services:
    image: ${DOCKER_REGISTRY:-docker.io}/${DOCKER_ORG}/services:${SERVICES_IMAGE_TAG:-latest}
    container_name: cheapa-services
    restart: unless-stopped
    networks:
      - cheapa-network
    environment:
      POSTGRES_HOST: cheapa-postgres
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      
      RABBITMQ_HOST: cheapa-rabbitmq
      RABBITMQ_USER: ${RABBITMQ_USER}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      
      REDIS_HOST: cheapa-redis
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    labels:
      - "com.superdeploy.project=cheapa"
      - "com.superdeploy.service=services"
      - "com.superdeploy.release=${RELEASE_VERSION:-unknown}"
