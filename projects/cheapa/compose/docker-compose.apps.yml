version: '3.8'

# ═══════════════════════════════════════════════════════════════════════════
# CHEAPA PROJECT - APPLICATION SERVICES
# ═══════════════════════════════════════════════════════════════════════════
# Connects to shared infrastructure via 'infrastructure' network
# Isolated within 'cheapa-network' for app-to-app communication
# ═══════════════════════════════════════════════════════════════════════════

networks:
  # Shared infrastructure network (external)
  infrastructure:
    external: true
    name: superdeploy-infrastructure
  
  # Project-specific network (isolated)
  cheapa-network:
    name: cheapa-network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.10.0.0/24
          gateway: 10.10.0.1

volumes:
  api-data:
    name: cheapa-api-data

services:
  # ═══════════════════════════════════════════════════════════════════════════
  # API Service
  # ═══════════════════════════════════════════════════════════════════════════
  api:
    image: ${DOCKER_REGISTRY}/${DOCKER_ORG}/api:${API_IMAGE_TAG:-latest}
    container_name: cheapa-api
    restart: unless-stopped
    environment:
      # Database (shared PostgreSQL)
      POSTGRES_HOST: superdeploy-postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: cheapa_user
      POSTGRES_PASSWORD: ${CHEAPA_POSTGRES_PASSWORD:?required}
      POSTGRES_DB: cheapa_db
      
      # Queue (shared RabbitMQ)
      RABBITMQ_HOST: superdeploy-rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: cheapa_user
      RABBITMQ_PASSWORD: ${CHEAPA_RABBITMQ_PASSWORD:?required}
      RABBITMQ_VHOST: cheapa
      
      # Cache (shared Redis)
      REDIS_HOST: superdeploy-redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:?required}
      
      # App config
      API_SECRET_KEY: ${API_SECRET_KEY:?required}
      API_DEBUG: "false"
    volumes:
      - api-data:/app/data
    networks:
      - infrastructure  # Access to shared services
      - cheapa-network  # Isolated app network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 256M
    stop_grace_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.superdeploy.project=cheapa"
      - "com.superdeploy.service=api"
      - "com.superdeploy.release=${RELEASE_VERSION:-unknown}"
      - "com.superdeploy.git.sha=${GIT_SHA:-unknown}"
      - "com.superdeploy.deployed.at=${DEPLOY_TIMESTAMP:-unknown}"

  # ═══════════════════════════════════════════════════════════════════════════
  # Dashboard Service
  # ═══════════════════════════════════════════════════════════════════════════
  dashboard:
    image: ${DOCKER_REGISTRY}/${DOCKER_ORG}/dashboard:${DASHBOARD_IMAGE_TAG:-latest}
    container_name: cheapa-dashboard
    restart: unless-stopped
    environment:
      API_BASE_URL: http://cheapa-api:8000
      PUBLIC_URL: ${PUBLIC_URL}
    networks:
      - cheapa-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.25'
        reservations:
          memory: 128M
    stop_grace_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.superdeploy.project=cheapa"
      - "com.superdeploy.service=dashboard"
      - "com.superdeploy.release=${RELEASE_VERSION:-unknown}"
      - "com.superdeploy.git.sha=${GIT_SHA:-unknown}"
      - "com.superdeploy.deployed.at=${DEPLOY_TIMESTAMP:-unknown}"

  # ═══════════════════════════════════════════════════════════════════════════
  # Background Services (Workers)
  # ═══════════════════════════════════════════════════════════════════════════
  services:
    image: ${DOCKER_REGISTRY}/${DOCKER_ORG}/services:${SERVICES_IMAGE_TAG:-latest}
    container_name: cheapa-services
    restart: unless-stopped
    environment:
      # Database
      POSTGRES_HOST: superdeploy-postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: cheapa_user
      POSTGRES_PASSWORD: ${CHEAPA_POSTGRES_PASSWORD:?required}
      POSTGRES_DB: cheapa_db
      
      # Queue
      RABBITMQ_HOST: superdeploy-rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: cheapa_user
      RABBITMQ_PASSWORD: ${CHEAPA_RABBITMQ_PASSWORD:?required}
      RABBITMQ_VHOST: cheapa
      
      # Cache
      REDIS_HOST: superdeploy-redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:?required}
    networks:
      - infrastructure
      - cheapa-network
    healthcheck:
      test: ["CMD", "ps", "aux", "|", "grep", "celery"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 256M
    stop_grace_period: 60s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.superdeploy.project=cheapa"
      - "com.superdeploy.service=services"
      - "com.superdeploy.release=${RELEASE_VERSION:-unknown}"
      - "com.superdeploy.git.sha=${GIT_SHA:-unknown}"
      - "com.superdeploy.deployed.at=${DEPLOY_TIMESTAMP:-unknown}"
