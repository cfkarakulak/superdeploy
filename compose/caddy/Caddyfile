# Caddy Configuration - Auto HTTPS with Let's Encrypt
# Environment variables: DOMAIN_API, DOMAIN_FORGEJO, DOMAIN_APP

# API Service
{$DOMAIN_API:api.yourdomain.com} {
    reverse_proxy api:8000 {
        # Health check
        health_uri /healthz
        health_interval 10s
        health_timeout 5s
    }
    
    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
    
    # Compression
    encode gzip zstd
    
    # Logging
    log {
        output file /var/log/caddy/api-access.log
        format json
    }
}

# Forgejo Git Server
{$DOMAIN_FORGEJO:forgejo.yourdomain.com} {
    reverse_proxy forgejo:3001
    
    # Security headers (less strict for git operations)
    header {
        Strict-Transport-Security "max-age=31536000"
        X-Content-Type-Options "nosniff"
        -Server
    }
    
    encode gzip
    
    log {
        output file /var/log/caddy/forgejo-access.log
        format json
    }
}

# Dashboard (Main App)
{$DOMAIN_APP:app.yourdomain.com} {
    reverse_proxy dashboard:3000
    
    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
        -Server
    }
    
    encode gzip zstd
    
    log {
        output file /var/log/caddy/app-access.log
        format json
    }
}

# Catch-all: redirect to main app
:80 {
    redir https://{$DOMAIN_APP:app.yourdomain.com}{uri} permanent
}

# Global options
{
    # Email for Let's Encrypt
    email {$ACME_EMAIL:admin@yourdomain.com}
    
    # Auto HTTPS
    auto_https on
    
    # TLS options
    servers {
        protocols h1 h2
    }
}

