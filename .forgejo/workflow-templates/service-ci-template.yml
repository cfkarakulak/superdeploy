# =============================================================================
# SERVICE CI/CD WORKFLOW TEMPLATE
# =============================================================================
# Copy this to your service repository: .forgejo/workflows/ci.yml
# Update: SERVICE_NAME, DEPLOY_WORKFLOW, IMAGE_TAG_INPUT

name: Build & Deploy {{ SERVICE_NAME }}

on:
  push:
    branches: [main, master]
  create:
    tags: ['v*']

env:
  REGISTRY: docker.io  # or ghcr.io, registry.cheapa.io, etc.
  ORG: cheapa
  SERVICE_NAME: api  # CHANGE THIS: api, dashboard, worker, etc.
  DEPLOY_WORKFLOW: deploy-core-v2.yml  # CHANGE THIS: which workflow to trigger
  IMAGE_TAG_INPUT: api_image_tag  # CHANGE THIS: workflow input name

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      # ========================================================================
      # 1. CHECKOUT CODE
      # ========================================================================
      - name: üì¶ Checkout code
        run: |
          rm -rf /tmp/build-${{ github.run_id }}
          mkdir -p /tmp/build-${{ github.run_id }}
          cd /tmp/build-${{ github.run_id }}
          git clone ${{ github.repository_url }} .
          git config --global --add safe.directory /tmp/build-${{ github.run_id }}
          echo "‚úÖ Code checked out"

      # ========================================================================
      # 2. GENERATE IMAGE TAG
      # ========================================================================
      - name: üè∑Ô∏è  Generate image tag
        id: tag
        run: |
          cd /tmp/build-${{ github.run_id }}
          
          # If push is a version tag, use it
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
            echo "üìå Version tag detected: $TAG"
          else
            # Otherwise use short commit SHA
            TAG=$(git rev-parse --short HEAD)
            echo "üìå Commit SHA tag: $TAG"
          fi
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          
          echo "‚úÖ Tag: $TAG"

      # ========================================================================
      # 3. BUILD DOCKER IMAGE
      # ========================================================================
      - name: üèóÔ∏è  Build Docker image
        run: |
          cd /tmp/build-${{ github.run_id }}
          
          IMAGE_NAME="${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.SERVICE_NAME }}"
          
          echo "üèóÔ∏è  Building image: ${IMAGE_NAME}:${{ env.IMAGE_TAG }}"
          
          docker build \
            -t ${IMAGE_NAME}:${{ env.IMAGE_TAG }} \
            -t ${IMAGE_NAME}:latest \
            --build-arg BUILD_DATE=$(date -Iseconds) \
            --build-arg VCS_REF=$(git rev-parse --short HEAD) \
            --build-arg VERSION=${{ env.IMAGE_TAG }} \
            .
          
          echo "‚úÖ Image built successfully"

      # ========================================================================
      # 4. RUN TESTS (Optional)
      # ========================================================================
      - name: üß™ Run tests
        run: |
          cd /tmp/build-${{ github.run_id }}
          
          # Uncomment and customize based on your service
          # docker run --rm ${IMAGE_NAME}:${{ env.IMAGE_TAG }} pytest
          # docker run --rm ${IMAGE_NAME}:${{ env.IMAGE_TAG }} npm test
          
          echo "‚úÖ Tests passed (or skipped)"

      # ========================================================================
      # 5. PUSH TO REGISTRY
      # ========================================================================
      - name: üì§ Push to registry
        run: |
          IMAGE_NAME="${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.SERVICE_NAME }}"
          
          # Login to registry (if credentials are provided)
          if [ -n "${{ secrets.DOCKER_USERNAME }}" ] && [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            echo "‚úÖ Logged in to registry"
          else
            echo "‚ö†Ô∏è  No registry credentials - skipping push (will use local image)"
            exit 0
          fi
          
          echo "üì§ Pushing images..."
          docker push ${IMAGE_NAME}:${{ env.IMAGE_TAG }}
          docker push ${IMAGE_NAME}:latest
          
          echo "‚úÖ Images pushed to registry"

      # ========================================================================
      # 6. TRIGGER DEPLOYMENT
      # ========================================================================
      - name: üöÄ Trigger deployment in superdeploy-app
        run: |
          # Forgejo API endpoint for workflow dispatch
          API_URL="http://${{ env.FORGEJO_HOST }}:3001/api/v1/repos/${{ env.FORGEJO_OWNER }}/superdeploy-app/actions/workflows/${{ env.DEPLOY_WORKFLOW }}/dispatches"
          
          echo "üöÄ Triggering deployment workflow..."
          echo "  Workflow: ${{ env.DEPLOY_WORKFLOW }}"
          echo "  Input: ${{ env.IMAGE_TAG_INPUT }}=${{ env.IMAGE_TAG }}"
          
          # Build JSON payload
          PAYLOAD=$(cat <<EOF
          {
            "ref": "master",
            "inputs": {
              "${{ env.IMAGE_TAG_INPUT }}": "${{ env.IMAGE_TAG }}"
            }
          }
          EOF
          )
          
          # Trigger workflow
          HTTP_CODE=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.FORGEJO_PAT }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            -w "%{http_code}" \
            -o /tmp/deploy-response.json \
            "$API_URL")
          
          if [ "$HTTP_CODE" -eq 204 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Deployment triggered successfully!"
          else
            echo "‚ùå Failed to trigger deployment (HTTP $HTTP_CODE)"
            cat /tmp/deploy-response.json
            exit 1
          fi
        env:
          FORGEJO_HOST: ${{ secrets.FORGEJO_HOST || '34.56.43.99' }}
          FORGEJO_OWNER: cradexco

      # ========================================================================
      # 7. CLEANUP
      # ========================================================================
      - name: üßπ Cleanup
        if: always()
        run: |
          # Remove build directory
          rm -rf /tmp/build-${{ github.run_id }}
          
          # Cleanup old images (keep last 3)
          docker image prune -f
          
          echo "‚úÖ Cleanup complete"

      # ========================================================================
      # 8. SUMMARY
      # ========================================================================
      - name: üìã Build summary
        run: |
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë              üéâ BUILD & DEPLOY COMPLETE! üéâ                ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "üì¶ Service:     ${{ env.SERVICE_NAME }}"
          echo "üè∑Ô∏è  Tag:        ${{ env.IMAGE_TAG }}"
          echo "üê≥ Image:       ${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "üöÄ Deployment:  Triggered"
          echo ""
          echo "üìä Monitor deployment:"
          echo "  http://${{ secrets.FORGEJO_HOST || '34.56.43.99' }}:3001/cradexco/superdeploy-app/actions"
          echo ""

