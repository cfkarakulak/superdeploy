name: Deploy CORE Services

on:
  workflow_dispatch:
    inputs:
      api_image_tag:
        description: 'API Docker Image Tag'
        required: false
        default: 'latest'
      dashboard_image_tag:
        description: 'Dashboard Docker Image Tag'
        required: false
        default: 'latest'
      services_image_tag:
        description: 'Services Docker Image Tag'
        required: false
        default: 'latest'

jobs:
  deploy:
    runs-on: [self-hosted, core, linux, docker]
    
    steps:
      - name: ðŸ“¦ Checkout superdeploy code
        run: |
          cd /opt/superdeploy
          git config --global --add safe.directory /opt/superdeploy
          git fetch origin
          git reset --hard origin/master
          echo "âœ… Superdeploy code updated"

      - name: ðŸ” Verify app .env files exist
        run: |
          if [ ! -f "/opt/app-repos/api/.env" ]; then
            echo "âŒ ERROR: /opt/app-repos/api/.env not found!"
            echo "App-specific .env files must be pushed by GitHub Actions"
            exit 1
          fi
          if [ ! -f "/opt/app-repos/dashboard/.env" ]; then
            echo "âŒ ERROR: /opt/app-repos/dashboard/.env not found!"
            exit 1
          fi
          if [ ! -f "/opt/app-repos/services/.env" ]; then
            echo "âŒ ERROR: /opt/app-repos/services/.env not found!"
            exit 1
          fi
          echo "âœ… All app .env files present"

      - name: ðŸ³ Create docker-compose.yml from app configs
        run: |
          mkdir -p /opt/superdeploy/compose
          
          # Load app environment variables
          set -a
          source /opt/app-repos/api/.env
          source /opt/app-repos/dashboard/.env
          source /opt/app-repos/services/.env
          set +a
          
          # Export Docker image tags
          export API_IMAGE_TAG="${{ github.event.inputs.api_image_tag }}"
          export DASHBOARD_IMAGE_TAG="${{ github.event.inputs.dashboard_image_tag }}"
          export SERVICES_IMAGE_TAG="${{ github.event.inputs.services_image_tag }}"
          
          cat > /opt/superdeploy/compose/docker-compose.yml <<'EOF'
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: superdeploy-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-superdeploy_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: superdeploy-rabbitmq
    restart: unless-stopped
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-superdeploy}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD:-SuperSecure123Pass}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 10s
      retries: 5

  api:
    image: ${DOCKER_REGISTRY:-docker.io}/${DOCKER_ORG}/api:${API_IMAGE_TAG:-latest}
    container_name: superdeploy-api
    restart: unless-stopped
    env_file:
      - /opt/app-repos/api/.env
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - app-network
    ports:
      - "8000:8000"

  dashboard:
    image: ${DOCKER_REGISTRY:-docker.io}/${DOCKER_ORG}/dashboard:${DASHBOARD_IMAGE_TAG:-latest}
    container_name: superdeploy-dashboard
    restart: unless-stopped
    env_file:
      - /opt/app-repos/dashboard/.env
    depends_on:
      - api
    networks:
      - app-network
    ports:
      - "80:3000"

  services:
    image: ${DOCKER_REGISTRY:-docker.io}/${DOCKER_ORG}/services:${SERVICES_IMAGE_TAG:-latest}
    container_name: superdeploy-services
    restart: unless-stopped
    env_file:
      - /opt/app-repos/services/.env
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  rabbitmq_data:
EOF
          
          echo "âœ… docker-compose.yml generated"

      - name: ðŸ³ Pull and deploy services
        run: |
          cd /opt/superdeploy/compose
          
          # Load infrastructure env (for DOCKER_ORG, etc.)
          set -a
          source /opt/superdeploy/.env
          set +a
          
          # Set image tags
          export API_IMAGE_TAG="${{ github.event.inputs.api_image_tag }}"
          export DASHBOARD_IMAGE_TAG="${{ github.event.inputs.dashboard_image_tag }}"
          export SERVICES_IMAGE_TAG="${{ github.event.inputs.services_image_tag }}"
          
          echo "Pulling images..."
          docker compose pull
          
          echo "Starting services..."
          docker compose up -d --remove-orphans
          
          echo "âœ… Services deployed!"

      - name: â³ Wait for services to be healthy
        run: |
          cd /opt/superdeploy/compose
          
          echo "Waiting for services to be healthy..."
          sleep 10
          
          docker compose ps
          echo "âœ… Services should be healthy!"

      - name: ðŸ“Š Show deployment status
        run: |
          cd /opt/superdeploy/compose
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "         ðŸŽ‰ DEPLOYMENT COMPLETE! ðŸŽ‰                    "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          docker compose ps
          echo ""
          echo "ðŸŒ Services are available at: http://$(curl -s ifconfig.me)"
