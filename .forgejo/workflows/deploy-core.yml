name: Deploy CORE Services

on:
  workflow_dispatch:
    inputs:
      api_image_tag:
        description: 'API image tag'
        required: false
        default: 'latest'
      dashboard_image_tag:
        description: 'Dashboard image tag'
        required: false
        default: 'latest'

env:
  COMPOSE_FILE: projects/cheapa/compose/docker-compose.yml
  ENV_FILE: projects/cheapa/.env

jobs:
  deploy-core:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout code
        run: |
          git config --global --add safe.directory /opt/superdeploy
          cd /opt/superdeploy
          git fetch origin
          git reset --hard origin/master
          echo "âœ… Code updated"

      - name: ğŸ” Load environment
        run: |
          cd /opt/superdeploy
          if [ ! -f "${{ env.ENV_FILE }}" ]; then
            echo "âŒ ERROR: ${{ env.ENV_FILE }} not found!"
            exit 1
          fi
          set -a
          source ${{ env.ENV_FILE }}
          set +a
          echo "âœ… Environment loaded"

      - name: ğŸ·ï¸ Update image tags
        run: |
          cd /opt/superdeploy
          
          # Update API tag if provided
          if [ "${{ github.event.inputs.api_image_tag }}" != "latest" ]; then
            echo "Updating API image tag to: ${{ github.event.inputs.api_image_tag }}"
            sed -i "s/^API_IMAGE_TAG=.*/API_IMAGE_TAG=${{ github.event.inputs.api_image_tag }}/" ${{ env.ENV_FILE }}
          fi
          
          # Update Dashboard tag if provided
          if [ "${{ github.event.inputs.dashboard_image_tag }}" != "latest" ]; then
            echo "Updating Dashboard image tag to: ${{ github.event.inputs.dashboard_image_tag }}"
            sed -i "s/^DASHBOARD_IMAGE_TAG=.*/DASHBOARD_IMAGE_TAG=${{ github.event.inputs.dashboard_image_tag }}/" ${{ env.ENV_FILE }}
          fi
          
          echo "âœ… Image tags updated"

      - name: ğŸ³ Pull latest images
        run: |
          cd /opt/superdeploy
          docker compose -f ${{ env.COMPOSE_FILE }} --env-file ${{ env.ENV_FILE }} pull
          echo "âœ… Images pulled"

      - name: ğŸš€ Deploy services
        run: |
          cd /opt/superdeploy
          docker compose -f ${{ env.COMPOSE_FILE }} --env-file ${{ env.ENV_FILE }} up -d
          echo "âœ… Services deployed"

      - name: â³ Wait for health checks
        run: |
          echo "Waiting 30 seconds for services to be healthy..."
          sleep 30

      - name: ğŸ” Verify deployment
        run: |
          cd /opt/superdeploy
          docker compose -f ${{ env.COMPOSE_FILE }} ps
          
          # Check if all services are running
          FAILED=$(docker compose -f ${{ env.COMPOSE_FILE }} ps --filter "status=exited" -q | wc -l)
          if [ "$FAILED" -gt 0 ]; then
            echo "âŒ Some services failed to start!"
            docker compose -f ${{ env.COMPOSE_FILE }} ps
            exit 1
          fi
          
          echo "âœ… All services running"

      - name: ğŸ§¹ Cleanup old images
        run: |
          echo "Cleaning up unused images..."
          docker image prune -f
          echo "âœ… Cleanup complete"

      - name: ğŸ“Š Deployment summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ğŸ‰ DEPLOYMENT COMPLETE! ğŸ‰                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Services deployed:"
          echo "  - API:        ${{ github.event.inputs.api_image_tag }}"
          echo "  - Dashboard:  ${{ github.event.inputs.dashboard_image_tag }}"
          echo ""
          echo "ğŸ”— Access:"
          echo "  - API:       http://\$CORE_EXTERNAL_IP:8000"
          echo "  - Dashboard: http://\$CORE_EXTERNAL_IP:8001"

