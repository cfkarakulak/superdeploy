name: Deploy CORE Services

on:
  workflow_dispatch:
    inputs:
      api_image_tag:
        description: 'API Docker Image Tag'
        required: false
        default: 'latest'
      dashboard_image_tag:
        description: 'Dashboard Docker Image Tag'
        required: false
        default: 'latest'
      services_image_tag:
        description: 'Services Docker Image Tag'
        required: false
        default: 'latest'

jobs:
  deploy:
    runs-on: [self-hosted, core, linux, docker]
    
    steps:
      - name: ğŸ“¦ Checkout superdeploy code
        run: |
          cd /opt/superdeploy
          git config --global --add safe.directory /opt/superdeploy
          git fetch origin
          git reset --hard origin/master
          echo "âœ… Superdeploy code updated"

      - name: ğŸ” Verify app .env files exist
        run: |
          if [ ! -f "/opt/app-repos/api/.env" ]; then
            echo "âŒ ERROR: /opt/app-repos/api/.env not found!"
            echo "App-specific .env files must be pushed by GitHub Actions"
            exit 1
          fi
          if [ ! -f "/opt/app-repos/dashboard/.env" ]; then
            echo "âŒ ERROR: /opt/app-repos/dashboard/.env not found!"
            exit 1
          fi
          if [ ! -f "/opt/app-repos/services/.env" ]; then
            echo "âŒ ERROR: /opt/app-repos/services/.env not found!"
            exit 1
          fi
          echo "âœ… All app .env files present"

      - name: ğŸ³ Prepare docker-compose.yml
        run: |
          # Copy template to compose directory
          mkdir -p /opt/superdeploy/compose
          cp /opt/superdeploy/compose/docker-compose.yml.template /opt/superdeploy/compose/docker-compose.yml
          
          echo "âœ… docker-compose.yml ready"

      - name: ğŸ³ Pull and deploy services
        run: |
          cd /opt/superdeploy/compose
          
          # Load infrastructure env (for DOCKER_ORG, etc.)
          set -a
          source /opt/superdeploy/.env
          set +a
          
          # Set image tags
          export API_IMAGE_TAG="${{ github.event.inputs.api_image_tag }}"
          export DASHBOARD_IMAGE_TAG="${{ github.event.inputs.dashboard_image_tag }}"
          export SERVICES_IMAGE_TAG="${{ github.event.inputs.services_image_tag }}"
          
          echo "Pulling images..."
          docker compose pull
          
          echo "Starting services..."
          docker compose up -d --remove-orphans
          
          echo "âœ… Services deployed!"

      - name: â³ Wait for services to be healthy
        run: |
          cd /opt/superdeploy/compose
          
          echo "Waiting for services to be healthy..."
          sleep 10
          
          docker compose ps
          echo "âœ… Services should be healthy!"

      - name: ğŸ“Š Show deployment status
        run: |
          cd /opt/superdeploy/compose
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "         ğŸ‰ DEPLOYMENT COMPLETE! ğŸ‰                    "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          docker compose ps
          echo ""
          echo "ğŸŒ Services are available at: http://$(curl -s ifconfig.me)"
