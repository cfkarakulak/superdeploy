name: Deploy Cheapa Storefront

on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Docker image with tag'
        required: true
        type: string
      env_bundle:
        description: 'AGE-encrypted environment variables bundle (base64 encoded)'
        required: true
        type: string
      git_sha:
        description: 'Git commit SHA'
        required: true
        type: string
      git_ref:
        description: 'Git ref (branch/tag)'
        required: false
        default: 'production'
        type: string

jobs:
  deploy:
    runs-on: [self-hosted, cheapa, app]
    
    steps:
      - name: Check age installation
        run: |
          if command -v age &> /dev/null; then
            echo "âœ… age already installed ($(age --version))"
          else
            echo "ğŸ“¥ Installing age..."
            curl -sL https://github.com/FiloSottile/age/releases/download/v1.1.1/age-v1.1.1-linux-amd64.tar.gz | tar xz
            sudo mv age/age /usr/local/bin/
            rm -rf age
            echo "âœ… age installed ($(age --version))"
          fi
      
      - name: Decode env bundle
        run: |
          echo "ğŸ“¦ Decoding environment bundle..."
          echo "${{ inputs.env_bundle }}" | base64 -d > /tmp/encrypted.age
          SIZE=$(wc -c < /tmp/encrypted.age)
          echo "âœ… Decoded: $SIZE bytes"
      
      - name: Decrypt with AGE
        env:
          AGE_SECRET_KEY: ${{ secrets.AGE_SECRET_KEY }}
        run: |
          echo "ğŸ” Decrypting with AGE..."
          
          if [ -z "$AGE_SECRET_KEY" ]; then
            echo "âŒ AGE_SECRET_KEY not set!"
            exit 1
          fi
          
          printf '%s' "$AGE_SECRET_KEY" > /tmp/age-key.txt
          chmod 600 /tmp/age-key.txt
          
          if ! age -d -i /tmp/age-key.txt /tmp/encrypted.age > /tmp/decrypted.env 2>&1; then
            echo "âŒ Decryption failed!"
            cat /tmp/decrypted.env || true
            rm -f /tmp/age-key.txt /tmp/encrypted.age /tmp/decrypted.env
            exit 1
          fi
          
          rm -f /tmp/age-key.txt /tmp/encrypted.age
          
          if [ ! -s /tmp/decrypted.env ]; then
            echo "âŒ Decrypted file is empty!"
            exit 1
          fi
          
          SIZE=$(wc -c < /tmp/decrypted.env)
          echo "âœ… Decrypted: $SIZE bytes"
      
      - name: Login to Docker Hub
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
        run: |
          echo "ğŸ”‘ Logging in to Docker Hub..."
          echo "$DOCKER_TOKEN" | docker login -u "$DOCKER_USERNAME" --password-stdin
          echo "âœ… Logged in"
      
      - name: Pull Docker image
        run: |
          echo "ğŸ“¥ Pulling: ${{ inputs.image }}"
          docker pull ${{ inputs.image }}
          echo "âœ… Image pulled"
      
      - name: Generate Docker Compose file
        run: |
          echo "ğŸ“ Generating docker-compose.yml..."
          
          PROJECT="cheapa"
          SERVICE="storefront"
          IMAGE="${{ inputs.image }}"
          PORT="3000"
          GIT_SHA="${{ inputs.git_sha }}"
          
          sudo mkdir -p /opt/apps/$PROJECT/compose
          
          cat > /tmp/docker-compose-$SERVICE.yml << 'DOCKERCOMPOSEEOF'
          services:
            SERVICE_PLACEHOLDER:
              image: IMAGE_PLACEHOLDER
              container_name: CONTAINER_PLACEHOLDER
              restart: unless-stopped
              env_file:
                - /tmp/decrypted.env
              networks:
                - NETWORK_PLACEHOLDER
              ports:
                - "PORT_PLACEHOLDER:PORT_PLACEHOLDER"
              labels:
                - "project=PROJECT_PLACEHOLDER"
                - "service=SERVICE_PLACEHOLDER"
                - "git.sha=GIT_SHA_PLACEHOLDER"
          
          networks:
            NETWORK_PLACEHOLDER:
              name: NETWORK_PLACEHOLDER
              external: true
          DOCKERCOMPOSEEOF
          
          # Replace placeholders
          sed -i "s/SERVICE_PLACEHOLDER/$SERVICE/g" /tmp/docker-compose-$SERVICE.yml
          sed -i "s/PROJECT_PLACEHOLDER/$PROJECT/g" /tmp/docker-compose-$SERVICE.yml
          sed -i "s|IMAGE_PLACEHOLDER|$IMAGE|g" /tmp/docker-compose-$SERVICE.yml
          sed -i "s/CONTAINER_PLACEHOLDER/$PROJECT-$SERVICE/g" /tmp/docker-compose-$SERVICE.yml
          sed -i "s/NETWORK_PLACEHOLDER/$PROJECT-network/g" /tmp/docker-compose-$SERVICE.yml
          sed -i "s/PORT_PLACEHOLDER/$PORT/g" /tmp/docker-compose-$SERVICE.yml
          sed -i "s/GIT_SHA_PLACEHOLDER/$GIT_SHA/g" /tmp/docker-compose-$SERVICE.yml
          
          sudo mv /tmp/docker-compose-$SERVICE.yml /opt/apps/$PROJECT/compose/
          echo "âœ… Compose file created"
      
      - name: Stop old container (if exists)
        run: |
          echo "ğŸ›‘ Stopping old container..."
          cd /opt/apps/cheapa/compose
          docker compose -f docker-compose-storefront.yml down --remove-orphans 2>/dev/null || true
          echo "âœ… Old container stopped"
      
      - name: Deploy container
        run: |
          echo "ğŸš€ Deploying storefront..."
          
          cd /opt/apps/cheapa/compose
          docker compose -f docker-compose-storefront.yml up -d
          
          echo "âœ… Deployed successfully!"
      
      - name: Show container status
        run: |
          echo "ğŸ“Š Container status:"
          docker ps --filter "name=cheapa-storefront" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
      
      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/decrypted.env /tmp/encrypted.age /tmp/age-key.txt
          echo "ğŸ§¹ Cleanup complete"
