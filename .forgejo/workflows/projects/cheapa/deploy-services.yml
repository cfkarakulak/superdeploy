name: Deploy Cheapa Services

on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Docker image with tag'
        required: true
        type: string
      env_bundle:
        description: 'AGE-encrypted environment variables bundle'
        required: true
        type: string
      git_sha:
        description: 'Git commit SHA'
        required: true
        type: string
      git_ref:
        description: 'Git ref (branch/tag)'
        required: false
        default: 'production'
        type: string

jobs:
  deploy:
    runs-on: [self-hosted, cheapa, app]
    steps:
      - name: Checkout superdeploy repo
        uses: actions/checkout@v4
        with:
          repository: cradexco/superdeploy
          ref: master
      
      - name: Deploy to VM
        uses: ./.forgejo/actions/deploy
        with:
          project: cheapa
          service: services
          image: ${{ inputs.image }}
          env_bundle: ${{ inputs.env_bundle }}
          git_sha: ${{ inputs.git_sha }}
          git_ref: ${{ inputs.git_ref }}
        env:
          AGE_SECRET_KEY: ${{ secrets.AGE_SECRET_KEY }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
