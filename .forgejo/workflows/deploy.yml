# =============================================================================
# SuperDeploy - Central Deployment Workflow (Forgejo)
# =============================================================================
# Triggered by GitHub Actions via workflow_dispatch API
# Routes deployment to correct project VM runner
# =============================================================================

name: Deploy Application to VM

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project name (e.g., cheapa)'
        required: true
        type: string
      app:
        description: 'App name (e.g., api, storefront)'
        required: true
        type: string
      vm_role:
        description: 'VM role (e.g., app, core)'
        required: true
        type: string
      image:
        description: 'Docker image (e.g., c100394/api:latest)'
        required: true
        type: string
      git_sha:
        description: 'Git commit SHA'
        required: true
        type: string

jobs:
  deploy:
    # Route to project-specific VM runner based on labels
    # Labels format: [self-hosted, {project}, {vm_role}]
    runs-on: 
      - self-hosted
      - ${{ inputs.project }}
      - ${{ inputs.vm_role }}
    
    steps:
      - name: Display deployment info
        run: |
          echo "ğŸš€ Deploying application..."
          echo "  Project: ${{ inputs.project }}"
          echo "  App: ${{ inputs.app }}"
          echo "  VM Role: ${{ inputs.vm_role }}"
          echo "  Image: ${{ inputs.image }}"
          echo "  Git SHA: ${{ inputs.git_sha }}"
          echo ""
      
      - name: Pull latest image
        run: |
          cd /opt/superdeploy/projects/${{ inputs.project }}/compose
          docker compose pull ${{ inputs.app }}
      
      - name: Restart container
        run: |
          cd /opt/superdeploy/projects/${{ inputs.project }}/compose
          docker compose up -d ${{ inputs.app }}
      
      - name: Wait for health check
        run: |
          echo "â³ Waiting for container to be healthy..."
          sleep 5
          
          # Check container status
          STATUS=$(docker inspect -f '{{.State.Status}}' ${{ inputs.project }}-${{ inputs.app }} 2>/dev/null || echo "not_found")
          
          if [ "$STATUS" = "running" ]; then
            echo "âœ… Container is running!"
          else
            echo "âŒ Container failed to start (status: $STATUS)"
            docker logs ${{ inputs.project }}-${{ inputs.app }} --tail 50
            exit 1
          fi
      
      - name: Cleanup old images
        run: |
          docker image prune -f
          echo "ğŸ§¹ Cleanup complete"
      
      - name: Deployment summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment successful!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Project: ${{ inputs.project }}"
          echo "  App: ${{ inputs.app }}"
          echo "  Image: ${{ inputs.image }}"
          echo "  SHA: ${{ inputs.git_sha }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

