# =============================================================================
# SuperDeploy - Central Deployment Workflow (Forgejo)
# =============================================================================
# Triggered by GitHub Actions via workflow_dispatch API
# Routes deployment to correct project VM runner
# =============================================================================

name: Deploy Application to VM

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project name (e.g., cheapa)'
        required: true
        type: string
      app:
        description: 'App name (e.g., api, storefront)'
        required: true
        type: string
      vm_role:
        description: 'VM role (e.g., app, core)'
        required: true
        type: string
      image:
        description: 'Docker image (e.g., c100394/api:latest)'
        required: true
        type: string
      git_sha:
        description: 'Git commit SHA'
        required: true
        type: string

jobs:
  # Forgejo 13.0.1 limitation: inputs work in 'if' but not in 'runs-on'
  # Workaround: Separate job per project with conditional execution
  
  deploy-cheapa:
    if: ${{ inputs.project == 'cheapa' }}
    runs-on: 
      - self-hosted
      - cheapa
      - app
    
    env:
      PROJECT: ${{ inputs.project }}
      APP: ${{ inputs.app }}
      VM_ROLE: ${{ inputs.vm_role }}
      IMAGE: ${{ inputs.image }}
      GIT_SHA: ${{ inputs.git_sha }}
    
    steps:
      - name: Display deployment info
        run: |
          echo "ğŸš€ Deploying application..."
          echo "  Project: $PROJECT"
          echo "  App: $APP"
          echo "  VM Role: $VM_ROLE"
          echo "  Image: $IMAGE"
          echo "  Git SHA: $GIT_SHA"
          echo ""
      
      - name: Pull latest image
        run: |
          cd /opt/superdeploy/projects/$PROJECT/compose
          docker compose pull $APP
      
      - name: Restart container
        run: |
          cd /opt/superdeploy/projects/$PROJECT/compose
          docker compose up -d $APP
      
      - name: Wait for health check
        run: |
          echo "â³ Waiting for container to be healthy..."
          sleep 5
          
          # Check container status (docker-compose uses underscore in names)
          CONTAINER_NAME="${PROJECT}_${APP}"
          STATUS=$(docker inspect -f '{{.State.Status}}' $CONTAINER_NAME 2>/dev/null || echo "not_found")
          
          if [ "$STATUS" = "running" ]; then
            echo "âœ… Container is running!"
          else
            echo "âŒ Container failed to start (status: $STATUS)"
            docker logs $CONTAINER_NAME --tail 50
            exit 1
          fi
      
      - name: Cleanup old images
        run: |
          docker image prune -f
          echo "ğŸ§¹ Cleanup complete"
      
      - name: Deployment summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment successful!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Project: $PROJECT"
          echo "  App: $APP"
          echo "  Image: $IMAGE"
          echo "  SHA: $GIT_SHA"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

  # Add more projects here as needed:
  # deploy-myapp:
  #   if: ${{ inputs.project == 'myapp' }}
  #   runs-on: [self-hosted, myapp, app]
  #   ... (same steps)
  
  deploy-other:
    # Fallback for unknown projects - will fail with clear error
    if: ${{ inputs.project != 'cheapa' }}
    runs-on: 
      - self-hosted
      - cheapa
      - app
    
    env:
      PROJECT: ${{ inputs.project }}
      APP: ${{ inputs.app }}
    
    steps:
      - name: Unsupported project error
        run: |
          echo "âŒ ERROR: Project '$PROJECT' is not configured!"
          echo ""
          echo "Supported projects:"
          echo "  - cheapa"
          echo ""
          echo "To add support for '$PROJECT':"
          echo "  1. Add a 'deploy-$PROJECT' job in .forgejo/workflows/deploy.yml"
          echo "  2. Set runs-on: [self-hosted, $PROJECT, app]"
          echo "  3. Copy steps from deploy-cheapa job"
          echo ""
          exit 1

