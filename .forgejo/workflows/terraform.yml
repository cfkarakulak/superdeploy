name: ğŸ—ï¸ Terraform Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'infra/**'
  pull_request:
    paths:
      - 'infra/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

jobs:
  terraform:
    runs-on: self-hosted
    defaults:
      run:
        working-directory: infra
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        run: |
          if ! command -v terraform &> /dev/null; then
            echo "ğŸ“¥ Installing Terraform..."
            wget -q https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip
            unzip -q terraform_1.6.6_linux_amd64.zip
            sudo mv terraform /usr/local/bin/
            rm terraform_1.6.6_linux_amd64.zip
          fi
          terraform version

      - name: âœ… Terraform Format Check
        run: terraform fmt -check -recursive || true

      - name: ğŸ”„ Terraform Init
        run: terraform init -upgrade

      - name: âœ… Terraform Validate
        run: terraform validate

      - name: ğŸ“‹ Terraform Plan
        if: github.event_name == 'pull_request' || github.event.inputs.action == 'plan'
        run: |
          terraform plan \
            -var-file=envs/dev/gcp.auto.tfvars \
            -out=tfplan
          terraform show tfplan

      - name: ğŸš€ Terraform Apply
        if: github.event.inputs.action == 'apply' && github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸš€ Applying Terraform changes..."
          terraform apply \
            -var-file=envs/dev/gcp.auto.tfvars \
            -auto-approve

      - name: ğŸ’¥ Terraform Destroy
        if: github.event.inputs.action == 'destroy' && github.event_name == 'workflow_dispatch'
        run: |
          echo "âš ï¸  DESTROYING INFRASTRUCTURE âš ï¸"
          terraform destroy \
            -var-file=envs/dev/gcp.auto.tfvars \
            -auto-approve

      - name: ğŸ“Š Show Terraform Outputs
        if: github.event.inputs.action == 'apply' && github.event_name == 'workflow_dispatch'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“Š Terraform Outputs                                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          terraform output -json | jq '.'
          echo ""
          echo "ğŸ’¡ Update Forgejo Variables with these IPs:"
          echo "  CORE_EXTERNAL_IP=$(terraform output -raw vm_core_public_ips | jq -r '.[0]')"
          echo "  CORE_INTERNAL_IP=$(terraform output -raw vm_core_internal_ips | jq -r '.[0]')"
          echo "  SCRAPE_EXTERNAL_IP=$(terraform output -raw vm_scrape_public_ips | jq -r '.[0]')"
          echo "  SCRAPE_INTERNAL_IP=$(terraform output -raw vm_scrape_internal_ips | jq -r '.[0]')"
          echo "  PROXY_EXTERNAL_IP=$(terraform output -raw vm_proxy_public_ips | jq -r '.[0]')"
          echo "  PROXY_INTERNAL_IP=$(terraform output -raw vm_proxy_internal_ips | jq -r '.[0]')"

      - name: ğŸ“ Upload plan artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v3
        with:
          name: terraform-plan
          path: infra/tfplan
          retention-days: 7

