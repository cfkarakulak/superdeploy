name: 'Deploy Service'
description: 'Deploy a service to VM using Docker Compose'
author: 'Superdeploy Team'

inputs:
  project:
    description: 'Project name (e.g., cheapa)'
    required: true
  service:
    description: 'Service name (e.g., api, dashboard, services)'
    required: true
  image:
    description: 'Docker image with tag'
    required: true
  env_bundle:
    description: 'AGE-encrypted environment variables bundle (base64)'
    required: true
  git_sha:
    description: 'Git commit SHA'
    required: true
  git_ref:
    description: 'Git ref (branch/tag)'
    required: true
    default: 'production'

runs:
  using: 'composite'
  steps:
    - name: Setup age tool
      shell: bash
      run: |
        if ! command -v age &> /dev/null; then
          echo "ï¿½ Inystalling age..."
          curl -sL https://github.com/FiloSottile/age/releases/download/v1.1.1/age-v1.1.1-linux-amd64.tar.gz | tar xz
          chmod +x age/age
          export PATH="$PWD/age:$PATH"
          echo "$PWD/age" >> $GITHUB_PATH
        fi
        age --version
    
    - name: Decrypt environment bundle
      shell: bash
      run: |
        set -ex
        echo "ðŸ” Decrypting environment bundle..."
        echo "${{ inputs.env_bundle }}" | base64 -d > /tmp/encrypted.age
        echo "âœ… Base64 decoded successfully"
        
        echo "$AGE_SECRET_KEY" > /tmp/age-key.txt
        age -d -i /tmp/age-key.txt /tmp/encrypted.age > /tmp/decrypted.env
        rm /tmp/age-key.txt
        echo "âœ… AGE decryption successful"
        
        echo "ðŸ“‹ Decrypted env file contents (first 5 lines, masked):"
        head -5 /tmp/decrypted.env | sed 's/=.*/=***MASKED***/g'
        
        rm /tmp/encrypted.age
        echo "âœ… Decrypt step completed"
    
    - name: Load environment variables
      shell: bash
      run: |
        set -ex
        echo "ðŸ“¥ Loading environment variables..."
        
        if [ ! -f /tmp/decrypted.env ] || [ ! -s /tmp/decrypted.env ]; then
          echo "âŒ Decrypted env file not found or empty!"
          exit 1
        fi
        
        set -a
        source /tmp/decrypted.env
        set +a
        
        echo "âœ… Environment sourced successfully"
        
        # Save to GitHub env for next steps
        grep -v '^#' /tmp/decrypted.env | grep -v '^$' >> $GITHUB_ENV
        
        echo "ðŸ“Š Total env vars loaded: $(grep -v '^#' /tmp/decrypted.env | grep -v '^$' | wc -l)"
        echo "âœ… Load env step completed"
    
    - name: Login to Docker Hub
      shell: bash
      run: |
        set -ex
        echo "ðŸ³ Logging in to Docker Hub..."
        
        if [ -z "$DOCKER_USERNAME" ] || [ -z "$DOCKER_TOKEN" ]; then
          echo "âŒ Docker Hub credentials not found!"
          exit 1
        fi
        
        echo "$DOCKER_TOKEN" | docker login docker.io -u "$DOCKER_USERNAME" --password-stdin
        
        if [ $? -eq 0 ]; then
          echo "âœ… Docker Hub login successful"
        else
          echo "âŒ Docker Hub login failed!"
          exit 1
        fi
    
    - name: Load project configuration
      shell: bash
      run: |
        set -ex
        echo "ðŸ“‹ Loading project configuration..."
        
        CONFIG_FILE="/tmp/project.yml"
        HOSTNAME=$(hostname)
        echo "ðŸ” Running in container: $HOSTNAME"
        
        docker run --rm -v /opt/superdeploy/projects/${{ inputs.project }}:/project:ro alpine cat /project/project.yml > "$CONFIG_FILE" || {
          echo "âŒ ERROR: Cannot access project.yml from host"
          echo "Tried to mount: /opt/superdeploy/projects/${{ inputs.project }}/project.yml"
          exit 1
        }
        
        echo "âœ… Successfully loaded project.yml from host"
        
        if [ -f "$CONFIG_FILE" ]; then
          PARSER_SCRIPT="${GITHUB_WORKSPACE}/.forgejo/scripts/parse_config.py"
          
          if [ -f "$PARSER_SCRIPT" ]; then
            echo "âœ… Parser script found"
            CONFIG_OUTPUT=$(python3 "$PARSER_SCRIPT" "$CONFIG_FILE" "${{ inputs.service }}" 2>&1)
            
            read EXTERNAL_PORT INTERNAL_PORT VM_NAME <<< "$CONFIG_OUTPUT"
            
            if [ -z "$EXTERNAL_PORT" ] || [ -z "$INTERNAL_PORT" ]; then
              echo "âŒ ERROR: Failed to parse ports from project.yml!"
              exit 1
            fi
            
            echo "external_port=${EXTERNAL_PORT}" >> $GITHUB_OUTPUT
            echo "internal_port=${INTERNAL_PORT}" >> $GITHUB_OUTPUT
            echo "âœ… Loaded ports from project.yml: ${EXTERNAL_PORT}:${INTERNAL_PORT}"
          else
            echo "âŒ ERROR: Parser script not found at: $PARSER_SCRIPT"
            exit 1
          fi
        else
          echo "âŒ ERROR: Project file not found at: $CONFIG_FILE"
          exit 1
        fi
    
    - name: Generate docker-compose for service
      shell: bash
      run: |
        set -e
        
        mkdir -p /opt/apps/${{ inputs.project }}/compose
        
        if [ ! -d "/opt/apps/${{ inputs.project }}/compose" ]; then
          echo "âŒ Failed to create compose directory"
          exit 1
        fi
        
        EXTERNAL_PORT="${EXTERNAL_PORT}"
        INTERNAL_PORT="${INTERNAL_PORT}"
        
        echo "ðŸ”§ Generating compose with ports: ${EXTERNAL_PORT}:${INTERNAL_PORT}"
        
        EXPOSE_PORTS="true"
        
        cat > /opt/apps/${{ inputs.project }}/compose/docker-compose-${{ inputs.service }}.yml <<'EOF'
        version: '3.8'
        
        networks:
          PROJECT_NETWORK:
            external: true
          superdeploy-proxy:
            external: true
        
        services:
          SERVICE_NAME:
            image: IMAGE_PLACEHOLDER
            container_name: CONTAINER_NAME
            restart: unless-stopped
            networks:
              - PROJECT_NETWORK
              - superdeploy-proxy
            PORTS_PLACEHOLDER
            env_file:
              - /tmp/decrypted.env
            labels:
              com.superdeploy.project: "PROJECT_PLACEHOLDER"
              com.superdeploy.service: "SERVICE_PLACEHOLDER"
              com.superdeploy.git.sha: "GIT_SHA_PLACEHOLDER"
              com.superdeploy.git.ref: "GIT_REF_PLACEHOLDER"
            healthcheck:
              test: ["CMD", "curl", "-f", "http://localhost:{{INTERNAL_PORT}}/"]
              interval: 15s
              timeout: 10s
              retries: 5
              start_period: 60s
        EOF
        
        COMPOSE_FILE="/opt/apps/${{ inputs.project }}/compose/docker-compose-${{ inputs.service }}.yml"
        
        if [ "$EXPOSE_PORTS" == "true" ]; then
          sed -i 's#PORTS_PLACEHOLDER#ports:\n        - "'"${EXTERNAL_PORT}:${INTERNAL_PORT}"'"#g' "$COMPOSE_FILE"
        else
          sed -i "s#PORTS_PLACEHOLDER##g" "$COMPOSE_FILE"
        fi
        
        sed -i "s#PROJECT_NETWORK#${{ inputs.project }}-network#g" "$COMPOSE_FILE"
        sed -i "s#SERVICE_NAME#${{ inputs.project }}-${{ inputs.service }}#g" "$COMPOSE_FILE"
        sed -i "s#CONTAINER_NAME#${{ inputs.project }}-${{ inputs.service }}#g" "$COMPOSE_FILE"
        sed -i "s#IMAGE_PLACEHOLDER#${{ inputs.image }}#g" "$COMPOSE_FILE"
        sed -i "s#PROJECT_PLACEHOLDER#${{ inputs.project }}#g" "$COMPOSE_FILE"
        sed -i "s#SERVICE_PLACEHOLDER#${{ inputs.service }}#g" "$COMPOSE_FILE"
        sed -i "s#GIT_SHA_PLACEHOLDER#${{ inputs.git_sha }}#g" "$COMPOSE_FILE"
        sed -i "s#GIT_REF_PLACEHOLDER#${{ inputs.git_ref }}#g" "$COMPOSE_FILE"
        sed -i "s#{{EXTERNAL_PORT}}#${EXTERNAL_PORT}#g" "$COMPOSE_FILE"
        sed -i "s#{{INTERNAL_PORT}}#${INTERNAL_PORT}#g" "$COMPOSE_FILE"
        
        echo "âœ… Generated compose file"
    
    - name: Create networks
      shell: bash
      run: |
        set -e
        echo "ðŸŒ Creating networks..."
        
        if ! docker network ls | grep -q "${{ inputs.project }}-network"; then
          docker network create ${{ inputs.project }}-network || echo "âš ï¸  Network may already exist"
        fi
        
        if ! docker network ls | grep -q "superdeploy-proxy"; then
          docker network create superdeploy-proxy || echo "âš ï¸  Network may already exist"
        fi
        
        echo "âœ… Networks ready"
    
    - name: Deploy service
      shell: bash
      run: |
        set -ex
        echo "ðŸš€ Deploying service: ${{ inputs.service }}"
        
        cd /opt/apps/${{ inputs.project }}/compose
        
        echo "ðŸ“¥ Pulling image: ${{ inputs.image }}"
        docker pull ${{ inputs.image }}
        
        echo "ðŸ³ Starting service container..."
        docker compose -f docker-compose-${{ inputs.service }}.yml up -d --wait
        
        echo "âœ… Service deployed!"
    
    - name: Verify deployment
      shell: bash
      run: |
        echo "ðŸ” Verifying deployment..."
        
        if docker ps --filter "name=${{ inputs.project }}-${{ inputs.service }}" | grep -q "${{ inputs.project }}-${{ inputs.service }}"; then
          echo "âœ… Container is running"
          docker ps --filter "name=${{ inputs.project }}-${{ inputs.service }}"
          echo "âœ… Deployment successful!"
        else
          echo "âŒ Container not found"
          docker ps -a --filter "name=${{ inputs.project }}-${{ inputs.service }}"
          exit 1
        fi
    
    - name: Clean up secrets
      if: always()
      shell: bash
      run: |
        rm -f /tmp/decrypted.env
        rm -f /tmp/encrypted.age
        echo "âœ… Secrets cleaned up"

