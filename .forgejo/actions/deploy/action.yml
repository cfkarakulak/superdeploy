name: 'Deploy Service'
description: 'Deploy a service to VM using Docker'

inputs:
  project:
    description: 'Project name'
    required: true
  service:
    description: 'Service name'
    required: true
  image:
    description: 'Docker image to deploy'
    required: true
  env_bundle:
    description: 'Base64 encoded environment bundle'
    required: true
  git_sha:
    description: 'Git SHA'
    required: true
  git_ref:
    description: 'Git ref'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Install dependencies
      shell: bash
      run: |
        set -e
        echo "::group::üì¶ Installing dependencies"
        
        # Check if age is already installed
        if command -v age &> /dev/null; then
          echo "‚úÖ age already installed"
          age --version
        else
          echo "üì• Installing age..."
          curl -sL https://github.com/FiloSottile/age/releases/download/v1.1.1/age-v1.1.1-linux-amd64.tar.gz | tar xz
          sudo mv age/age /usr/local/bin/
          rm -rf age
          echo "‚úÖ age installed"
          age --version
        fi
        
        echo "::endgroup::"
    
    - name: Decrypt environment bundle
      shell: bash
      run: |
        set -e
        echo "::group::üîê Decrypting environment bundle"
        echo "${{ inputs.env_bundle }}" | base64 -d > /tmp/encrypted.age
        echo "‚úÖ Base64 decoded ($(wc -c < /tmp/encrypted.age) bytes)"
        
        if [ -z "$AGE_SECRET_KEY" ]; then
          echo "‚ùå AGE_SECRET_KEY not set!"
          exit 1
        fi
        
        printf '%s' "$AGE_SECRET_KEY" > /tmp/age-key.txt
        chmod 600 /tmp/age-key.txt
        
        if ! age -d -i /tmp/age-key.txt /tmp/encrypted.age > /tmp/decrypted.env 2>&1; then
          echo "‚ùå AGE decryption failed!"
          cat /tmp/decrypted.env || echo "(no output)"
          rm -f /tmp/age-key.txt /tmp/encrypted.age /tmp/decrypted.env
          exit 1
        fi
        
        rm -f /tmp/age-key.txt /tmp/encrypted.age
        
        if [ ! -s /tmp/decrypted.env ]; then
          echo "‚ùå Decrypted file is empty!"
          exit 1
        fi
        
        echo "‚úÖ Decrypted successfully ($(wc -c < /tmp/decrypted.env) bytes)"
        echo "::endgroup::"

    - name: Docker login
      shell: bash
      run: |
        set -e
        echo "::group::üê≥ Docker Hub Login"
        echo "$DOCKER_TOKEN" | docker login -u "$DOCKER_USERNAME" --password-stdin
        echo "‚úÖ Logged in successfully"
        echo "::endgroup::"

    - name: Pull Docker image
      shell: bash
      run: |
        set -e
        echo "::group::üì• Pulling: ${{ inputs.image }}"
        docker pull ${{ inputs.image }}
        echo "‚úÖ Image pulled"
        echo "::endgroup::"

    - name: Deploy container
      shell: bash
      run: |
        set -e
        echo "::group::üöÄ Deploying ${{ inputs.service }}"
        
        PROJECT="${{ inputs.project }}"
        SERVICE="${{ inputs.service }}"
        IMAGE="${{ inputs.image }}"
        
        # Create compose directory
        sudo mkdir -p /opt/apps/$PROJECT/compose
        
        # Generate docker-compose file
        cat > /tmp/docker-compose-$SERVICE.yml << 'COMPOSE'
        version: '3.8'
        services:
          SERVICE_NAME:
            image: IMAGE_PLACEHOLDER
            container_name: PROJECT_NAME-SERVICE_NAME
            restart: unless-stopped
            env_file:
              - /tmp/decrypted.env
            networks:
              - PROJECT_NAME-network
            ports:
              - "PORT_PLACEHOLDER:PORT_PLACEHOLDER"
            labels:
              - "project=PROJECT_NAME"
              - "service=SERVICE_NAME"
              - "git.sha=GIT_SHA_PLACEHOLDER"

        networks:
          PROJECT_NAME-network:
            name: PROJECT_NAME-network
            external: true
        COMPOSE
        
        # Replace placeholders
        sed -i "s/SERVICE_NAME/$SERVICE/g" /tmp/docker-compose-$SERVICE.yml
        sed -i "s/PROJECT_NAME/$PROJECT/g" /tmp/docker-compose-$SERVICE.yml
        sed -i "s|IMAGE_PLACEHOLDER|$IMAGE|g" /tmp/docker-compose-$SERVICE.yml
        sed -i "s/GIT_SHA_PLACEHOLDER/${{ inputs.git_sha }}/g" /tmp/docker-compose-$SERVICE.yml
        
        # Determine port based on service
        if [ "$SERVICE" = "api" ]; then
          PORT=8000
        elif [ "$SERVICE" = "storefront" ]; then
          PORT=3000
        elif [ "$SERVICE" = "services" ]; then
          PORT=8001
        else
          PORT=8080
        fi
        
        sed -i "s/PORT_PLACEHOLDER/$PORT/g" /tmp/docker-compose-$SERVICE.yml
        
        # Move compose file
        sudo mv /tmp/docker-compose-$SERVICE.yml /opt/apps/$PROJECT/compose/docker-compose-$SERVICE.yml
        
        # Deploy
        cd /opt/apps/$PROJECT/compose
        docker compose -f docker-compose-$SERVICE.yml up -d
        
        echo "‚úÖ Container started successfully!"
        docker ps | grep $PROJECT-$SERVICE || true
        
        # Cleanup
        rm -f /tmp/decrypted.env
        
        echo "::endgroup::"
