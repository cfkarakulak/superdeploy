---
# System security role - Firewall, SSH hardening, security policies

- name: Validate required variables
  assert:
    that:
      - security_packages is defined
      - security_packages | length > 0
    fail_msg: |
      [system/security] ERROR: Missing or invalid required variables
        - Expected: security_packages
        - Found: security_packages={{ security_packages | default('UNDEFINED') }}
        - Fix: Ensure all required variables are defined in defaults/main.yml or passed as extra vars
        - Docs: See shared/ansible/roles/system/security/defaults/main.yml for variable definitions
    success_msg: "All required variables validated successfully"

- name: Wait for dpkg lock to be released
  shell: |
    timeout=300
    while [ $timeout -gt 0 ]; do
      if ! fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; then
        echo "Lock released"
        exit 0
      fi
      echo "Waiting for dpkg lock... ($timeout seconds remaining)"
      sleep 5
      timeout=$((timeout - 5))
    done
    echo "Timeout waiting for dpkg lock"
    exit 1
  changed_when: false

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  retries: 3
  delay: 10

- name: Install security packages
  apt:
    name: "{{ security_packages }}"
    state: present
  retries: 3
  delay: 10

- name: Configure UFW firewall
  include_tasks: firewall.yml

- name: Configure Fail2Ban for SSH
  copy:
    content: |
      [sshd]
      enabled = true
      port = 22
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = {{ fail2ban_maxretry }}
      bantime = {{ fail2ban_bantime }}
      findtime = {{ fail2ban_findtime }}
    dest: /etc/fail2ban/jail.d/sshd.conf
    owner: root
    group: root
    mode: '0644'

- name: Enable and start Fail2Ban
  systemd:
    name: fail2ban
    enabled: yes
    state: restarted

- name: Configure unattended upgrades
  copy:
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Download-Upgradeable-Packages "1";
      APT::Periodic::AutocleanInterval "7";
      APT::Periodic::Unattended-Upgrade "1";
      
      Unattended-Upgrade::Allowed-Origins {
        "${distro_id}:${distro_codename}-security";
        "${distro_id}ESMApps:${distro_codename}-apps-security";
      };
      
      Unattended-Upgrade::Mail "root";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: '0644'

- name: Apply sysctl hardening
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop: "{{ sysctl_hardening_params }}"

- name: Harden SSH configuration
  include_tasks: ssh-hardening.yml
  when: ssh_hardening_enabled | bool

- name: Ensure Docker socket has proper permissions
  file:
    path: /var/run/docker.sock
    mode: '0660'
    group: docker
  ignore_errors: yes

- name: Display security hardening summary
  debug:
    msg: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘  ğŸ”’ Security Hardening Applied                                    â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      âœ… UFW firewall enabled (SSH rate-limited)
      âœ… Fail2Ban active (SSH brute-force protection)
      âœ… Unattended security upgrades enabled
      âœ… Kernel parameters hardened
      âœ… SSH config hardened: {{ ssh_hardening_enabled }}
      âœ… Additional ports allowed: {{ firewall_additional_ports | default([]) | join(', ') or 'none' }}
