---
# GitHub Actions Runner Setup
# This role installs self-hosted GitHub runner on project VMs
# Note: Orchestrator is excluded in site.yml (hosts: all:!orchestrator)

- name: Install Python packages required for deployment hooks
  pip:
    name:
      - pyyaml
    state: present
    executable: pip3

- name: Create deployment directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - /opt/apps
    - /opt/superdeploy/projects
    - /opt/github-runner

- name: Determine project name
  set_fact:
    runner_project_name: "{{ project_name | default(group_names | reject('in', ['all', 'ungrouped', 'orchestrator', 'core']) | first | default('unknown')) }}"

- name: Get VM role from inventory
  set_fact:
    vm_role: "{{ hostvars[inventory_hostname].vm_role }}"

- name: Create project identifier file (for deployment workflows)
  copy:
    content: "{{ runner_project_name }}"
    dest: /opt/superdeploy/.project
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'

- name: Check if runner is already configured (early check)
  stat:
    path: /opt/github-runner/.runner
  register: runner_config_check

- name: Check if runner is registered with GitHub (verify it actually exists)
  uri:
    url: "https://api.github.com/orgs/{{ github_org }}/actions/runners"
    method: GET
    headers:
      Authorization: "Bearer {{ project_secrets.secrets.shared.REPOSITORY_TOKEN }}"
      Accept: "application/vnd.github+json"
    status_code: 200
    return_content: yes
  register: github_runners_list
  when: runner_config_check.stat.exists

- name: Check if this runner exists in GitHub
  set_fact:
    runner_exists_in_github: "{{ github_runners_list.json.runners | selectattr('name', 'equalto', inventory_hostname_short | default(inventory_hostname)) | list | length > 0 }}"
  when: runner_config_check.stat.exists

- name: Get runner status from GitHub API
  set_fact:
    runner_github_status: "{{ (github_runners_list.json.runners | selectattr('name', 'equalto', inventory_hostname_short | default(inventory_hostname)) | list | first).status }}"
  when: 
    - runner_config_check.stat.exists
    - runner_exists_in_github | default(false)

- name: Remove stale runner configuration if not in GitHub or offline
  block:
    - name: Stop runner service if offline
      systemd:
        name: github-runner
        state: stopped
      ignore_errors: yes
    
    - name: Wait for service to stop
      shell: sleep 2
      changed_when: false
    
    - name: Remove runner from GitHub API if offline
      command: >
        ./config.sh remove
        --token {{ project_secrets.secrets.shared.REPOSITORY_TOKEN }}
      args:
        chdir: /opt/github-runner
      become_user: "{{ superdeploy_user }}"
      ignore_errors: yes
      when: runner_exists_in_github | default(false)
    
    - name: Remove entire runner directory (clean install)
      shell: rm -rf /opt/github-runner
    
    - name: Recreate runner directory after cleanup
      file:
        path: /opt/github-runner
        state: directory
        owner: "{{ superdeploy_user }}"
        group: "{{ superdeploy_group | default(superdeploy_user) }}"
        mode: '0755'
  when: 
    - runner_config_check.stat.exists
    - not (runner_exists_in_github | default(true)) or (runner_github_status | default('offline')) == 'offline'

- name: Update runner config check after cleanup
  stat:
    path: /opt/github-runner/.runner
  register: runner_config_check

- name: Ensure runner directory exists (for fresh install)
  file:
    path: /opt/github-runner
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  when: not runner_config_check.stat.exists

- name: Create runner systemd service file (before first config)
  template:
    src: github-runner.service.j2
    dest: /etc/systemd/system/github-runner.service
    mode: '0644'
  when: not runner_config_check.stat.exists

- name: Reload systemd daemon (before first config)
  systemd:
    daemon_reload: yes
  when: not runner_config_check.stat.exists

- name: Remove old runner tarball (force fresh download)
  file:
    path: /tmp/github-runner.tar.gz
    state: absent
  when: not runner_config_check.stat.exists

- name: Download GitHub Actions runner (fresh install or after cleanup)
  get_url:
    url: "https://github.com/actions/runner/releases/download/v2.320.0/actions-runner-linux-x64-2.320.0.tar.gz"
    dest: /tmp/github-runner.tar.gz
    mode: '0644'
    force: yes
  when: not runner_config_check.stat.exists

- name: Clean directory before extract
  shell: rm -rf /opt/github-runner/*
  when: not runner_config_check.stat.exists

- name: Extract GitHub runner (fresh install or after cleanup)
  unarchive:
    src: /tmp/github-runner.tar.gz
    dest: /opt/github-runner
    remote_src: yes
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    extra_opts: [--strip-components=0]
  become: yes
  when: not runner_config_check.stat.exists

- name: Get GitHub runner registration token from API
  uri:
    url: "https://api.github.com/orgs/{{ github_org }}/actions/runners/registration-token"
    method: POST
    headers:
      Authorization: "Bearer {{ project_secrets.secrets.shared.REPOSITORY_TOKEN }}"
      Accept: "application/vnd.github+json"
      X-GitHub-Api-Version: "2022-11-28"
    status_code: 201
    validate_certs: yes
    timeout: 30
  register: github_runner_token_response
  retries: 3
  delay: 5
  until: github_runner_token_response.status == 201
  when: not (runner_config_check.stat.exists | default(true))
  failed_when:
    - github_runner_token_response.failed is defined
    - github_runner_token_response.failed
  vars:
    error_msg: |
      Failed to get GitHub runner token.
      Ensure github.organization is set in config.yml
      Ensure REPOSITORY_TOKEN is set in secrets.yml with admin:org scope (not just repo)

- name: Extract runner token
  set_fact:
    github_runner_token: "{{ github_runner_token_response.json.token }}"
  when: not (runner_config_check.stat.exists | default(true))
  no_log: true

- name: Configure GitHub runner
  command: >
    ./config.sh
    --url https://github.com/{{ github_org }}
    --token {{ github_runner_token }}
    --labels self-hosted,superdeploy,{{ runner_project_name }},{{ vm_role }}
    --name {{ inventory_hostname_short | default(inventory_hostname) }}
    --work _work
    --replace
    --unattended
  args:
    chdir: /opt/github-runner
  become_user: "{{ superdeploy_user }}"
  when: not (runner_config_check.stat.exists | default(true))
  register: runner_register_result
  failed_when:
    - runner_register_result.rc != 0
    - "'Successfully replaced the runner' not in runner_register_result.stdout"
  vars:
    error_msg: |
      Failed to configure GitHub runner.
      Ensure github.organization is set correctly in config.yml

- name: Display runner registration result
  debug:
    msg: 
      - "{{ 'Runner registered successfully!' if (runner_register_result is defined and runner_register_result.changed) else 'Runner already registered' }}"
      - "Runner Name: {{ inventory_hostname_short | default(inventory_hostname) }}"
      - "Runner Labels:"
      - "  - self-hosted"
      - "  - superdeploy"
      - "  - {{ runner_project_name }}"
      - "  - {{ vm_role }}"
      - "Project: {{ runner_project_name }}"
      - "VM Role: {{ vm_role }}"
      - ""
      - "✅ Workflows should use: runs-on: [self-hosted, superdeploy, {{ runner_project_name }}, {{ vm_role }}]"

- name: Enable and start runner service after registration
  systemd:
    name: github-runner
    enabled: yes
    state: started
  when: runner_register_result is defined and runner_register_result.changed

- name: Wait for runner to connect and stabilize
  shell: sleep 15
  when: runner_register_result is defined and runner_register_result.changed
  changed_when: false

- name: Display runner health status
  debug:
    msg: "✅ GitHub runner is ready on {{ inventory_hostname_short | default(inventory_hostname) }}"

