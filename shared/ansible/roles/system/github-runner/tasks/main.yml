---
# GitHub Actions Runner Setup
# This role installs self-hosted GitHub runner on project VMs
# Note: Orchestrator is excluded in site.yml (hosts: all:!orchestrator)

- name: Install Python packages required for deployment hooks
  pip:
    name:
      - pyyaml
    state: present
    executable: pip3

- name: Create deployment directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - /opt/apps
    - /opt/superdeploy/projects
    - /opt/github-runner

- name: Determine project name
  set_fact:
    runner_project_name: "{{ project_name | default(group_names | reject('in', ['all', 'ungrouped', 'orchestrator', 'core']) | first | default('unknown')) }}"

- name: Get VM role from inventory
  set_fact:
    vm_role: "{{ hostvars[inventory_hostname].vm_role }}"

- name: Create project identifier file (for deployment workflows)
  copy:
    content: "{{ runner_project_name }}"
    dest: /opt/superdeploy/.project
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'

- name: Check if GitHub runner is already installed
  stat:
    path: /opt/github-runner/config.sh
  register: runner_check

- name: Download GitHub Actions runner
  get_url:
    url: "https://github.com/actions/runner/releases/download/v2.311.0/actions-runner-linux-x64-2.311.0.tar.gz"
    dest: /tmp/github-runner.tar.gz
    mode: '0644'
  when: not runner_check.stat.exists

- name: Extract GitHub runner
  unarchive:
    src: /tmp/github-runner.tar.gz
    dest: /opt/github-runner
    remote_src: yes
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
  become: yes
  when: not runner_check.stat.exists

- name: Check if runner is already configured
  stat:
    path: /opt/github-runner/.runner
  register: runner_config_check

- name: Check if runner is registered with GitHub (verify it actually exists)
  uri:
    url: "https://api.github.com/orgs/{{ github_org }}/actions/runners"
    method: GET
    headers:
      Authorization: "Bearer {{ project_secrets.shared.GITHUB_TOKEN }}"
      Accept: "application/vnd.github+json"
    status_code: 200
    return_content: yes
  register: github_runners_list
  when: runner_config_check.stat.exists

- name: Check if this runner exists in GitHub
  set_fact:
    runner_exists_in_github: "{{ github_runners_list.json.runners | selectattr('name', 'equalto', inventory_hostname_short | default(inventory_hostname)) | list | length > 0 }}"
  when: runner_config_check.stat.exists

- name: Remove stale runner configuration if not in GitHub
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /opt/github-runner/.runner
    - /opt/github-runner/.credentials
  when: 
    - runner_config_check.stat.exists
    - not (runner_exists_in_github | default(true))

- name: Update runner config check after cleanup
  stat:
    path: /opt/github-runner/.runner
  register: runner_config_check

- name: Get GitHub runner registration token from API
  uri:
    url: "https://api.github.com/orgs/{{ github_org }}/actions/runners/registration-token"
    method: POST
    headers:
      Authorization: "Bearer {{ project_secrets.shared.GITHUB_TOKEN }}"
      Accept: "application/vnd.github+json"
      X-GitHub-Api-Version: "2022-11-28"
    status_code: 201
    validate_certs: yes
    timeout: 30
  register: github_runner_token_response
  retries: 3
  delay: 5
  until: github_runner_token_response.status == 201
  when: not runner_config_check.stat.exists
  failed_when:
    - github_runner_token_response.failed is defined
    - github_runner_token_response.failed
  vars:
    error_msg: |
      Failed to get GitHub runner token.
      Ensure github.organization is set in config.yml
      Ensure GITHUB_TOKEN is set in secrets.yml with admin:org scope (not just repo)

- name: Extract runner token
  set_fact:
    github_runner_token: "{{ github_runner_token_response.json.token }}"
  when: not runner_config_check.stat.exists
  no_log: true

- name: Configure GitHub runner
  command: >
    ./config.sh
    --url https://github.com/{{ github_org }}
    --token {{ github_runner_token }}
    --labels self-hosted,superdeploy,{{ runner_project_name }},{{ vm_role }}
    --name {{ inventory_hostname_short | default(inventory_hostname) }}
    --work _work
    --replace
    --unattended
  args:
    chdir: /opt/github-runner
  become_user: "{{ superdeploy_user }}"
  when: not runner_config_check.stat.exists
  register: runner_register_result
  failed_when:
    - runner_register_result.rc != 0
  vars:
    error_msg: |
      Failed to configure GitHub runner.
      Ensure github.organization is set correctly in config.yml

- name: Display runner registration result
  debug:
    msg: 
      - "{{ 'Runner registered successfully!' if (runner_register_result is defined and runner_register_result.changed) else 'Runner already registered' }}"
      - "Runner Name: {{ inventory_hostname_short | default(inventory_hostname) }}"
      - "Runner Labels:"
      - "  - self-hosted"
      - "  - superdeploy"
      - "  - {{ runner_project_name }}"
      - "  - {{ vm_role }}"
      - "Project: {{ runner_project_name }}"
      - "VM Role: {{ vm_role }}"
      - ""
      - "✅ Workflows should use: runs-on: [self-hosted, superdeploy, {{ runner_project_name }}, {{ vm_role }}]"

- name: Create runner systemd service file
  template:
    src: github-runner.service.j2
    dest: /etc/systemd/system/github-runner.service
    mode: '0644'

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Enable and start runner service
  systemd:
    name: github-runner
    enabled: yes
    state: started
    daemon_reload: yes

- name: Wait for runner service to initialize
  shell: sleep 5
  changed_when: false

- name: Display runner health status
  debug:
    msg: "✅ GitHub runner is ready on {{ inventory_hostname_short | default(inventory_hostname) }}"

