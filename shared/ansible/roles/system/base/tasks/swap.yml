---
# Configure swap space for better memory management

- name: Check if swap is already configured
  stat:
    path: "{{ swap_file_path }}"
  register: swap_file

- name: Check if swap is currently active
  shell: "swapon --show | grep -q '{{ swap_file_path }}'"
  register: swap_active
  changed_when: false
  failed_when: false

- name: Create swap file
  command: "fallocate -l {{ swap_size_mb }}M {{ swap_file_path }}"
  when: not swap_file.stat.exists

- name: Set swap file permissions (always ensure correct permissions)
  file:
    path: "{{ swap_file_path }}"
    mode: '0600'
    owner: root
    group: root

- name: Format swap file
  command: "mkswap {{ swap_file_path }}"
  when: not swap_file.stat.exists
  register: mkswap_result
  failed_when: false
  changed_when: mkswap_result.rc == 0

- name: Enable swap file
  command: "swapon {{ swap_file_path }}"
  when: 
    - swap_active.rc != 0
  register: swap_enable_result
  changed_when: swap_enable_result.rc == 0
  failed_when: false

- name: Add swap to fstab
  lineinfile:
    path: /etc/fstab
    line: "{{ swap_file_path }} none swap sw 0 0"
    state: present
    create: yes

- name: Configure swappiness (lower = less aggressive swapping)
  sysctl:
    name: vm.swappiness
    value: "{{ swap_swappiness }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-swap.conf
    reload: no

- name: Configure cache pressure
  sysctl:
    name: vm.vfs_cache_pressure
    value: "{{ swap_cache_pressure }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-swap.conf
    reload: no

- name: Apply sysctl changes
  command: sysctl -p /etc/sysctl.d/99-swap.conf
  changed_when: false
  failed_when: false
