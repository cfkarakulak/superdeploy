---
# System base role - OS-level setup, users, directories, time sync, mail

- name: Validate required variables
  assert:
    that:
      - superdeploy_user is defined
      - superdeploy_user | length > 0
      - superdeploy_group is defined
      - superdeploy_group | length > 0
      - base_directories is defined
      - base_directories | length > 0
      - swap_size_mb is defined
      - swap_size_mb | int > 0
      - essential_packages is defined
      - essential_packages | length > 0
    fail_msg: |
      [system/base] ERROR: Missing or invalid required variables
        - Expected: superdeploy_user, superdeploy_group, base_directories, swap_size_mb, essential_packages
        - Found: superdeploy_user={{ superdeploy_user | default('UNDEFINED') }}, superdeploy_group={{ superdeploy_group | default('UNDEFINED') }}
        - Fix: Ensure all required variables are defined in defaults/main.yml or passed as extra vars
        - Docs: See shared/ansible/roles/system/base/defaults/main.yml for variable definitions
    success_msg: "All required variables validated successfully"

- name: Wait for dpkg lock to be released
  shell: |
    timeout=300
    while [ $timeout -gt 0 ]; do
      if ! fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; then
        echo "Lock released"
        exit 0
      fi
      echo "Waiting for dpkg lock... ($timeout seconds remaining)"
      sleep 5
      timeout=$((timeout - 5))
    done
    echo "Timeout waiting for dpkg lock"
    exit 1
  changed_when: false

- name: Update package cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  retries: 5
  delay: 10
  register: apt_update
  until: apt_update is success

- name: Install essential packages
  apt:
    name: "{{ essential_packages }}"
    state: present
  retries: 5
  delay: 10
  register: apt_install
  until: apt_install is success
  # PERFORMANCE: Run async (packages install in background)
  async: 600
  poll: 0
  
- name: Wait for essential packages installation
  async_status:
    jid: "{{ apt_install.ansible_job_id }}"
  register: apt_install_result
  until: apt_install_result.finished
  retries: 60
  delay: 10

- name: Ensure superdeploy user exists
  user:
    name: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    create_home: yes
    shell: /bin/bash
    state: present

- name: Configure passwordless sudo for superdeploy user
  copy:
    content: |
      # Allow superdeploy user to run sudo without password
      {{ superdeploy_user }} ALL=(ALL) NOPASSWD:ALL
    dest: /etc/sudoers.d/{{ superdeploy_user }}
    owner: root
    group: root
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Configure swap
  include_tasks: swap.yml

- name: Configure chrony for time synchronization
  block:
    - name: Start and enable chrony service
      systemd:
        name: chrony
        state: started
        enabled: yes

    - name: Configure chrony servers
      lineinfile:
        path: /etc/chrony/chrony.conf
        line: "{{ item }}"
        state: present
      loop: "{{ chrony_ntp_servers }}"
      loop_control:
        label: "{{ item.split()[1] if item.split() | length > 1 else item }}"
      notify: Restart chrony

- name: Configure Postfix for internet mail (satellite)
  debconf:
    name: postfix
    question: "{{ item.question }}"
    value: "{{ item.value }}"
    vtype: "{{ item.vtype }}"
  loop:
    - { question: 'postfix/main_mailer_type', value: 'Internet Site', vtype: 'select' }
    - { question: 'postfix/mailname', value: "{{ postfix_mailname }}", vtype: 'string' }
  loop_control:
    label: "{{ item.question }}"
  environment:
    DEBIAN_FRONTEND: noninteractive
  register: postfix_debconf_result
  failed_when: false

- name: Configure Postfix main.cf
  lineinfile:
    path: /etc/postfix/main.cf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: '^inet_interfaces', line: "inet_interfaces = {{ postfix_inet_interfaces }}" }
    - { regexp: '^mydestination', line: "mydestination = {{ postfix_mydestination }}" }
  loop_control:
    label: "{{ item.regexp }}"
  notify: Restart postfix

- name: Enable and start Postfix
  systemd:
    name: postfix
    enabled: yes
    state: started

- name: Create base application directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0755'
  loop: "{{ base_directories }}"
  loop_control:
    label: "{{ item }}"

# ============================================================================
# Security Configuration (Integrated)
# ============================================================================

- name: Install security packages
  apt:
    name: "{{ security_packages }}"
    state: present
  retries: 3
  delay: 10

- name: Configure UFW firewall
  include_tasks: firewall.yml

- name: Configure Fail2Ban for SSH
  copy:
    content: |
      [sshd]
      enabled = true
      port = 22
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = {{ fail2ban_maxretry }}
      bantime = {{ fail2ban_bantime }}
      findtime = {{ fail2ban_findtime }}
    dest: /etc/fail2ban/jail.d/sshd.conf
    owner: root
    group: root
    mode: '0644'

- name: Enable and start Fail2Ban
  systemd:
    name: fail2ban
    enabled: yes
    state: restarted

- name: Configure unattended upgrades
  copy:
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Download-Upgradeable-Packages "1";
      APT::Periodic::AutocleanInterval "7";
      APT::Periodic::Unattended-Upgrade "1";
      
      Unattended-Upgrade::Allowed-Origins {
        "${distro_id}:${distro_codename}-security";
        "${distro_id}ESMApps:${distro_codename}-apps-security";
      };
      
      Unattended-Upgrade::Mail "root";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: '0644'

- name: Apply sysctl hardening
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-hardening.conf
    reload: no
  loop: "{{ sysctl_hardening_params }}"
  loop_control:
    label: "{{ item.name }}"
  register: sysctl_hardening_result

- name: Reload sysctl after hardening changes
  command: sysctl --system
  when: sysctl_hardening_result.changed
  changed_when: false

- name: Harden SSH configuration
  include_tasks: ssh-config.yml
  when: ssh_hardening_enabled | bool
