---
# UFW Firewall Configuration

- name: Skip firewall configuration on orchestrator during project deployments
  debug:
    msg: "Skipping firewall reconfiguration - orchestrator already configured"
  when: skip_firewall_reset | default(false)

- name: Configure firewall
  block:
    - name: Check if UFW is already configured
      stat:
        path: /etc/ufw/ufw.conf
      register: ufw_configured

    - name: Reset UFW to defaults (only on first run)
      ufw:
        state: reset
      when: not ufw_configured.stat.exists

    - name: Disable UFW temporarily to ensure SSH access
      ufw:
        state: disabled

- name: Set UFW default policies
  ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: 'incoming', policy: 'deny' }
    - { direction: 'outgoing', policy: 'allow' }

- name: Allow SSH FIRST (before enabling firewall)
  ufw:
    rule: allow
    port: '22'
    proto: tcp
    comment: 'SSH'

- name: Allow HTTP
  ufw:
    rule: allow
    port: '80'
    proto: tcp
    comment: 'HTTP'

- name: Allow HTTPS
  ufw:
    rule: allow
    port: '443'
    proto: tcp
    comment: 'HTTPS'

- name: Collect application ports from project configuration
  set_fact:
    app_ports: >-
      {{
        project_config.apps.values() | 
        map(attribute='external_port', default=None) | 
        select('defined') | 
        list +
        project_config.apps.values() | 
        map(attribute='port', default=None) | 
        select('defined') | 
        list
      }}
  when: project_config is defined and project_config.apps is defined

- name: Allow application ports
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Application port"
  loop: "{{ app_ports | default([]) | unique }}"
  when: app_ports is defined and app_ports | length > 0

- name: Initialize addon ports list
  set_fact:
    addon_ports: []
  when: project_name is defined

- name: Collect ports from each addon category
  set_fact:
    addon_ports: "{{ addon_ports | default([]) + (category_ports | from_yaml) }}"
  vars:
    category_name: "{{ category_item.key }}"
    category_instances: "{{ category_item.value }}"
    category_ports: |
      {% set ports = [] %}
      {% for instance_name, instance_config in category_instances.items() %}
        {% if instance_config.port is defined and instance_config.port | int > 0 %}
          {% set _ = ports.append(instance_config.port | int) %}
        {% endif %}
        {% if instance_config.management_port is defined and instance_config.management_port | int > 0 %}
          {% set _ = ports.append(instance_config.management_port | int) %}
        {% endif %}
        {% if instance_config.http_port is defined and instance_config.http_port | int > 0 %}
          {% set _ = ports.append(instance_config.http_port | int) %}
        {% endif %}
        {% if instance_config.https_port is defined and instance_config.https_port | int > 0 %}
          {% set _ = ports.append(instance_config.https_port | int) %}
        {% endif %}
        {% if instance_config.admin_port is defined and instance_config.admin_port | int > 0 %}
          {% set _ = ports.append(instance_config.admin_port | int) %}
        {% endif %}
      {% endfor %}
      {{ ports }}
  loop: "{{ full_project_config.addons | default({}) | dict2items }}"
  loop_control:
    loop_var: category_item
    label: "{{ category_item.key }}"
  when: 
    - project_name is defined
    - full_project_config is defined
    - full_project_config.addons is defined

- name: Flatten and deduplicate addon ports
  set_fact:
    addon_ports: "{{ addon_ports | default([]) | flatten | unique | sort }}"
  when: 
    - project_name is defined
    - addon_ports is defined

- name: Display collected addon ports for firewall
  debug:
    msg: "Addon ports to open: {{ addon_ports | default([]) | join(', ') if addon_ports | default([]) | length > 0 else 'none' }}"
  when: project_name is defined

- name: Allow addon ports in firewall
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Addon service port"
  loop: "{{ addon_ports | default([]) }}"
  when: 
    - project_name is defined
    - addon_ports is defined
    - addon_ports | length > 0

- name: Allow additional ports from configuration
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Additional port from configuration"
  loop: "{{ firewall_additional_ports }}"
  when: firewall_additional_ports is defined and firewall_additional_ports | length > 0

- name: Enable UFW (after SSH is allowed)
  ufw:
    state: enabled
    policy: deny
  when: not (skip_firewall_reset | default(false))

- name: Reload UFW to apply all rules
  ufw:
    state: reloaded
  when: not (skip_firewall_reset | default(false))
