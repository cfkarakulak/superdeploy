---
# UFW Firewall Configuration

- name: Check if UFW is already configured
  stat:
    path: /etc/ufw/ufw.conf
  register: ufw_configured

- name: Reset UFW to defaults (only on first run)
  ufw:
    state: reset
  when: not ufw_configured.stat.exists

- name: Disable UFW temporarily to ensure SSH access
  ufw:
    state: disabled

- name: Set UFW default policies
  ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: 'incoming', policy: 'deny' }
    - { direction: 'outgoing', policy: 'allow' }

- name: Allow SSH FIRST (before enabling firewall)
  ufw:
    rule: limit
    port: '22'
    proto: tcp
    comment: 'SSH (rate-limited)'

- name: Allow HTTP
  ufw:
    rule: allow
    port: '80'
    proto: tcp
    comment: 'HTTP'

- name: Allow HTTPS
  ufw:
    rule: allow
    port: '443'
    proto: tcp
    comment: 'HTTPS'

- name: Collect Forgejo port from project configuration
  set_fact:
    forgejo_port: "{{ project_config.infrastructure.forgejo.port | default(3001) }}"
  when: project_config is defined and project_config.infrastructure is defined and project_config.infrastructure.forgejo is defined

- name: Allow Forgejo port
  ufw:
    rule: allow
    port: "{{ forgejo_port }}"
    proto: tcp
    comment: "Forgejo web interface"
  when: forgejo_port is defined

- name: Collect application ports from project configuration
  set_fact:
    app_ports: "{{ project_config.apps | dict2items | map(attribute='value.port') | list }}"
  when: project_config is defined and project_config.apps is defined

- name: Allow application ports
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Application port"
  loop: "{{ app_ports }}"
  when: app_ports is defined and app_ports | length > 0

- name: Collect addon ports from project configuration
  set_fact:
    addon_ports: []
  when: project_config is defined

- name: Add PostgreSQL port if enabled
  set_fact:
    addon_ports: "{{ addon_ports + [project_config.addons.postgres.port | default(5432)] }}"
  when: 
    - project_config is defined
    - project_config.addons is defined
    - project_config.addons.postgres is defined
    - project_config.addons.postgres.port is defined

- name: Add Redis port if enabled
  set_fact:
    addon_ports: "{{ addon_ports + [project_config.addons.redis.port | default(6379)] }}"
  when: 
    - project_config is defined
    - project_config.addons is defined
    - project_config.addons.redis is defined
    - project_config.addons.redis.port is defined

- name: Add RabbitMQ port if enabled
  set_fact:
    addon_ports: "{{ addon_ports + [project_config.addons.rabbitmq.port | default(5672)] }}"
  when: 
    - project_config is defined
    - project_config.addons is defined
    - project_config.addons.rabbitmq is defined
    - project_config.addons.rabbitmq.port is defined

- name: Add RabbitMQ management port if enabled
  set_fact:
    addon_ports: "{{ addon_ports + [project_config.addons.rabbitmq.management_port | default(15672)] }}"
  when: 
    - project_config is defined
    - project_config.addons is defined
    - project_config.addons.rabbitmq is defined
    - project_config.addons.rabbitmq.management_port is defined

- name: Add MongoDB port if enabled
  set_fact:
    addon_ports: "{{ addon_ports + [project_config.addons.mongodb.port | default(27017)] }}"
  when: 
    - project_config is defined
    - project_config.addons is defined
    - project_config.addons.mongodb is defined
    - project_config.addons.mongodb.port is defined

- name: Add Prometheus port if monitoring enabled
  set_fact:
    addon_ports: "{{ addon_ports + [project_config.monitoring.prometheus_port | default(9090)] }}"
  when: 
    - project_config is defined
    - project_config.monitoring is defined
    - project_config.monitoring.enabled | default(false) | bool
    - project_config.monitoring.prometheus_port is defined

- name: Add Grafana port if monitoring enabled
  set_fact:
    addon_ports: "{{ addon_ports + [project_config.monitoring.grafana_port | default(3000)] }}"
  when: 
    - project_config is defined
    - project_config.monitoring is defined
    - project_config.monitoring.enabled | default(false) | bool
    - project_config.monitoring.grafana_port is defined

- name: Allow addon ports
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Addon service port"
  loop: "{{ addon_ports }}"
  when: addon_ports is defined and addon_ports | length > 0

- name: Allow additional ports from configuration
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Additional port from configuration"
  loop: "{{ firewall_additional_ports }}"
  when: firewall_additional_ports is defined and firewall_additional_ports | length > 0

- name: Enable UFW (after SSH is allowed)
  ufw:
    state: enabled
    policy: deny
  
- name: Reload UFW to apply all rules
  ufw:
    state: reloaded
