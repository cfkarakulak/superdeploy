---
# Render templates for an addon
# This task renders compose.yml.j2 and other templates with environment variables

- name: Check if addon has compose.yml.j2 template
  stat:
    path: "{{ addon_path }}/compose.yml.j2"
  register: compose_template
  delegate_to: localhost
  become: no

- name: Set metadata variables for templates
  set_fact:
    version: "{{ addon_metadata.version | default('1.0') }}"
    healthcheck: "{{ addon_metadata.healthcheck | default({}) }}"
    resources: "{{ addon_metadata.resources | default({}) }}"
    compose: "{{ addon_metadata.compose | default({}) }}"
    ports: "{{ addon_metadata.ports | default([]) }}"
    monitoring: "{{ addon_metadata.monitoring | default({}) }}"
    prometheus: "{{ addon_metadata.prometheus | default({}) }}"
    grafana: "{{ addon_metadata.grafana | default({}) }}"
    prometheus_retention: "{{ addon_metadata.prometheus.scrape_interval | default('15d') }}"
    addon_config: "{{ addon_specific_config }}"
    project: "{{ project_name }}"

- name: Flatten environment variables for template access
  set_fact:
    "{{ item.key }}": "{{ item.value }}"
  loop: "{{ addon_env_vars | dict2items }}"
  no_log: true

- name: Render docker-compose.yml from template
  include_tasks: render-compose-template.yml
  when: compose_template.stat.exists

- name: Find additional templates in addon templates directory
  find:
    paths: "{{ addon_path }}/templates"
    patterns: "*.j2"
    recurse: yes
  register: addon_templates
  when: addon_has_templates

- name: Create templates output directory
  file:
    path: "{{ addon_deployment_path }}/config"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0755'
  when: addon_templates.matched | default(0) > 0

- name: Render additional addon templates
  include_tasks: render-additional-template.yml
  vars:
    template_file: "{{ item.path }}"
  loop: "{{ addon_templates.files }}"
  when: addon_templates.matched | default(0) > 0

- name: Display rendered templates
  debug:
    msg:
      - "Rendered templates for {{ addon_name }}:"
      - "  - docker-compose.yml: {{ 'yes' if compose_template.stat.exists else 'no' }}"
      - "  - Additional templates: {{ addon_templates.matched | default(0) }}"
    verbosity: 1
