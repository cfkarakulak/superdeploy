---
# Addon Deployer Role - Main Entry Point
# This role orchestrates the deployment of addons based on project configuration

- name: Validate required variables
  assert:
    that:
      - project_name is defined
      - project_config is defined
      - addons_base_path is defined
    fail_msg: |
      [ADDON-DEPLOYER] ERROR: Missing required variables
        - Expected: project_name, project_config, addons_base_path
        - Found: project_name={{ project_name | default('undefined') }}, project_config={{ 'defined' if project_config is defined else 'undefined' }}, addons_base_path={{ addons_base_path | default('undefined') }}
        - Fix: Ensure these variables are passed to the addon-deployer role
        - Docs: See shared/ansible/roles/orchestration/addon-deployer/README.md
    quiet: true

- name: Parse enabled_addons from JSON string (if string)
  set_fact:
    enabled_addons_list: "{{ enabled_addons | from_json }}"
  when: 
    - enabled_addons is defined
    - enabled_addons is string

- name: Use enabled_addons as-is if already a list
  set_fact:
    enabled_addons_list: "{{ enabled_addons }}"
  when: 
    - enabled_addons is defined
    - enabled_addons is not string

- name: Set default values for optional variables
  set_fact:
    # NO DEFAULT for enabled_addons - must be explicitly passed
    enabled_addons: "{{ enabled_addons_list }}"
    # These are OK - reasonable defaults for system users
    superdeploy_user: "{{ superdeploy_user | default('superdeploy') }}"
    superdeploy_group: "{{ superdeploy_group | default('superdeploy') }}"
    # Network configuration - extract from project_config
    network_subnet: "{{ project_config.network.docker_subnet | default('172.30.0.0/24') }}"

- name: Display addon deployment plan
  debug:
    msg:
      - "Project: {{ project_name }}"
      - "Addons base path: {{ addons_base_path }}"
      - "Addons to deploy: {{ enabled_addons | join(', ') if enabled_addons | length > 0 else 'none' }}"
    verbosity: 0

- name: Check if project Docker network exists
  shell: "docker network inspect {{ project_name }}-network >/dev/null 2>&1"
  register: network_exists
  changed_when: false
  failed_when: false
  
- name: Show network check result  
  debug:
    msg: "Network '{{ project_name }}-network' {{ 'exists' if network_exists.rc == 0 else 'will be created' }}"
    verbosity: 0

- name: Get current network subnet (if exists)
  shell: "docker network inspect {{ project_name }}-network --format '{{'{{range .IPAM.Config}}{{.Subnet}}{{end}}'}}'  2>/dev/null || echo ''"
  register: current_subnet
  changed_when: false
  failed_when: false
  become_user: "{{ superdeploy_user }}"
  when: network_exists.rc == 0

- name: Stop containers using old network (if subnet changed)
  shell: "docker ps -q --filter network={{ project_name }}-network | xargs -r docker stop"
  become_user: "{{ superdeploy_user }}"
  when: 
    - network_exists.rc == 0
    - current_subnet.stdout != ""
    - current_subnet.stdout != network_subnet
  ignore_errors: yes

- name: Remove existing project Docker network (if subnet changed)
  docker_network:
    name: "{{ project_name }}-network"
    state: absent
    force: yes
  become_user: "{{ superdeploy_user }}"
  when: 
    - network_exists.rc == 0
    - current_subnet.stdout != ""
    - current_subnet.stdout != network_subnet
  ignore_errors: yes

- name: Create project Docker network
  shell: |
    docker network inspect {{ project_name }}-network >/dev/null 2>&1 || \
    docker network create {{ project_name }}-network --subnet={{ network_subnet }}
  become_user: "{{ superdeploy_user }}"
  register: network_create
  changed_when: "'already exists' not in network_create.stderr and network_create.rc == 0"
  failed_when: 
    - network_create.rc != 0
    - "'already exists' not in network_create.stderr"

- name: "Parse addon instances from project config"
  include_tasks: parse-addon-instances.yml

- name: "Display addon deployment plan"
  debug:
    msg:
      - "Deploying {{ addon_instances | length }} addon instance(s)"
      - "Instances: {{ addon_instances | map(attribute='full_name') | list | join(', ') }}"
    verbosity: 0

# Deploy each addon instance
- include_tasks: deploy-addon-instance.yml
  loop: "{{ addon_instances }}"
  loop_control:
    loop_var: addon_instance
    label: "{{ addon_instance.full_name }}"
