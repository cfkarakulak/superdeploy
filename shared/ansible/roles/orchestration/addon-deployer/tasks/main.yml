---
# Addon Deployer Role - Main Entry Point
# This role orchestrates the deployment of addons based on project configuration

- name: Validate required variables
  assert:
    that:
      - project_name is defined
      - project_config is defined
      - addons_base_path is defined
    fail_msg: |
      [ADDON-DEPLOYER] ERROR: Missing required variables
        - Expected: project_name, project_config, addons_base_path
        - Found: project_name={{ project_name | default('undefined') }}, project_config={{ 'defined' if project_config is defined else 'undefined' }}, addons_base_path={{ addons_base_path | default('undefined') }}
        - Fix: Ensure these variables are passed to the addon-deployer role
        - Docs: See shared/ansible/roles/orchestration/addon-deployer/README.md
    quiet: true

- name: Parse enabled_addons from JSON string (if string)
  set_fact:
    enabled_addons_list: "{{ enabled_addons | from_json }}"
  when: 
    - enabled_addons is defined
    - enabled_addons is string

- name: Use enabled_addons as-is if already a list
  set_fact:
    enabled_addons_list: "{{ enabled_addons }}"
  when: 
    - enabled_addons is defined
    - enabled_addons is not string

- name: Set default values for optional variables
  set_fact:
    # NO DEFAULT for enabled_addons - must be explicitly passed
    enabled_addons: "{{ enabled_addons_list }}"
    # These are OK - reasonable defaults for system users
    superdeploy_user: "{{ superdeploy_user | default('superdeploy') }}"
    superdeploy_group: "{{ superdeploy_group | default('superdeploy') }}"

- name: Display addon deployment plan
  debug:
    msg:
      - "Project: {{ project_name }}"
      - "Addons base path: {{ addons_base_path }}"
      - "Addons to deploy: {{ enabled_addons | join(', ') if enabled_addons | length > 0 else 'none' }}"
    verbosity: 0

- name: Create project configuration directory
  file:
    path: "/opt/superdeploy/projects/{{ project_name }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0755'

- name: Debug project_config before sync
  debug:
    msg:
      - "Project name: {{ project_name }}"
      - "Project config keys: {{ project_config.keys() | list }}"
      - "Project config size: {{ project_config | to_json | length }}"
    verbosity: 0

- name: Sync project.yml to VM (for Forgejo workflows)
  copy:
    content: "{{ project_config | to_nice_yaml }}"
    dest: "/opt/superdeploy/projects/{{ project_name }}/project.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0644'

- name: Check if project Docker network exists
  shell: "docker network inspect {{ project_name }}-network >/dev/null 2>&1"
  register: network_exists
  changed_when: false
  failed_when: false
  become_user: "{{ superdeploy_user }}"

- name: Get current network subnet (if exists)
  shell: "docker network inspect {{ project_name }}-network --format '{{'{{range .IPAM.Config}}{{.Subnet}}{{end}}'}}'  2>/dev/null || echo ''"
  register: current_subnet
  changed_when: false
  failed_when: false
  become_user: "{{ superdeploy_user }}"
  when: network_exists.rc == 0

- name: Stop containers using old network (if subnet changed)
  shell: "docker ps -q --filter network={{ project_name }}-network | xargs -r docker stop"
  become_user: "{{ superdeploy_user }}"
  when: 
    - network_exists.rc == 0
    - current_subnet.stdout != ""
    # NO DEFAULT - fail fast if subnet not configured
    - current_subnet.stdout != project_config.network.docker_subnet
  ignore_errors: yes

- name: Remove existing project Docker network (if subnet changed)
  docker_network:
    name: "{{ project_name }}-network"
    state: absent
    force: yes
  become_user: "{{ superdeploy_user }}"
  when: 
    - network_exists.rc == 0
    - current_subnet.stdout != ""
    # NO DEFAULT - fail fast if subnet not configured
    - current_subnet.stdout != project_config.network.docker_subnet
  ignore_errors: yes

- name: Create project Docker network
  docker_network:
    name: "{{ project_name }}-network"
    driver: bridge
    ipam_config:
      # NO DEFAULT - fail fast if subnet not configured
      - subnet: "{{ project_config.network.docker_subnet }}"
    state: present
  become_user: "{{ superdeploy_user }}"
  register: network_create
  failed_when: 
    - network_create.failed
    - "'already exists' not in network_create.msg | default('')"

- name: "Deploy Infrastructure Addons"
  debug:
    msg:
      - "Deploying {{ enabled_addons | length }} addon(s): {{ enabled_addons | join(', ') }}"
      - "Tip: To deploy only one addon, use: --addon <name>"

# Loop through each enabled addon and deploy it
# NOTE: Play-level any_errors_fatal ensures addon failures STOP the playbook
- name: Deploy each addon
  include_tasks: deploy-addon.yml
  loop: "{{ enabled_addons }}"
  loop_control:
    loop_var: addon_name
