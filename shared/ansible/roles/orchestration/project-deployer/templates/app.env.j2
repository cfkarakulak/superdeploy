# =============================================================================
# Environment file for {{ item.key }} application
# =============================================================================
# Auto-generated by project-deployer role from database secrets
# DO NOT EDIT MANUALLY - Changes will be overwritten
# =============================================================================

# Project configuration
PROJECT_NAME={{ project_name }}
APP_NAME={{ item.key }}
PORT={{ item.value.port }}

# Network configuration
NETWORK_NAME={{ network_name }}
NETWORK_SUBNET={{ network_subnet }}

# Paths
DATA_PATH={{ project_base_path }}/data/{{ item.key }}
LOGS_PATH={{ project_base_path }}/logs/{{ item.key }}

{% if monitoring_enabled %}
# Monitoring configuration
MONITORING_ENABLED=true
PROMETHEUS_ENDPOINT={{ prometheus_endpoint }}
{% endif %}

# =============================================================================
# Shared Secrets (from database)
# =============================================================================
{% if project_secrets is defined and project_secrets.secrets is defined and project_secrets.secrets.shared is defined %}
{% for key, value in project_secrets.secrets.shared.items() %}
{{ key }}={{ value }}
{% endfor %}
{% endif %}

# =============================================================================
# App-Specific Secrets (from database)
# =============================================================================
{% if project_secrets is defined and project_secrets[item.key] is defined and project_secrets[item.key] is not none %}
{% for key, value in project_secrets[item.key].items() %}
{{ key }}={{ value }}
{% endfor %}
{% endif %}

# =============================================================================
# Environment Aliases (from database)
# =============================================================================
{% if env_aliases is defined and env_aliases[item.key] is defined and env_aliases[item.key] is not none %}
{% for alias_key, alias_value in env_aliases[item.key].items() %}
{%   if alias_value is string and '.' in alias_value %}
{#     It's a reference to addon secret (e.g., postgres.primary.HOST) #}
{%     set alias_parts = alias_value.split('.') %}
{%     if alias_parts | length == 3 %}
{#       Format: addon_type.instance_name.credential (e.g., postgres.primary.HOST) #}
{%       set addon_type = alias_parts[0] %}
{%       set instance_name = alias_parts[1] %}
{%       set credential = alias_parts[2] %}
{%       if project_secrets.secrets is defined and project_secrets.secrets.addons is defined and project_secrets.secrets.addons[addon_type] is defined and project_secrets.secrets.addons[addon_type][instance_name] is defined and project_secrets.secrets.addons[addon_type][instance_name][credential] is defined %}
{{ alias_key }}={{ project_secrets.secrets.addons[addon_type][instance_name][credential] }}
{%       else %}
{{ alias_key }}=MISSING_{{ alias_value | replace('.', '_') }}
{%       endif %}
{%     elif project_secrets.secrets is defined and project_secrets.secrets.shared is defined and project_secrets.secrets.shared[alias_value] is defined %}
{#       Fallback: check in shared secrets #}
{{ alias_key }}={{ project_secrets.secrets.shared[alias_value] }}
{%     else %}
{{ alias_key }}=MISSING_{{ alias_value | replace('.', '_') }}
{%     endif %}
{%   else %}
{#     It's a static value #}
{{ alias_key }}={{ alias_value }}
{%   endif %}
{% endfor %}
{% endif %}
