---
# Configure project-level monitoring targets
# Adds application services to Prometheus scrape configuration
# Monitoring is ALWAYS enabled for all projects

- name: Validate monitoring configuration
  assert:
    that:
      - apps is defined
      - apps is mapping
    fail_msg: |
      [PROJECT-DEPLOYER] ERROR: Cannot setup monitoring without apps configuration
        - Expected: apps to be defined as a dictionary
        - Found: apps={{ apps | default('undefined') }}
        - Fix: Ensure database contains apps configuration
    quiet: true

- name: Build VM list with IPs for monitoring
  set_fact:
    # Use internal_ip for VPC peering (orchestrator → project VMs via 10.x.x.x)
    vm_monitoring_list: "{{ vm_monitoring_list | default([]) + [{'name': item, 'external_ip': hostvars[item].ansible_host, 'internal_ip': hostvars[item].internal_ip}] }}"
  loop: "{{ groups['all'] | reject('match', '.*orchestrator.*') | list }}"
  when: 
    - hostvars[item].ansible_host is defined
    - hostvars[item].internal_ip is defined

- name: Debug VM monitoring list
  debug:
    msg: "VM monitoring list: {{ vm_monitoring_list | default([]) }}"
    verbosity: 1

- name: Create monitoring targets directory on orchestrator
  file:
    path: "/opt/superdeploy/shared/monitoring/targets.d"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0755'
  delegate_to: "{{ groups['orchestrator'][0] }}"
  when: 
    - vm_monitoring_list is defined
    - vm_monitoring_list | length > 0

- name: Generate node exporter targets for file-based service discovery
  copy:
    content: |
      [
        {
          "targets": [
      {% for vm in vm_monitoring_list %}
            "{{ vm.internal_ip }}:9100"{{ "," if not loop.last else "" }}
      {% endfor %}
          ],
          "labels": {
            "project": "{{ project_name }}",
            "environment": "{{ project_config.environment | default('production') }}",
            "service": "node-exporter"
          }
        }
      ]
    dest: "/opt/superdeploy/shared/monitoring/targets.d/{{ project_name }}-nodes.json"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0644'
  delegate_to: "{{ groups['orchestrator'][0] }}"
  when: 
    - vm_monitoring_list is defined
    - vm_monitoring_list | length > 0

- name: Generate cAdvisor targets for file-based service discovery
  copy:
    content: |
      [
        {
          "targets": [
      {% for vm in vm_monitoring_list %}
            "{{ vm.internal_ip }}:8080"{{ "," if not loop.last else "" }}
      {% endfor %}
          ],
          "labels": {
            "project": "{{ project_name }}",
            "environment": "{{ project_config.environment | default('production') }}",
            "service": "cadvisor"
          }
        }
      ]
    dest: "/opt/superdeploy/shared/monitoring/targets.d/{{ project_name }}-cadvisor.json"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0644'
  delegate_to: "{{ groups['orchestrator'][0] }}"
  when: 
    - vm_monitoring_list is defined
    - vm_monitoring_list | length > 0

# App metrics targets - only if apps have ports defined
- name: Build app monitoring targets with app names
  set_fact:
    app_monitoring_targets: "{{ app_monitoring_targets | default([]) + [{'target': hostvars[groups[item.value.vm][0]].internal_ip + ':' + ((item.value.internal_port | default(item.value.port)) | string), 'app': item.key}] }}"
  loop: "{{ apps | dict2items }}"
  when: 
    - item.value.vm is defined
    - groups[item.value.vm] is defined
    - groups[item.value.vm] | length > 0
    - hostvars[groups[item.value.vm][0]].internal_ip is defined
    - (item.value.port is defined and item.value.port != None) or (item.value.internal_port is defined and item.value.internal_port != None)
    - (item.value.internal_port | default(item.value.port) | default(None)) != None

- name: Generate application metrics targets for file-based service discovery
  copy:
    content: |
      [
      {% for app_target in app_monitoring_targets %}
        {
          "targets": ["{{ app_target.target }}"],
          "labels": {
            "project": "{{ project_name }}",
            "environment": "{{ project_config.environment | default('production') }}",
            "service": "{{ app_target.app }}"
          }
        }{{ "," if not loop.last else "" }}
      {% endfor %}
      ]
    dest: "/opt/superdeploy/shared/monitoring/targets.d/{{ project_name }}-apps.json"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0644'
  delegate_to: "{{ groups['orchestrator'][0] }}"
  when: 
    - app_monitoring_targets is defined
    - app_monitoring_targets | length > 0

- name: Display monitoring integration status
  debug:
    msg: "✅ Monitoring targets created: {{ vm_monitoring_list | default([]) | length }} VMs, {{ app_monitoring_targets | default([]) | length }} apps"
