---
# Configure project-level monitoring targets
# Adds application services to Prometheus scrape configuration

- name: Check if monitoring is enabled
  debug:
    msg: "Monitoring is {{ 'enabled' if monitoring_enabled else 'disabled' }} for project {{ project_name }}"

- name: Skip monitoring setup if disabled
  debug:
    msg: "Skipping monitoring integration as it is disabled in project configuration"
  when: not monitoring_enabled

- name: Validate monitoring configuration
  assert:
    that:
      - apps is defined
      - apps is mapping
    fail_msg: |
      [PROJECT-DEPLOYER] ERROR: Cannot setup monitoring without apps configuration
        - Expected: apps to be defined as a dictionary
        - Found: apps={{ apps | default('undefined') }}
        - Fix: Ensure project.yml contains an 'apps' section
    quiet: true
  when: monitoring_enabled

- name: Build monitoring targets list
  set_fact:
    monitoring_targets: "{{ monitoring_targets | default([]) + [item.value.vm + '-' + item.key + ':' + ((item.value.internal_port | default(item.value.port)) | string)] }}"
  loop: "{{ apps | dict2items }}"
  when: 
    - monitoring_enabled
    - apps | length > 0
    - (item.value.port is defined or item.value.internal_port is defined)
    - item.value.vm is defined

- name: Build app metrics targets list (for /metrics endpoints)
  set_fact:
    app_metrics_targets: "{{ app_metrics_targets | default([]) + [project_name + '-' + item.key + ':' + ((item.value.internal_port | default(item.value.port)) | string)] }}"
  loop: "{{ apps | dict2items }}"
  when: 
    - monitoring_enabled
    - apps | length > 0
    - (item.value.port is defined or item.value.internal_port is defined)

- name: Display monitoring targets
  debug:
    msg: "Monitoring targets for {{ project_name }}: {{ monitoring_targets | default([]) | join(', ') }}"
    verbosity: 1
  when: monitoring_enabled

- name: Create monitoring configuration directory
  file:
    path: "{{ project_base_path }}/monitoring"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0755'
  when: 
    - monitoring_enabled
    - monitoring_targets is defined
    - monitoring_targets | length > 0

- name: Generate project monitoring configuration
  template:
    src: "monitoring-targets.yml.j2"
    dest: "{{ project_base_path }}/monitoring/targets.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0644'
  when: 
    - monitoring_enabled
    - monitoring_targets is defined
    - monitoring_targets | length > 0

- name: Register project with monitoring addon
  blockinfile:
    path: "/opt/superdeploy/shared/monitoring/projects.d/{{ project_name }}.yml"
    create: true
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0644'
    marker: "# {mark} ANSIBLE MANAGED BLOCK - {{ project_name }}"
    block: |
      # Project: {{ project_name }}
      # Generated by project-deployer role
      
      - name: {{ project_name }}
        environment: {{ project_config.environment | default('production') }}
        vm: {{ project_config.vms.core | default('core') }}
        host: localhost
        targets:
      {% for target in monitoring_targets %}
          - {{ target }}
      {% endfor %}
        node_exporter_enabled: true
        docker_metrics_enabled: true
        tags:
          - project:{{ project_name }}
      {% if project_config.tags is defined %}
      {% for tag in project_config.tags %}
          - {{ tag }}
      {% endfor %}
      {% endif %}
  when: 
    - monitoring_enabled
    - monitoring_targets is defined
    - monitoring_targets | length > 0
  notify: reload prometheus

- name: Display monitoring integration status
  debug:
    msg: "Monitoring integration completed for {{ project_name }} with {{ monitoring_targets | default([]) | length }} target(s)"
  when: 
    - monitoring_enabled
    - monitoring_targets is defined

- name: Skip monitoring integration
  debug:
    msg: "No monitoring targets to configure for {{ project_name }}"
  when: 
    - monitoring_enabled
    - (monitoring_targets is not defined or monitoring_targets | length == 0)
