---
# Project Deployer Role - Main Entry Point
# This role orchestrates the deployment of project-specific application services

- name: Validate required variables
  assert:
    that:
      - project_name is defined
      - project_config is defined
      - project_base_path is defined
    fail_msg: |
      [PROJECT-DEPLOYER] ERROR: Missing required variables
        - Expected: project_name, project_config, project_base_path
        - Found: project_name={{ project_name | default('undefined') }}, project_config={{ 'defined' if project_config is defined else 'undefined' }}, project_base_path={{ project_base_path | default('undefined') }}
        - Fix: Ensure these variables are passed to the project-deployer role
        - Docs: See shared/ansible/roles/orchestration/project-deployer/README.md
    quiet: true

- name: Set default values for optional variables
  set_fact:
    superdeploy_user: "{{ superdeploy_user | default('superdeploy') }}"
    superdeploy_group: "{{ superdeploy_group | default('superdeploy') }}"
    apps: "{{ project_config.apps | default({}) }}"
    network_subnet: "{{ project_config.network.docker_subnet | default('172.30.0.0/24') }}"
    monitoring_enabled: true  # Monitoring is always enabled

- name: Parse vm_apps from inventory (JSON string to list)
  set_fact:
    vm_apps_list: "{{ vm_apps | from_json if vm_apps is defined and vm_apps is string else (vm_apps if vm_apps is defined else []) }}"

- name: Filter apps for this VM only
  set_fact:
    apps_for_this_vm: "{{ apps | dict2items | selectattr('key', 'in', vm_apps_list) | items2dict }}"
  when: vm_apps_list | length > 0

- name: Set empty apps if no apps assigned to this VM
  set_fact:
    apps_for_this_vm: {}
  when: vm_apps_list | length == 0

- name: Display project deployment configuration
  debug:
    msg:
      - "Project: {{ project_name }}"
      - "Project base path: {{ project_base_path }}"
      - "VM Role: {{ vm_role | default('undefined') }}"
      - "VM Apps: {{ vm_apps_list | join(', ') if vm_apps_list | length > 0 else 'none' }}"
      - "Applications to deploy: {{ apps_for_this_vm.keys() | list | join(', ') if apps_for_this_vm | length > 0 else 'none (skipping)' }}"
      - "Network subnet: {{ network_subnet }}"
      - "Monitoring enabled: {{ monitoring_enabled }}"
    verbosity: 0

- name: Create project directory structure
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0755'
  loop:
    - "{{ project_base_path }}"
    - "{{ project_base_path }}/compose"
    - "{{ project_base_path }}/data"
    - "{{ project_base_path }}/logs"
    - "{{ project_base_path }}/backups"

- name: Create application-specific directories
  file:
    path: "{{ item[0] }}/{{ item[1].key }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0755'
  loop: "{{ [project_base_path + '/data', project_base_path + '/logs'] | product(apps_for_this_vm | dict2items) | list }}"
  when: apps_for_this_vm | length > 0

- name: Display directory structure created
  debug:
    msg: "Project directory structure created at {{ project_base_path }}"

- name: Copy config.yml to VM for deployment hooks
  copy:
    src: "{{ superdeploy_root }}/projects/{{ project_name }}/config.yml"
    dest: "{{ project_base_path }}/config.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0644'

# Generate docker-compose.yml for apps
- name: Generate docker-compose.yml for applications
  template:
    src: "docker-compose.apps.yml.j2"
    dest: "{{ project_base_path }}/compose/docker-compose.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group }}"
    mode: '0644'
  vars:
    apps: "{{ apps_for_this_vm }}"
  when: apps_for_this_vm | length > 0

# Monitoring integration (always enabled)
- name: Setup monitoring integration (runs once)
  include_tasks: setup-monitoring.yml
  vars:
    orchestrator_host: "{{ project_secrets.secrets.shared.ORCHESTRATOR_IP }}"
    apps: "{{ project_config.apps }}"  # FULL project apps, not filtered
  run_once: true
  when:
    - project_secrets is defined
    - project_secrets.secrets is defined
    - project_secrets.secrets.shared is defined
    - project_secrets.secrets.shared.ORCHESTRATOR_IP is defined
    - project_config is defined
    - project_config.apps is defined
