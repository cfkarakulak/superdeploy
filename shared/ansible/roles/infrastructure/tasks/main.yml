---
# ═══════════════════════════════════════════════════════════════════════════
# INFRASTRUCTURE DEPLOYMENT
# ═══════════════════════════════════════════════════════════════════════════
# 1. Deploy shared infrastructure (project-agnostic)
# 2. Deploy project-specific services (with proper separation)
# ═══════════════════════════════════════════════════════════════════════════

# =============================================================================
# SHARED INFRASTRUCTURE
# =============================================================================

- name: Create shared infrastructure directories
  file:
    path: "{{ item }}"
    state: directory
    owner: superdeploy
    group: superdeploy
    mode: '0755'
  loop:
    - /opt/superdeploy/shared
    - /opt/superdeploy/shared/compose
    - /opt/superdeploy/shared/prometheus/projects
    - /opt/superdeploy/shared/grafana/dashboards
    - /opt/superdeploy/shared/caddy/routes
    - /opt/superdeploy/shared/postgres/init.d

- name: Sync shared infrastructure compose files
  synchronize:
    src: "{{ playbook_dir }}/../../compose/"
    dest: /opt/superdeploy/shared/compose/
    delete: no
    recursive: yes
    rsync_opts:
      - "--exclude=.env*"
      - "--exclude=*.log"

- name: Fix ownership of shared infrastructure files
  file:
    path: /opt/superdeploy/shared/compose
    owner: superdeploy
    group: superdeploy
    recurse: yes

- name: Generate shared infrastructure .env file
  copy:
    content: |
      # Shared Infrastructure Environment (App-Agnostic)
      POSTGRES_USER={{ POSTGRES_USER }}
      POSTGRES_PASSWORD={{ POSTGRES_PASSWORD }}
      RABBITMQ_USER={{ RABBITMQ_USER }}
      RABBITMQ_PASSWORD={{ RABBITMQ_PASSWORD }}
      REDIS_PASSWORD={{ REDIS_PASSWORD }}
      GRAFANA_ADMIN_USER={{ GRAFANA_ADMIN_USER }}
      GRAFANA_ADMIN_PASSWORD={{ GRAFANA_ADMIN_PASSWORD }}
      CORE_EXTERNAL_IP={{ core_external_ip }}
      DOCKER_REGISTRY={{ DOCKER_REGISTRY }}
      DOCKER_ORG={{ DOCKER_ORG }}
    dest: /opt/superdeploy/shared/.env
    owner: superdeploy
    group: superdeploy
    mode: '0600'

- name: Start shared infrastructure services
  become_user: superdeploy
  shell: |
    cd /opt/superdeploy/shared/compose
    set -a
    source ../.env
    set +a
    docker compose -f docker-compose.infrastructure.yml up -d
  args:
    executable: /bin/bash

- name: Wait for shared infrastructure to be healthy
  pause:
    seconds: 30

# =============================================================================
# PROJECTS BASE (Project-agnostic)
# =============================================================================
# Note: Specific project deployment is handled via CLI commands
# Infrastructure only provides the base directory structure

- name: Create projects base directory
  file:
    path: /opt/superdeploy/projects
    state: directory
    owner: superdeploy
    group: superdeploy
    mode: '0755'

- name: Reload Caddy config (pick up new routes)
  shell: docker exec superdeploy-caddy caddy reload --config /etc/caddy/Caddyfile
  ignore_errors: yes

- name: Reload Prometheus config (pick up new targets)
  shell: curl -X POST http://localhost:9090/-/reload
  ignore_errors: yes

- name: Display running services
  become_user: superdeploy
  command: docker ps --format "table {% raw %}{{.Names}}\t{{.Status}}\t{{.Ports}}{% endraw %}"
  register: docker_ps_output

- name: Show infrastructure status
  debug:
    msg: "{{ docker_ps_output.stdout_lines }}"

- name: Success message
  debug:
    msg: |
      ✅ Infrastructure deployed successfully!
      
      SHARED SERVICES:
        - PostgreSQL (superdeploy-postgres)
        - RabbitMQ (superdeploy-rabbitmq)
        - Redis (superdeploy-redis)
        - Prometheus (superdeploy-prometheus) → http://{{ core_external_ip }}:9090
        - Grafana (superdeploy-grafana) → http://{{ core_external_ip }}:3000
        - Caddy (superdeploy-caddy)
      
      PROJECT: CHEAPA
        - Database: cheapa_db (initialized)
        - Vhost: cheapa (initialized)
        - Prometheus targets: provisioned
        - Caddy routes: provisioned
      
      Next: Push to GitHub → Forgejo will deploy app services
