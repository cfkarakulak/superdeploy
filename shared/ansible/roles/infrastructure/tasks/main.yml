---
# ═══════════════════════════════════════════════════════════════════════════
# INFRASTRUCTURE DEPLOYMENT
# ═══════════════════════════════════════════════════════════════════════════
# 1. Deploy shared infrastructure (project-agnostic)
# 2. Deploy project-specific services (with proper separation)
# ═══════════════════════════════════════════════════════════════════════════

# =============================================================================
# SHARED INFRASTRUCTURE
# =============================================================================

- name: Create shared infrastructure directories
  file:
    path: "{{ item }}"
    state: directory
    owner: superdeploy
    group: superdeploy
    mode: '0755'
  loop:
    - /opt/superdeploy/shared
    - /opt/superdeploy/shared/compose
    - /opt/superdeploy/shared/prometheus/projects
    - /opt/superdeploy/shared/grafana/dashboards
    - /opt/superdeploy/shared/caddy/routes
    - /opt/superdeploy/shared/postgres/init.d

- name: Sync shared infrastructure compose files
  synchronize:
    src: "{{ playbook_dir }}/../../compose/"
    dest: /opt/superdeploy/shared/compose/
    delete: no
    recursive: yes
    rsync_opts:
      - "--exclude=.env*"
      - "--exclude=*.log"

- name: Fix ownership of shared infrastructure files
  file:
    path: /opt/superdeploy/shared/compose
    owner: superdeploy
    group: superdeploy
    recurse: yes

- name: Generate shared infrastructure .env file
  copy:
    content: |
      # Shared Infrastructure Environment
      # ONLY for Monitoring (Prometheus/Grafana) + Proxy (Caddy)
      GRAFANA_ADMIN_USER={{ GRAFANA_ADMIN_USER }}
      GRAFANA_ADMIN_PASSWORD={{ GRAFANA_ADMIN_PASSWORD }}
      SMTP_USERNAME={{ SMTP_USERNAME }}
      SMTP_PASSWORD={{ SMTP_PASSWORD }}
      ALERT_EMAIL={{ ALERT_EMAIL }}
      CORE_EXTERNAL_IP={{ core_external_ip }}
    dest: /opt/superdeploy/shared/.env
    owner: superdeploy
    group: superdeploy
    mode: '0600'

- name: Start shared monitoring
  become_user: superdeploy
  shell: |
    cd /opt/superdeploy/shared/compose
    set -a
    source ../.env
    set +a
    docker compose -f docker-compose.monitoring.yml up -d
  args:
    executable: /bin/bash

- name: Start shared proxy
  become_user: superdeploy
  shell: |
    cd /opt/superdeploy/shared/compose
    set -a
    source ../.env
    set +a
    docker compose -f docker-compose.proxy.yml up -d
  args:
    executable: /bin/bash

- name: Wait for shared infrastructure to be healthy
  pause:
    seconds: 30

# =============================================================================
# PROJECTS BASE (Project-agnostic)
# =============================================================================
# Note: Specific project deployment is handled via CLI commands
# Infrastructure only provides the base directory structure

- name: Create projects base directory
  file:
    path: /opt/apps
    state: directory
    owner: superdeploy
    group: superdeploy
    mode: '0755'

- name: Create superdeploy projects directory
  file:
    path: /opt/superdeploy/projects
    state: directory
    owner: superdeploy
    group: superdeploy
    mode: '0755'

- name: Check if projects directory exists locally
  stat:
    path: "{{ playbook_dir }}/../../../projects"
  register: projects_dir
  delegate_to: localhost
  become: no

- name: Fail if projects directory doesn't exist
  fail:
    msg: "Projects directory not found at {{ playbook_dir }}/../../../projects - run 'superdeploy init' first!"
  when: not projects_dir.stat.exists

- name: Sync project files to VM (compose files only, no secrets)
  synchronize:
    src: "{{ playbook_dir }}/../../../projects/"
    dest: /opt/superdeploy/projects/
    delete: no
    recursive: yes
    rsync_opts:
      - "--exclude=.git*"
      - "--exclude=*.log"
      - "--exclude=.passwords.yml"
      - "--exclude=*.passwords.yml"
      - "--exclude=merged_environment_*.yml"
      - "--exclude=secrets.env"
      - "--exclude=.env"
      - "--exclude=data/"
  when: projects_dir.stat.exists

- name: Fix ownership of project files
  file:
    path: /opt/superdeploy/projects
    owner: superdeploy
    group: superdeploy
    recurse: yes

- name: Reload Caddy config (pick up new routes)
  shell: docker exec superdeploy-caddy caddy reload --config /etc/caddy/Caddyfile
  ignore_errors: yes

- name: Reload Prometheus config (pick up new targets)
  shell: curl -X POST http://localhost:9090/-/reload
  ignore_errors: yes

- name: Display running services
  become_user: superdeploy
  command: docker ps --format "table {% raw %}{{.Names}}\t{{.Status}}\t{{.Ports}}{% endraw %}"
  register: docker_ps_output

- name: Show infrastructure status
  debug:
    msg: "{{ docker_ps_output.stdout_lines }}"

- name: Success message
  debug:
    msg: |
      ✅ Shared infrastructure deployed successfully!
      
      MONITORING & PROXY (Shared):
        - Prometheus (superdeploy-prometheus) → http://{{ core_external_ip }}:9090
        - Grafana (superdeploy-grafana) → http://{{ core_external_ip }}:3000
        - Alertmanager (superdeploy-alertmanager) → http://{{ core_external_ip }}:9093
        - Caddy (superdeploy-caddy) → http://{{ core_external_ip }}
      
      PROJECT-SPECIFIC SERVICES:
        - Each project has its own: PostgreSQL, RabbitMQ, Redis, Forgejo
        - Deployed via project-specific docker-compose files
      
      Next: Deploy Forgejo → Push to GitHub → App deployment
