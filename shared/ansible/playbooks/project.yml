---
# Main playbook - Deploy entire superdeploy infrastructure
# 
# Usage:
#   # Deploy specific project (using dynamic inventory)
#   ansible-playbook -i inventories/dynamic.py playbooks/site.yml --limit project_cheapa
#   
#   # Deploy all projects
#   ansible-playbook -i inventories/dynamic.py playbooks/site.yml
#   
#   # Deploy with static inventory (legacy)
#   ansible-playbook -i inventories/dev.ini playbooks/site.yml
#
# Tag usage:
#   --tags system           : Setup base system (packages, users, directories)
#   --tags docker           : Install and configure Docker
#   --tags security         : Configure firewall and security hardening
#   --tags monitoring-agent : Install system monitoring agents
#   --tags addons           : Deploy infrastructure addons (databases, queues, etc)
#   --tags project          : Deploy project applications
#   No tags                 : Full deployment

# ============================================================================
# PHASE 1: System Foundation
# ============================================================================

- name: Setup Base System
  hosts: all:!orchestrator
  become: yes
  roles:
    - role: system/base
  tags:
    - system
    - system-base
    - foundation
  vars:
    # Skip firewall reconfiguration on orchestrator during project deployments
    skip_firewall_reset: "{{ 'orchestrator' in group_names and project_name is defined }}"
    # Pass full project config for addon port firewall configuration
    # Note: project_config from Python contains nested structure, extract raw_config
    full_project_config: "{{ project_config.project_config if (project_config is defined and project_config.project_config is defined) else {} }}"

- name: Install and Configure Docker
  hosts: all:!orchestrator
  become: yes
  roles:
    - role: system/docker
  tags:
    - system
    - docker
    - foundation

- name: Install Promtail Log Agent
  hosts: all:!orchestrator
  become: yes
  roles:
    - role: system/promtail
  tags:
    - system
    - promtail
    - foundation
  vars:
    orchestrator_ip: "{{ hostvars[groups['orchestrator'][0]]['ansible_host'] }}"

- name: Install System Monitoring Agent
  hosts: all:!orchestrator
  become: yes
  roles:
    - role: system/monitoring-agent
  tags:
    - system
    - monitoring-agent
    - project  # Also run during project deployments to ensure cAdvisor is always present
    - foundation

- name: Setup GitHub Runner on project VMs
  hosts: all:!orchestrator
  become: yes
  serial: 1  # Run one host at a time to avoid duplicate registrations
  tasks:
    - name: Parse vm_services if string (from inventory JSON)
      set_fact:
        parsed_vm_services: "{{ vm_services | from_json if vm_services is defined and vm_services is string else (vm_services if vm_services is defined else []) }}"
    
    - name: Check if this VM should have a runner
      set_fact:
        should_install_runner: "{{ (parsed_vm_services | select('in', ['postgres', 'rabbitmq', 'redis', 'mongodb', 'elasticsearch']) | list | length == 0) }}"
    
    - name: Debug runner installation decision
      debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "VM Role: {{ vm_role | default('undefined') }}"
          - "Parsed vm_services: {{ parsed_vm_services }}"
          - "Should install runner: {{ should_install_runner }}"
      when: should_install_runner is defined
    
    # Check and fix offline runners BEFORE deciding whether to install
    - name: Check if runner config exists (for offline detection)
      stat:
        path: /opt/github-runner/.runner
      register: runner_config_exists_check
    
    - name: Get runner status from GitHub API if config exists
      uri:
        url: "https://api.github.com/orgs/{{ github_org }}/actions/runners"
        method: GET
        headers:
          Authorization: "Bearer {{ project_secrets.secrets.shared['REPOSITORY_TOKEN'] }}"
          Accept: "application/vnd.github+json"
        status_code: 200
        return_content: yes
      register: github_runners_api_check
      when: runner_config_exists_check.stat.exists
      ignore_errors: yes
    
    - name: Check if this runner is offline in GitHub
      set_fact:
        runner_is_offline: "{{ (github_runners_api_check.json.runners | selectattr('name', 'equalto', inventory_hostname_short | default(inventory_hostname)) | list | first).status == 'offline' if github_runners_api_check.json is defined else false }}"
      when: 
        - runner_config_exists_check.stat.exists
        - github_runners_api_check.json is defined
    
    - name: Force reinstall if runner is offline
      set_fact:
        should_install_runner: true
      when:
        - runner_config_exists_check.stat.exists
        - runner_is_offline | default(false)
    
    - name: Install GitHub Runner
      include_role:
        name: system/github-runner
      when: should_install_runner | default(false)
  tags:
    - system
    - runner
    - foundation

# ============================================================================
# PHASE 2: Addon Deployment
# ============================================================================

- name: Ensure superdeploy data directory exists
  hosts: all:!orchestrator
  become: yes
  tasks:
    - name: Create superdeploy data directory
      file:
        path: /var/lib/superdeploy
        state: directory
        owner: "{{ superdeploy_user | default('superdeploy') }}"
        group: "{{ superdeploy_group | default('superdeploy') }}"
        mode: '0755'
    
    - name: Create project data directory
      file:
        path: "/var/lib/superdeploy/{{ project_name }}"
        state: directory
        owner: "{{ superdeploy_user | default('superdeploy') }}"
        group: "{{ superdeploy_group | default('superdeploy') }}"
        mode: '0755'
      when: project_name is defined
  tags:
    - addons
    - infrastructure

- name: Deploy Infrastructure Addons (Projects)
  hosts: all:!orchestrator
  become: yes
  roles:
    - role: orchestration/addon-deployer
      vars:
        project_name: "{{ project_name }}"
        project_config: "{{ project_config }}"
        addons_base_path: "/var/lib/superdeploy/{{ project_name }}/addons"
        # Pass vm_services directly - role will parse it
        # NO DEFAULT - fail fast if vm_services is not defined in inventory
        enabled_addons: "{{ vm_services }}"
        addon_configs: "{{ addon_configs }}"
        # NO DEFAULT - fail fast if project_secrets is not defined
        project_secrets: "{{ project_secrets }}"
        # Pass apps for proxy addons (Caddy needs this for routing)
        apps: "{{ project_config.apps }}"
        # Network configuration
        network_subnet: "{{ project_config.network.docker_subnet | default('172.30.0.0/24') }}"
  tags:
    - addons
    - infrastructure

# ============================================================================
# PHASE 3: Project Deployment
# ============================================================================

- name: Deploy Project Applications
  hosts: all:!orchestrator
  become: yes
  roles:
    - role: orchestration/project-deployer
      vars:
        project_name: "{{ project_name }}"
        project_config: "{{ project_config }}"
        project_base_path: "/opt/superdeploy/projects/{{ project_name }}"
        # NO DEFAULT - fail fast if apps not defined
        apps: "{{ project_config.apps }}"
        # NO DEFAULT - fail fast if network config missing
        network_subnet: "{{ project_config.network.docker_subnet }}"
  tags:
    - project
    - applications

# ============================================================================
# PHASE 4: Verification
# ============================================================================

- name: Verify deployment
  hosts: all:!orchestrator
  become: yes
  tasks:
    - name: Check Docker is running
      service:
        name: docker
        state: started
      register: docker_check
      failed_when: false
    
    - name: Display Docker status
      debug:
        msg: "Docker service: {{ 'running ✅' if docker_check.status.ActiveState == 'active' else 'not running ❌' }}"
    
    # GitHub Runner Health Check
    - name: Check if GitHub runner service exists
      stat:
        path: /etc/systemd/system/github-runner.service
      register: runner_service_file
    
    - name: Check GitHub runner service status
      systemd:
        name: github-runner
      register: runner_service
      when: runner_service_file.stat.exists
      failed_when: false
    
    - name: Display runner status
      debug:
        msg: "GitHub Runner: {{ 'running ✅' if (runner_service_file.stat.exists and runner_service.status.ActiveState == 'active') else 'not installed or not running' }}"
    
    - name: Check if project identifier exists
      stat:
        path: /opt/superdeploy/.project
      register: project_file
      when: runner_service_file.stat.exists
    
    - name: Read project identifier
      slurp:
        path: /opt/superdeploy/.project
      register: project_content
      when: 
        - runner_service_file.stat.exists
        - project_file.stat.exists
    
    - name: Display project identifier
      debug:
        msg: "Project ID: {{ (project_content.content | b64decode).strip() if project_content is defined and project_content.content is defined else 'not found' }}"
      when: runner_service_file.stat.exists
    
    # Project Structure Check
    - name: Check if project compose directory exists
      stat:
        path: "/opt/superdeploy/projects/{{ project_name }}/compose"
      register: compose_dir
      when: project_name is defined
    
    - name: Check if docker-compose file exists
      find:
        paths: "/opt/superdeploy/projects/{{ project_name }}/compose"
        patterns: "docker-compose*.yml"
      register: compose_files
      when: 
        - project_name is defined
        - compose_dir is defined
        - compose_dir.stat.exists
    
    - name: Display compose file status
      debug:
        msg: "Docker Compose files: {{ compose_files.matched | default(0) }} found"
      when: compose_files is defined
    
    # Container Health Check
    - name: Check running containers
      command: docker ps --format '{{"{{.Names}}"}}'
      register: running_containers
      changed_when: false
      failed_when: false
      when: 
        - project_name is defined
        - compose_dir is defined
        - compose_dir.stat.exists
    
    - name: Display running containers
      debug:
        msg: 
          - "Running containers:"
          - "{{ running_containers.stdout_lines | default(['none']) }}"
      when: running_containers is defined and running_containers.stdout_lines is defined
    
    # Container Health Status (detailed)
    - name: Get container health status
      shell: |
        docker ps --format 'table {{"{{.Names}}\t{{.Status}}\t{{.Ports}}"}}' | grep "{{ project_name }}" || echo "No containers"
      register: container_health
      changed_when: false
      failed_when: false
      when: 
        - project_name is defined
        - running_containers is defined
        - running_containers.stdout_lines is defined
        - running_containers.stdout_lines | length > 0
    
    - name: Display container health
      debug:
        msg: "{{ container_health.stdout_lines | default(['No project containers running']) }}"
      when: container_health is defined
    
    # Network Check
    - name: Check if project Docker network exists
      command: docker network inspect {{ project_name }}-network
      register: network_check
      changed_when: false
      failed_when: false
      when: project_name is defined
    
    - name: Display network status
      debug:
        msg: "Docker network '{{ project_name }}-network': {{ 'exists ✅' if network_check.rc == 0 else 'not found ❌' }}"
      when: 
        - project_name is defined
        - network_check is defined
    
    # Final Summary
    - name: Deployment verification summary
      debug:
        msg:
          - "========================================="
          - "DEPLOYMENT VERIFICATION SUMMARY"
          - "========================================="
          - "Host: {{ inventory_hostname }}"
          - "Project: {{ project_name | default('N/A') }}"
          - "VM Role: {{ vm_role | default('N/A') }}"
          - "Docker: {{ 'running ✅' if docker_check.status.ActiveState == 'active' else 'not running ❌' }}"
          - "GitHub Runner: {{ 'running ✅' if (runner_service_file.stat.exists and runner_service.status.ActiveState == 'active') else 'not running' }}"
          - "Compose Files: {{ compose_files.matched | default(0) }}"
          - "Containers: {{ running_containers.stdout_lines | default([]) | length }}"
          - "========================================="
  tags:
    - verify
    - health

