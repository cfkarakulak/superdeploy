---
# Main playbook - Deploy entire superdeploy infrastructure
# 
# Usage:
#   # Deploy specific project (using dynamic inventory)
#   ansible-playbook -i inventories/dynamic.py playbooks/site.yml --limit project_cheapa
#   
#   # Deploy all projects
#   ansible-playbook -i inventories/dynamic.py playbooks/site.yml
#   
#   # Deploy with static inventory (legacy)
#   ansible-playbook -i inventories/dev.ini playbooks/site.yml
#
# Tag usage:
#   --tags system           : Setup base system (packages, users, directories)
#   --tags docker           : Install and configure Docker
#   --tags security         : Configure firewall and security hardening
#   --tags monitoring-agent : Install system monitoring agents
#   --tags addons           : Deploy infrastructure addons (Forgejo, databases, etc)
#   --tags project          : Deploy project applications
#   No tags                 : Full deployment

# ============================================================================
# PHASE 1: System Foundation
# ============================================================================

- name: Setup Base System
  hosts: core
  become: yes
  roles:
    - role: system/base
  tags:
    - system
    - system-base
    - foundation

- name: Install and Configure Docker
  hosts: core
  become: yes
  roles:
    - role: system/docker
  tags:
    - system
    - docker
    - foundation

- name: Install System Monitoring Agent
  hosts: core
  become: yes
  roles:
    - role: system/monitoring-agent
  tags:
    - system
    - monitoring-agent
    - foundation

# ============================================================================
# PHASE 2: Addon Deployment
# ============================================================================

- name: Deploy Infrastructure Addons
  hosts: core
  become: yes
  roles:
    - role: orchestration/addon-deployer
      vars:
        project_name: "{{ project_name }}"
        project_config: "{{ project_config }}"
        addons_base_path: "/opt/superdeploy/projects/{{ project_name }}/addons"
        enabled_addons: "{{ project_config.addons.keys() | list if project_config.addons is defined else [] }}"
        addon_configs: "{{ project_config.addons | default({}) }}"
        project_secrets: "{{ project_secrets | default({}) }}"
  tags:
    - addons
    - infrastructure

# ============================================================================
# PHASE 3: Project Deployment
# ============================================================================

- name: Deploy Project Applications
  hosts: core
  become: yes
  roles:
    - role: orchestration/project-deployer
      vars:
        project_name: "{{ project_name }}"
        project_config: "{{ project_config }}"
        project_base_path: "/opt/superdeploy/projects/{{ project_name }}"
        apps: "{{ project_config.apps | default({}) }}"
        network_subnet: "{{ project_config.network.subnet | default('172.20.0.0/24') }}"
        monitoring_enabled: "{{ project_config.monitoring.enabled | default(false) }}"
  tags:
    - project
    - applications

# ============================================================================
# PHASE 4: Verification
# ============================================================================

- name: Verify deployment
  hosts: all
  become: yes
  tasks:
    - name: Check Docker is running
      service:
        name: docker
        state: started
      
    - name: Verify Docker Compose services
      command: docker compose ps
      args:
        chdir: /opt/superdeploy
      register: compose_status
      ignore_errors: yes
      
    - name: Display service status
      debug:
        var: compose_status.stdout_lines
  tags:
    - verify
    - health

