---
# Main playbook - Deploy entire superdeploy infrastructure
# 
# Usage:
#   # Deploy specific project (using dynamic inventory)
#   ansible-playbook -i inventories/dynamic.py playbooks/site.yml --limit project_cheapa
#   
#   # Deploy all projects
#   ansible-playbook -i inventories/dynamic.py playbooks/site.yml
#   
#   # Deploy with static inventory (legacy)
#   ansible-playbook -i inventories/dev.ini playbooks/site.yml
#
# Tag usage:
#   --tags system           : Setup base system (packages, users, directories)
#   --tags docker           : Install and configure Docker
#   --tags security         : Configure firewall and security hardening
#   --tags monitoring-agent : Install system monitoring agents
#   --tags addons           : Deploy infrastructure addons (Forgejo, databases, etc)
#   --tags project          : Deploy project applications
#   No tags                 : Full deployment

# ============================================================================
# PHASE 1: System Foundation
# ============================================================================

- name: Setup Base System
  hosts: "{{ 'all:!orchestrator' if project_name is defined and project_name != 'orchestrator' else 'all' }}"
  become: yes
  # PERFORMANCE: Run on all hosts in parallel
  strategy: mitogen_linear
  gather_facts: yes
  roles:
    - role: system/base
  tags:
    - system
    - system-base
    - foundation
  vars:
    # Skip firewall reconfiguration on orchestrator during project deployments
    skip_firewall_reset: "{{ 'orchestrator' in group_names and project_name is defined }}"

- name: Install and Configure Docker
  hosts: "{{ 'all:!orchestrator' if project_name is defined and project_name != 'orchestrator' else 'all' }}"
  become: yes
  roles:
    - role: system/docker
  tags:
    - system
    - docker
    - foundation

- name: Install System Monitoring Agent
  hosts: "{{ 'all:!orchestrator' if project_name is defined and project_name != 'orchestrator' else 'all' }}"
  become: yes
  roles:
    - role: system/monitoring-agent
  tags:
    - system
    - monitoring-agent
    - foundation

- name: Setup Forgejo Runner on project VMs
  hosts: all:!orchestrator
  become: yes
  serial: 1  # Run one host at a time to avoid duplicate registrations
  roles:
    - role: system/forgejo-runner
  tags:
    - system
    - runner
    - foundation

# ============================================================================
# PHASE 2: Addon Deployment
# ============================================================================

- name: Ensure superdeploy data directory exists
  hosts: all
  become: yes
  tasks:
    - name: Create superdeploy data directory
      file:
        path: /var/lib/superdeploy
        state: directory
        owner: "{{ superdeploy_user | default('superdeploy') }}"
        group: "{{ superdeploy_group | default('superdeploy') }}"
        mode: '0755'
    
    - name: Create project data directory
      file:
        path: "/var/lib/superdeploy/{{ project_name }}"
        state: directory
        owner: "{{ superdeploy_user | default('superdeploy') }}"
        group: "{{ superdeploy_group | default('superdeploy') }}"
        mode: '0755'
      when: project_name is defined
  tags:
    - addons
    - infrastructure

- name: Deploy Infrastructure Addons (Orchestrator)
  hosts: orchestrator
  become: yes
  # Skip orchestrator addon deployment during project deployments
  # Orchestrator should only be deployed via: superdeploy orchestrator up
  when: project_name is not defined or project_name == 'orchestrator'
  roles:
    - role: orchestration/addon-deployer
      vars:
        vm_role: orchestrator
        # Orchestrator always deploys: forgejo, postgres, prometheus, grafana
        enabled_addons: ['forgejo', 'postgres', 'prometheus', 'grafana']
  tags:
    - addons
    - infrastructure

- name: Deploy Infrastructure Addons (Projects)
  hosts: all:!orchestrator
  become: yes
  pre_tasks:
    - name: Parse vm_services from inventory (if string)
      set_fact:
        parsed_vm_services: "{{ vm_services | from_json }}"
      when: 
        - vm_services is defined
        - vm_services is string
      
    - name: Use vm_services as-is (if already list)
      set_fact:
        parsed_vm_services: "{{ vm_services }}"
      when: 
        - vm_services is defined
        - vm_services is not string
    
    - name: Set empty list if vm_services undefined
      set_fact:
        parsed_vm_services: []
      when: vm_services is not defined
      
    - name: Debug vm_services parsing for this host
      debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "VM Role: {{ vm_role | default('undefined') }}"
          - "Raw vm_services: {{ vm_services | default('undefined') }}"
          - "Parsed vm_services: {{ parsed_vm_services }}"
          - "Addons to deploy: {{ parsed_vm_services | join(', ') if parsed_vm_services | length > 0 else 'none' }}"
  roles:
    - role: orchestration/addon-deployer
      vars:
        project_name: "{{ project_name }}"
        project_config: "{{ project_config }}"
        addons_base_path: "/var/lib/superdeploy/{{ project_name }}/addons"
        # Use parsed vm_services (this is per-host variable)
        # NO DEFAULT - fail fast if undefined
        enabled_addons: "{{ enabled_addons | default(parsed_vm_services) }}"
        addon_configs: "{{ addon_configs }}"
        # NO DEFAULT - fail fast if secrets missing
        project_secrets: "{{ project_secrets }}"
  tags:
    - addons
    - infrastructure

# ============================================================================
# PHASE 3: Project Deployment
# ============================================================================

- name: Deploy Project Applications
  hosts: all:!orchestrator
  become: yes
  roles:
    - role: orchestration/project-deployer
      vars:
        project_name: "{{ project_name }}"
        project_config: "{{ project_config }}"
        project_base_path: "/opt/superdeploy/projects/{{ project_name }}"
        # NO DEFAULT - fail fast if apps not defined
        apps: "{{ project_config.apps }}"
        # NO DEFAULT - fail fast if network config missing
        network_subnet: "{{ project_config.network.docker_subnet }}"
        monitoring_enabled: true  # Monitoring is always enabled
  tags:
    - project
    - applications

# ============================================================================
# PHASE 4: Verification
# ============================================================================

- name: Verify deployment
  hosts: all
  become: yes
  tasks:
    - name: "▶ Verify deployment health"
      debug:
        msg: "Checking deployment health and status"
      run_once: true
      
    - name: ✓ Verify Docker service is running
      service:
        name: docker
        state: started
      register: docker_check
      changed_when: false
      failed_when: false
      
    - name: Verify project directory structure
      stat:
        path: "/opt/superdeploy/projects/{{ project_name }}"
      register: project_dir
      when: project_name is defined
      changed_when: false
      
    - name: List all running containers
      command: docker ps --format 'table {% raw %}{{.Names}}\t{{.Status}}\t{{.Ports}}{% endraw %}'
      register: all_containers
      changed_when: false
      failed_when: false
      
    - name: Display running containers
      debug:
        msg: "{{ all_containers.stdout_lines }}"
      when: 
        - all_containers is defined
        - all_containers.stdout_lines is defined
      
    - name: Verify application containers are running
      shell: |
        docker ps --filter "name={{ project_name }}-" --format '{% raw %}{{.Names}}\t{{.Status}}{% endraw %}' | wc -l
      register: app_containers_count
      when: project_name is defined
      changed_when: false
      
    - name: Display deployment verification summary
      debug:
        msg:
          - "✓ Docker service: Running"
          - "✓ Project directory: {{ 'Exists' if (project_dir is defined and project_dir.stat.exists) else 'N/A' }}"
          - "✓ Running containers: {{ (all_containers.stdout_lines | length - 1) if (all_containers is defined and all_containers.stdout_lines is defined) else '0' }}"
          - "✓ Project containers: {{ app_containers_count.stdout | default('0') | trim }}"
  tags:
    - verify
    - health

