---
# Orchestrator Playbook - Deploy orchestrator infrastructure
# 
# Usage:
#   ansible-playbook -i inventories/orchestrator.ini playbooks/orchestrator.yml
#
# This playbook deploys:
#   - Base system setup
#   - Docker
#   - Monitoring agent
#   - Forgejo (Git server)
#   - PostgreSQL (for Forgejo)
#   - Prometheus (metrics)
#   - Grafana (dashboards)

# ============================================================================
# PHASE 1: System Foundation
# ============================================================================

- name: Setup Base System
  hosts: orchestrator
  become: yes
  roles:
    - role: system/base
  tags:
    - system
    - system-base
    - foundation

- name: Install and Configure Docker
  hosts: orchestrator
  become: yes
  roles:
    - role: system/docker
  tags:
    - system
    - docker
    - foundation

- name: Install System Monitoring Agent
  hosts: orchestrator
  become: yes
  roles:
    - role: system/monitoring-agent
  tags:
    - system
    - monitoring-agent
    - foundation

# NOTE: Orchestrator does NOT need a runner!
# Runners are installed on project VMs (api, web, worker) for deployments.
# Orchestrator only hosts Forgejo (Git server) and workflows.

# ============================================================================
# PHASE 2: Addon Deployment
# ============================================================================

- name: Ensure superdeploy data directory exists
  hosts: orchestrator
  become: yes
  tasks:
    - name: Create superdeploy data directory
      file:
        path: /var/lib/superdeploy
        state: directory
        owner: "{{ superdeploy_user | default('superdeploy') }}"
        group: "{{ superdeploy_group | default('superdeploy') }}"
        mode: '0755'
    
    - name: Create orchestrator data directory
      file:
        path: "/var/lib/superdeploy/orchestrator"
        state: directory
        owner: "{{ superdeploy_user | default('superdeploy') }}"
        group: "{{ superdeploy_group | default('superdeploy') }}"
        mode: '0755'
  tags:
    - addons
    - infrastructure

- name: Deploy Orchestrator Addons
  hosts: orchestrator
  become: yes
  any_errors_fatal: true  # CRITICAL: Stop immediately if ANY addon fails!
  pre_tasks:
    - name: Validate enabled_addons is defined
      assert:
        that:
          - enabled_addons is defined
          - enabled_addons | length > 0
        fail_msg: |
          [ORCHESTRATOR] ERROR: enabled_addons not defined!
            - This must be passed from CLI via --extra-vars
            - Expected format: enabled_addons=['forgejo', 'monitoring']
            - Fix: Check orchestrator.py build_ansible_command() call
        quiet: false
  roles:
    - role: orchestration/addon-deployer
      vars:
        project_name: orchestrator
        vm_role: orchestrator
        # enabled_addons passed from CLI via --extra-vars (NO DEFAULT!)
  tags:
    - addons
    - infrastructure

# ============================================================================
# PHASE 3: Docker Watchdog (Auto-Recovery)
# ============================================================================

- name: Deploy Docker Watchdog
  hosts: orchestrator
  become: yes
  roles:
    - role: orchestration/docker-watchdog
      vars:
        superdeploy_user: "{{ superdeploy_user | default('superdeploy') }}"
        superdeploy_group: "{{ superdeploy_group | default('superdeploy') }}"
  tags:
    - watchdog
    - infrastructure

# ============================================================================
# PHASE 4: Verification
# ============================================================================

- name: Verify deployment
  hosts: orchestrator
  become: yes
  tasks:
    - name: Check Docker is running
      service:
        name: docker
        state: started
      
    - name: Check orchestrator containers
      command: docker ps --format '{% raw %}{{.Names}}{% endraw %}'
      register: containers
      changed_when: false
      
    - name: Display running containers
      debug:
        msg: "Running containers: {{ containers.stdout_lines }}"
  tags:
    - verify
    - health
