# =============================================================================
# Alertmanager Configuration
# =============================================================================
# Simple email notifications for all alerts

global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'noreply@superdeploy.io'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

# Alert routing
route:
  # Default receiver
  receiver: 'email-default'
  
  # Group alerts
  group_by: ['alertname', 'project', 'severity']
  group_wait: 10s
  group_interval: 5m
  repeat_interval: 4h
  
  # Route by severity
  routes:
    - match:
        severity: critical
      receiver: 'email-critical'
      continue: true
    
    - match:
        severity: warning
      receiver: 'email-warning'
      continue: true

# Receivers (email)
receivers:
  - name: 'email-default'
    email_configs:
      - to: '${ALERT_EMAIL}'
        headers:
          Subject: '[SuperDeploy] {{ .GroupLabels.alertname }}'
        html: |
          <h2>{{ .GroupLabels.alertname }}</h2>
          <p><b>Project:</b> {{ .GroupLabels.project }}</p>
          <p><b>Severity:</b> {{ .GroupLabels.severity }}</p>
          <p><b>Summary:</b> {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</p>
          <p><b>Description:</b> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><b>Time:</b> {{ .CommonAnnotations.timestamp }}</p>
  
  - name: 'email-critical'
    email_configs:
      - to: '${ALERT_EMAIL}'
        headers:
          Subject: 'üö® CRITICAL: {{ .GroupLabels.alertname }} - {{ .GroupLabels.project }}'
        html: |
          <h2 style="color:red;">üö® CRITICAL ALERT</h2>
          <p><b>Project:</b> {{ .GroupLabels.project }}</p>
          <p><b>Alert:</b> {{ .GroupLabels.alertname }}</p>
          <p><b>Summary:</b> {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</p>
          <p><b>Description:</b> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><b>Time:</b> {{ .CommonAnnotations.timestamp }}</p>
          <hr>
          <p><small>Immediate action required!</small></p>
  
  - name: 'email-warning'
    email_configs:
      - to: '${ALERT_EMAIL}'
        headers:
          Subject: '‚ö†Ô∏è WARNING: {{ .GroupLabels.alertname }} - {{ .GroupLabels.project }}'
        html: |
          <h2 style="color:orange;">‚ö†Ô∏è WARNING ALERT</h2>
          <p><b>Project:</b> {{ .GroupLabels.project }}</p>
          <p><b>Alert:</b> {{ .GroupLabels.alertname }}</p>
          <p><b>Summary:</b> {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</p>
          <p><b>Description:</b> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><b>Time:</b> {{ .CommonAnnotations.timestamp }}</p>

# Inhibition rules (prevent alert spam)
inhibit_rules:
  # If service is down, don't alert on CPU/memory
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: 'High.*'
    equal: ['project', 'job']

