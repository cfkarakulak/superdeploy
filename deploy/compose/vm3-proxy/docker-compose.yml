version: '3.8'

networks:
  superdeploy:
    driver: bridge

services:
  # Dante SOCKS5 Proxy
  dante:
    image: vimagick/dante
    container_name: superdeploy-dante
    restart: always
    environment:
      - PROXY_USER=${PROXY_USER}
      - PROXY_PASSWORD=${PROXY_PASSWORD}
    volumes:
      - ./danted.conf:/etc/danted.conf:ro
    networks:
      - superdeploy
    ports:
      - "1080:1080"  # SOCKS5
    cap_add:
      - NET_ADMIN
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "1080"]
      interval: 30s
      timeout: 10s
      retries: 3

  # TinyProxy HTTP Proxy (alternative/backup)
  tinyproxy:
    image: vimagick/tinyproxy
    container_name: superdeploy-tinyproxy
    restart: always
    environment:
      - PROXY_USER=${PROXY_USER}
      - PROXY_PASSWORD=${PROXY_PASSWORD}
    volumes:
      - ./tinyproxy.conf:/etc/tinyproxy/tinyproxy.conf:ro
    networks:
      - superdeploy
    ports:
      - "3128:3128"  # HTTP Proxy
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "3128"]
      interval: 30s
      timeout: 10s
      retries: 3

  # IP Monitor - Reports external IP to proxy registry
  ip_monitor:
    image: alpine:latest
    container_name: superdeploy-ip-monitor
    restart: always
    environment:
      - CORE_VM_IP=${CORE_VM_IP}
      - PROXY_REGISTRY_URL=${PROXY_REGISTRY_URL}
    networks:
      - superdeploy
    volumes:
      - ./monitor_ip.sh:/monitor_ip.sh:ro
    command: /bin/sh -c "while true; do /monitor_ip.sh; sleep 300; done"
    depends_on:
      - dante
      - tinyproxy

