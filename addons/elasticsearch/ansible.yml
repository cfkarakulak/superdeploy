---
# Elasticsearch Addon Deployment

- name: Create {{ addon_name }} directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/data"

- name: Stop and remove existing {{ addon_name }} containers (idempotent cleanup)
  community.docker.docker_compose_v2:
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: absent
    remove_orphans: true
  become_user: "{{ superdeploy_user }}"
  failed_when: false
  ignore_errors: true

- name: Force remove {{ addon_name }} container by name (1st attempt)
  shell: |
    docker rm -f {{ project_name }}-{{ addon_name }} 2>/dev/null || true
  become_user: "{{ superdeploy_user }}"
  changed_when: false
  ignore_errors: true

- name: Force remove all {{ addon_name }} related containers (2nd attempt)
  shell: |
    docker ps -aq --filter "name={{ project_name }}-{{ addon_name }}" | xargs -r docker rm -f 2>/dev/null || true
  become_user: "{{ superdeploy_user }}"
  changed_when: false
  ignore_errors: true

- name: Wait for container cleanup to complete
  pause:
    seconds: 2

- name: Verify {{ addon_name }} container is fully removed
  shell: |
    docker ps -a --filter "name={{ project_name }}-{{ addon_name }}" --format "{% raw %}{{.Names}}{% endraw %}"
  become_user: "{{ superdeploy_user }}"
  register: remaining_containers
  changed_when: false

- name: Force prune {{ addon_name }} container if still exists (final cleanup)
  shell: |
    docker rm -f $(docker ps -aq --filter "name={{ project_name }}-{{ addon_name }}") 2>/dev/null || true
    docker container prune -f --filter "label=com.docker.compose.project={{ project_name }}" 2>/dev/null || true
  become_user: "{{ superdeploy_user }}"
  when: remaining_containers.stdout != ""
  changed_when: false
  ignore_errors: true

- name: Final wait before starting {{ addon_name }}
  pause:
    seconds: 1

- name: Start {{ addon_name }} services (fresh deployment)
  community.docker.docker_compose_v2:
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: present
    pull: "always"
    recreate: "always"
    remove_orphans: true
  become_user: "{{ superdeploy_user }}"

- name: Wait for {{ addon_name }} to be ready
  wait_for:
    host: localhost
    port: 9200
    delay: 10
    timeout: 120
    state: started
