---
# Elasticsearch Addon Deployment

- name: Create {{ addon_name }} directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/data"

- name: Deploy {{ addon_name }} with intelligent cleanup
  shell: |
    set -e
    cd {{ addon_base_path }}/{{ addon_name }}
    
    # Phase 1: Stop via Docker Compose
    docker compose --project-name {{ project_name }}-{{ addon_name }} down --remove-orphans --timeout 30 2>&1 || true
    
    # Phase 2: Wait for Docker to process
    sleep 3
    
    # Phase 3: Nuclear cleanup - remove ANY remaining containers by ID
    CONTAINER_IDS=$(docker ps -aq --filter "name={{ project_name }}-{{ addon_name }}" 2>/dev/null || true)
    if [ -n "$CONTAINER_IDS" ]; then
      echo "Force removing remaining containers: $CONTAINER_IDS"
      echo "$CONTAINER_IDS" | xargs -r docker rm -f 2>&1 || true
      sleep 2
    fi
    
    # Phase 4: Clean Docker cache (containers only)
    docker container prune -f >/dev/null 2>&1 || true
    
    # Phase 5: Final wait for Docker daemon to update metadata
    sleep 3
    
    # Phase 6: Verify cleanup (fail if containers still exist)
    REMAINING=$(docker ps -aq --filter "name={{ project_name }}-{{ addon_name }}" 2>/dev/null | wc -l)
    if [ "$REMAINING" -gt 0 ]; then
      echo "ERROR: $REMAINING {{ addon_name }} containers still exist after cleanup!"
      docker ps -a --filter "name={{ project_name }}-{{ addon_name }}"
      exit 1
    fi
    
    echo "âœ“ Cleanup successful - ready to deploy"
  args:
    executable: /bin/bash
  become: yes
  register: elasticsearch_cleanup_result
  changed_when: false

- name: Start {{ addon_name }} services (with explicit project name)
  community.docker.docker_compose_v2:
    project_name: "{{ project_name }}-{{ addon_name }}"
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: present
    pull: "always"
    recreate: "always"
    remove_orphans: true
  become: yes

- name: Wait for {{ addon_name }} to be ready
  wait_for:
    host: localhost
    port: 9200
    delay: 10
    timeout: 120
    state: started
