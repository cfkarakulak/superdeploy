---
# Elasticsearch Addon Deployment

- name: Create {{ addon_name }} directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/data"

- name: Deploy {{ addon_name }} with intelligent cleanup
  shell:
    cmd: |
      set -e
      cd "${ADDON_BASE_PATH}/${ADDON_NAME}"
      
      echo "Starting cleanup for ${PROJECT_NAME}-${ADDON_NAME}..."
      
      # Phase 1: Stop via Docker Compose (graceful shutdown with remove)
      echo "Phase 1: Stopping containers via Docker Compose..."
      docker compose --project-name "${PROJECT_NAME}-${ADDON_NAME}" down --remove-orphans --volumes --timeout 30 2>&1 || true
      
      # Phase 2: Wait for Docker daemon to sync
      echo "Phase 2: Waiting for Docker daemon to sync..."
      sleep 2
      
      # Phase 3: Force remove any remaining containers by exact name or prefix
      echo "Phase 3: Force removing any remaining containers..."
      # Check both exact match (cheapa-ADDON) and prefix match (cheapa-ADDON-*)
      EXACT_CONTAINER=$(docker ps -aq --filter "name=^${PROJECT_NAME}-${ADDON_NAME}\$" 2>/dev/null || true)
      PREFIX_CONTAINERS=$(docker ps -aq --filter "name=${PROJECT_NAME}-${ADDON_NAME}-" 2>/dev/null || true)
      REMAINING_CONTAINERS=$(echo "$EXACT_CONTAINER $PREFIX_CONTAINERS" | tr -s ' ' | xargs)
      
      if [ -n "$REMAINING_CONTAINERS" ]; then
        echo "Found remaining containers, removing..."
        echo "$REMAINING_CONTAINERS" | xargs -r docker rm -f 2>&1 || true
        sleep 2
      fi
      
      # Phase 4: Final verification
      echo "Phase 4: Final verification..."
      EXACT_CHECK=$(docker ps -aq --filter "name=^${PROJECT_NAME}-${ADDON_NAME}\$" 2>/dev/null || true)
      PREFIX_CHECK=$(docker ps -aq --filter "name=${PROJECT_NAME}-${ADDON_NAME}-" 2>/dev/null || true)
      FINAL_CHECK=$(echo "$EXACT_CHECK $PREFIX_CHECK" | tr -s ' ' | xargs)
      
      if [ -n "$FINAL_CHECK" ]; then
        echo "⚠ WARNING: Some containers still exist:"
        docker ps -a | grep "${PROJECT_NAME}-${ADDON_NAME}" || true
        echo "Attempting final force removal..."
        echo "$FINAL_CHECK" | xargs -r docker rm -f 2>&1 || true
        sleep 2
      fi
      echo "Phase 3: Force removing any remaining containers..."
      
      
      echo "Phase 4: Final verification..."
      FINAL_CHECK=$(docker ps -aq --filter "name=${PROJECT_NAME}-${ADDON_NAME}-" 2>/dev/null || true)
      
      if [ -n "$FINAL_CHECK" ]; then
        echo "⚠ WARNING: Some containers still exist:"
        docker ps -a --filter "name=${PROJECT_NAME}-${ADDON_NAME}-"
        echo "Attempting final force removal..."
        echo "$FINAL_CHECK" | xargs -r docker rm -f 2>&1 || true
        sleep 2
      fi
      
      echo "✓ Cleanup completed - ready for deployment"
    executable: /bin/bash
  environment:
    PROJECT_NAME: "{{ project_name }}"
    ADDON_NAME: "{{ addon_name }}"
    ADDON_BASE_PATH: "{{ addon_base_path }}"
  become: yes
  register: elasticsearch_cleanup_result
  changed_when: false
- name: Start {{ addon_name }} services (with explicit project name)
  community.docker.docker_compose_v2:
    project_name: "{{ project_name }}-{{ addon_name }}"
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: present
    pull: "always"
    recreate: "always"
    remove_orphans: true
  become: yes

- name: Wait for {{ addon_name }} to be ready
  wait_for:
    host: localhost
    port: 9200
    delay: 10
    timeout: 120
    state: started
