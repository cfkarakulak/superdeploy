---
# Forgejo Addon Deployment Tasks
# This playbook deploys the Forgejo Git server with CI/CD capabilities

- name: "Set environment variables as facts"
  set_fact:
    "{{ item.key }}": "{{ item.value }}"
  loop: "{{ env_vars | dict2items }}"
  no_log: true

- name: "Create {{ addon_name }} directories"
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/data"
    - "{{ addon_base_path }}/{{ addon_name }}/postgres"
    - "{{ addon_base_path }}/{{ addon_name }}/runner"
    - "{{ addon_base_path }}/{{ addon_name }}/templates"

# Note: docker-compose.yml is already rendered by orchestration/addon-deployer/tasks/render-templates.yml
# This keeps the deployment logic clean and focused on service-specific tasks

- name: "Render {{ addon_name }} environment file"
  template:
    src: "{{ addon_path }}/templates/forgejo.env.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/.env"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0600'

- name: "Render {{ addon_name }} runner configuration"
  template:
    src: "{{ addon_path }}/templates/runner-config.yml.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/runner/config.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'

- name: "Deploy {{ addon_name }} services with intelligent cleanup"
  shell: |
    set -e
    cd {{ addon_base_path }}/{{ addon_name }}
    
    # Phase 1: Stop and remove via Docker Compose (proper way)
    docker compose --project-name orchestrator down --volumes --remove-orphans --timeout 30 2>&1 || true
    
    # Phase 2: Wait for Docker to process (CRITICAL!)
    sleep 3
    
    # Phase 3: Nuclear cleanup - remove ANY remaining forgejo containers by ID
    CONTAINER_IDS=$(docker ps -aq --filter name=orchestrator-forgejo 2>/dev/null || true)
    if [ -n "$CONTAINER_IDS" ]; then
      echo "Force removing remaining containers: $CONTAINER_IDS"
      echo "$CONTAINER_IDS" | xargs -r docker rm -f 2>&1 || true
      sleep 2
    fi
    
    # Phase 4: Clean Docker cache (containers only - preserve networks!)
    docker container prune -f >/dev/null 2>&1 || true
    
    # Phase 5: Final wait for Docker daemon to update metadata
    sleep 5
    
    # Phase 6: Verify cleanup (fail if containers still exist)
    REMAINING=$(docker ps -aq --filter name=orchestrator-forgejo 2>/dev/null | wc -l)
    if [ "$REMAINING" -gt 0 ]; then
      echo "ERROR: $REMAINING forgejo containers still exist after cleanup!"
      docker ps -a --filter name=orchestrator-forgejo
      exit 1
    fi
    
    # Phase 7: Deploy (guaranteed clean state)
    docker compose --project-name orchestrator up -d --pull always --force-recreate --remove-orphans --wait --wait-timeout 300
    
    echo "âœ“ Deployment successful"
  args:
    executable: /bin/bash
  become_user: "{{ superdeploy_user }}"
  register: forgejo_deploy_result
  retries: 2
  delay: 10
  until: forgejo_deploy_result.rc == 0

- name: "Wait for {{ addon_name }} database to be ready"
  shell: docker inspect -f '{{"{{"}}.State.Health.Status{{"}}"}}' orchestrator-forgejo-db
  register: db_health
  until: db_health.stdout == 'healthy'
  retries: 30
  delay: 2
  when: forgejo_deploy_result.changed
  changed_when: false

- name: "Wait for {{ addon_name }} to be ready"
  uri:
    url: "http://localhost:{{ env_vars.FORGEJO_PORT | default(3001) }}"
    status_code: 200
    timeout: 5
  register: forgejo_health_check
  until: forgejo_health_check.status == 200
  retries: 30
  delay: 5
  failed_when: false

- name: "Verify {{ addon_name }} is accessible"
  uri:
    url: "http://localhost:{{ env_vars.FORGEJO_PORT | default(3001) }}"
    status_code: 200
  register: forgejo_final_check
  failed_when: forgejo_final_check.status != 200

- name: "Display {{ addon_name }} deployment status"
  debug:
    msg: "Forgejo is now accessible at http://{{ env_vars.FORGEJO_DOMAIN | default('localhost') }}:{{ env_vars.FORGEJO_PORT | default(3001) }}"

- name: "Setup {{ addon_name }} admin and repository"
  include_tasks: "{{ addon_path }}/tasks/setup-admin.yml"
  when: env_vars.FORGEJO_ADMIN_USER is defined

- name: "Push SuperDeploy code to {{ addon_name }}"
  include_tasks: "{{ addon_path }}/tasks/push-code.yml"
  when:
    - FORGEJO_ORG is defined
    - FORGEJO_REPO is defined

- name: "Setup {{ addon_name }} secrets"
  include_tasks: "{{ addon_path }}/tasks/setup-secrets.yml"
  when:
    - FORGEJO_ORG is defined
    - FORGEJO_REPO is defined
