---
# Forgejo Addon Deployment Tasks
# This playbook deploys the Forgejo Git server with CI/CD capabilities

- name: "Set environment variables as facts"
  set_fact:
    "{{ item.key }}": "{{ item.value }}"
  loop: "{{ env_vars | dict2items }}"
  no_log: true

- name: "Create {{ addon_name }} directories"
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/data"
    - "{{ addon_base_path }}/{{ addon_name }}/postgres"
    - "{{ addon_base_path }}/{{ addon_name }}/runner"
    - "{{ addon_base_path }}/{{ addon_name }}/templates"

# Note: docker-compose.yml is already rendered by orchestration/addon-deployer/tasks/render-templates.yml
# This keeps the deployment logic clean and focused on service-specific tasks

- name: "Render {{ addon_name }} environment file"
  template:
    src: "{{ addon_path }}/templates/forgejo.env.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/.env"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0600'

- name: "Render {{ addon_name }} runner configuration"
  template:
    src: "{{ addon_path }}/templates/runner-config.yml.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/runner/config.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'

- name: "Deploy {{ addon_name }} services with intelligent cleanup"
  shell:
    cmd: |
      set -e
      cd "${ADDON_BASE_PATH}/${ADDON_NAME}"
      
      echo "Starting cleanup for ${PROJECT_NAME}-${ADDON_NAME}..."
      docker compose --project-name "${PROJECT_NAME}-${ADDON_NAME}" down --volumes --remove-orphans --timeout 30 2>&1 || true
      sleep 3
      
      # Cleanup ALL forgejo-related containers (forgejo, forgejo-db, forgejo-runner)
      for attempt in 1 2 3 4 5; do
        FOUND=0
        for pattern in "${PROJECT_NAME}-forgejo" "${PROJECT_NAME}-forgejo-db" "${PROJECT_NAME}-forgejo-runner"; do
          CONTAINER_IDS=$(docker ps -aq --filter "name=$pattern" 2>/dev/null || true)
          if [ -n "$CONTAINER_IDS" ]; then
            FOUND=1
            echo "Attempt $attempt: Removing $pattern containers: $CONTAINER_IDS"
            for cid in $CONTAINER_IDS; do
              docker kill "$cid" 2>&1 || true
              docker rm -f "$cid" 2>&1 || true
            done
          fi
        done
        
        if [ $FOUND -eq 0 ]; then
          echo "✓ All forgejo containers removed (attempt $attempt)"
          break
        fi
        
        sleep 2
        
        if [ $attempt -eq 5 ]; then
          echo "ERROR: Failed to remove all containers after 5 attempts"
          exit 1
        fi
      done
      
      docker container prune -f >/dev/null 2>&1 || true
      
      # Final verification
      REMAINING=$(docker ps -aq --filter "name=${PROJECT_NAME}-forgejo" 2>/dev/null | wc -l)
      if [ "$REMAINING" -gt 0 ]; then
        echo "ERROR: $REMAINING forgejo containers still exist after cleanup!"
        docker ps -a --filter "name=${PROJECT_NAME}-forgejo"
        exit 1
      fi
      
      echo "✓ Cleanup completed - ready for deployment"
      
      # Critical: Wait for Docker daemon to fully update its metadata
      echo "Waiting for Docker daemon to sync metadata..."
      sleep 5
    executable: /bin/bash
  environment:
    PROJECT_NAME: "{{ project_name }}"
    ADDON_NAME: "{{ addon_name }}"
    ADDON_BASE_PATH: "{{ addon_base_path }}"
  become_user: "{{ superdeploy_user }}"
  register: forgejo_cleanup_result
  changed_when: false

- name: "Start {{ addon_name }} services with docker compose"
  community.docker.docker_compose_v2:
    project_name: "{{ project_name }}-{{ addon_name }}"
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: present
    pull: "always"
    recreate: "always"
    remove_orphans: true
  become: yes
  register: forgejo_deploy_result

- name: "Wait for {{ addon_name }} database to be ready"
  shell: docker inspect -f '{{"{{"}}.State.Health.Status{{"}}"}}' orchestrator-forgejo-db
  register: db_health
  until: db_health.stdout == 'healthy'
  retries: 30
  delay: 2
  changed_when: false

- name: "Wait for {{ addon_name }} to be ready"
  uri:
    url: "http://localhost:{{ env_vars.FORGEJO_PORT | default(3001) }}"
    status_code: 200
    timeout: 5
  register: forgejo_health_check
  until: forgejo_health_check.status == 200
  retries: 30
  delay: 5
  failed_when: false

- name: "Verify {{ addon_name }} is accessible"
  uri:
    url: "http://localhost:{{ env_vars.FORGEJO_PORT | default(3001) }}"
    status_code: 200
  register: forgejo_final_check
  failed_when: forgejo_final_check.status != 200

- name: "Display {{ addon_name }} deployment status"
  debug:
    msg: "Forgejo is now accessible at http://{{ env_vars.FORGEJO_DOMAIN | default('localhost') }}:{{ env_vars.FORGEJO_PORT | default(3001) }}"

- name: "Setup {{ addon_name }} admin and repository"
  include_tasks: "{{ addon_path }}/tasks/setup-admin.yml"
  when: env_vars.FORGEJO_ADMIN_USER is defined

- name: "Push SuperDeploy code to {{ addon_name }}"
  include_tasks: "{{ addon_path }}/tasks/push-code.yml"
  when:
    - FORGEJO_ORG is defined
    - FORGEJO_REPO is defined

- name: "Setup {{ addon_name }} secrets"
  include_tasks: "{{ addon_path }}/tasks/setup-secrets.yml"
  when:
    - FORGEJO_ORG is defined
    - FORGEJO_REPO is defined
