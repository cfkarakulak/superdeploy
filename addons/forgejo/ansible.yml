---
# Forgejo Addon Deployment Tasks
# This playbook deploys the Forgejo Git server with CI/CD capabilities

- name: "Set environment variables as facts"
  set_fact:
    "{{ item.key }}": "{{ item.value }}"
  loop: "{{ env_vars | dict2items }}"
  no_log: true

- name: "Create {{ addon_name }} directories"
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/data"
    - "{{ addon_base_path }}/{{ addon_name }}/postgres"
    - "{{ addon_base_path }}/{{ addon_name }}/runner"
    - "{{ addon_base_path }}/{{ addon_name }}/templates"

# Note: docker-compose.yml is already rendered by orchestration/addon-deployer/tasks/render-templates.yml
# This keeps the deployment logic clean and focused on service-specific tasks

- name: "Render {{ addon_name }} environment file"
  template:
    src: "{{ addon_path }}/templates/forgejo.env.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/.env"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0600'

- name: "Render {{ addon_name }} runner configuration"
  template:
    src: "{{ addon_path }}/templates/runner-config.yml.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/runner/config.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'

- name: Stop existing services (with explicit project name)
  community.docker.docker_compose_v2:
    project_name: "orchestrator"
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: absent
    remove_orphans: true
  become_user: "{{ superdeploy_user }}"
  register: compose_down_result
  failed_when: false
  ignore_errors: true

- name: Wait for Docker to complete cleanup
  command: sleep 2
  changed_when: false

- name: Verify container removal and force cleanup if needed
  shell: |
    set -e
    # Forgejo has 3 containers
    NAMES=("orchestrator-forgejo" "orchestrator-forgejo-db" "orchestrator-forgejo-runner")
    
    # Force remove by name and ID
    for CNAME in "${NAMES[@]}"; do
      docker rm -f "$CNAME" 2>/dev/null || true
      docker ps -aq --filter "name=$CNAME" 2>/dev/null | xargs -r docker rm -f 2>/dev/null || true
    done
    
    # Clean Docker metadata cache
    docker container prune -f >/dev/null 2>&1 || true
    sleep 1
    
    # Final verification
    FAILED=""
    for CNAME in "${NAMES[@]}"; do
      if docker ps -aq --filter "name=$CNAME" 2>/dev/null | grep -q .; then
        FAILED="$FAILED $CNAME"
      fi
    done
    
    if [ -n "$FAILED" ]; then
      echo "FATAL: Containers still exist:$FAILED"
      docker ps -a
      exit 1
    fi
    
    echo "Container cleanup verified"
  args:
    executable: /bin/bash
  become_user: "{{ superdeploy_user }}"
  register: verify_cleanup
  changed_when: false
  failed_when: verify_cleanup.rc != 0

- name: "Deploy {{ addon_name }} services (with explicit project name)"
  community.docker.docker_compose_v2:
    project_name: "orchestrator"
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: present
    pull: "always"
    recreate: "always"
    remove_orphans: true
  become_user: "{{ superdeploy_user }}"
  register: forgejo_compose_result

- name: "Wait for {{ addon_name }} database to be ready"
  shell: docker inspect -f '{{"{{"}}.State.Health.Status{{"}}"}}' orchestrator-forgejo-db
  register: db_health
  until: db_health.stdout == 'healthy'
  retries: 30
  delay: 2
  when: forgejo_compose_result.changed
  changed_when: false

- name: "Wait for {{ addon_name }} to be ready"
  uri:
    url: "http://localhost:{{ env_vars.FORGEJO_PORT | default(3001) }}"
    status_code: 200
    timeout: 5
  register: forgejo_health_check
  until: forgejo_health_check.status == 200
  retries: 30
  delay: 5
  failed_when: false

- name: "Verify {{ addon_name }} is accessible"
  uri:
    url: "http://localhost:{{ env_vars.FORGEJO_PORT | default(3001) }}"
    status_code: 200
  register: forgejo_final_check
  failed_when: forgejo_final_check.status != 200

- name: "Display {{ addon_name }} deployment status"
  debug:
    msg: "Forgejo is now accessible at http://{{ env_vars.FORGEJO_DOMAIN | default('localhost') }}:{{ env_vars.FORGEJO_PORT | default(3001) }}"

- name: "Setup {{ addon_name }} admin and repository"
  include_tasks: "{{ addon_path }}/tasks/setup-admin.yml"
  when: env_vars.FORGEJO_ADMIN_USER is defined

- name: "Push SuperDeploy code to {{ addon_name }}"
  include_tasks: "{{ addon_path }}/tasks/push-code.yml"
  when:
    - FORGEJO_ORG is defined
    - FORGEJO_REPO is defined

- name: "Setup {{ addon_name }} secrets"
  include_tasks: "{{ addon_path }}/tasks/setup-secrets.yml"
  when:
    - FORGEJO_ORG is defined
    - FORGEJO_REPO is defined
