---
# Forgejo Addon Deployment Tasks
# This playbook deploys the Forgejo Git server with CI/CD capabilities

- name: "Set environment variables as facts"
  set_fact:
    "{{ item.key }}": "{{ item.value }}"
  loop: "{{ env_vars | dict2items }}"
  no_log: true

- name: "Create {{ addon_name }} directories"
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/data"
    - "{{ addon_base_path }}/{{ addon_name }}/postgres"
    - "{{ addon_base_path }}/{{ addon_name }}/runner"
    - "{{ addon_base_path }}/{{ addon_name }}/templates"

# Note: docker-compose.yml is already rendered by orchestration/addon-deployer/tasks/render-templates.yml
# This keeps the deployment logic clean and focused on service-specific tasks

- name: "Render {{ addon_name }} environment file"
  template:
    src: "{{ addon_path }}/templates/forgejo.env.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/.env"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0600'

- name: "Render {{ addon_name }} runner configuration"
  template:
    src: "{{ addon_path }}/templates/runner-config.yml.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/runner/config.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'

- name: "Force stop and remove ALL orchestrator-forgejo* containers"
  shell: |
    docker ps -a --filter "name=orchestrator-forgejo" --format "{% raw %}{{.Names}}{% endraw %}" | xargs -r docker rm -f 2>/dev/null || true
  ignore_errors: true

- name: "Stop existing {{ addon_name }} containers (if any)"
  community.docker.docker_compose_v2:
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: stopped
    remove_orphans: true
  become_user: "{{ superdeploy_user }}"
  ignore_errors: true

- name: "Remove existing {{ addon_name }} containers (if any)"
  community.docker.docker_compose_v2:
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: absent
    remove_orphans: true
  become_user: "{{ superdeploy_user }}"
  ignore_errors: true

- name: "Force remove {{ addon_name }} container by name (1st attempt)"
  shell: |
    docker rm -f orchestrator-{{ addon_name }} 2>/dev/null || true
    docker rm -f orchestrator-{{ addon_name }}-db 2>/dev/null || true
    docker rm -f orchestrator-{{ addon_name }}-runner 2>/dev/null || true
  changed_when: false
  ignore_errors: true

- name: "Force remove all {{ addon_name }} related containers (2nd attempt)"
  shell: |
    docker ps -aq --filter "name=orchestrator-forgejo" | xargs -r docker rm -f 2>/dev/null || true
  changed_when: false
  ignore_errors: true

- name: "Deploy {{ addon_name }} services"
  community.docker.docker_compose_v2:
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: present
    pull: "always"
    recreate: "always"
    remove_orphans: true
  become_user: "{{ superdeploy_user }}"
  register: forgejo_compose_result

- name: "Wait for {{ addon_name }} database to be ready"
  shell: docker inspect -f '{{"{{"}}.State.Health.Status{{"}}"}}' orchestrator-forgejo-db
  register: db_health
  until: db_health.stdout == 'healthy'
  retries: 30
  delay: 2
  when: forgejo_compose_result.changed
  changed_when: false

- name: "Wait for {{ addon_name }} to be ready"
  uri:
    url: "http://localhost:{{ env_vars.FORGEJO_PORT | default(3001) }}"
    status_code: 200
    timeout: 5
  register: forgejo_health_check
  until: forgejo_health_check.status == 200
  retries: 30
  delay: 5
  failed_when: false

- name: "Verify {{ addon_name }} is accessible"
  uri:
    url: "http://localhost:{{ env_vars.FORGEJO_PORT | default(3001) }}"
    status_code: 200
  register: forgejo_final_check
  failed_when: forgejo_final_check.status != 200

- name: "Display {{ addon_name }} deployment status"
  debug:
    msg: "Forgejo is now accessible at http://{{ env_vars.FORGEJO_DOMAIN | default('localhost') }}:{{ env_vars.FORGEJO_PORT | default(3001) }}"

- name: "Setup {{ addon_name }} admin and repository"
  include_tasks: "{{ addon_path }}/tasks/setup-admin.yml"
  when: env_vars.FORGEJO_ADMIN_USER is defined

- name: "Push SuperDeploy code to {{ addon_name }}"
  include_tasks: "{{ addon_path }}/tasks/push-code.yml"
  when:
    - FORGEJO_ORG is defined
    - FORGEJO_REPO is defined

- name: "Setup {{ addon_name }} secrets"
  include_tasks: "{{ addon_path }}/tasks/setup-secrets.yml"
  when:
    - FORGEJO_ORG is defined
    - FORGEJO_REPO is defined
