---
# Forgejo Actions Runner Setup Tasks
# Installs and configures Forgejo Actions runner with Node.js and age encryption

- name: Check if Node.js is installed
  command: node --version
  register: node_check
  failed_when: false
  changed_when: false

- name: Install Node.js (if not present)
  block:
    - name: Download Node.js setup script
      get_url:
        url: https://deb.nodesource.com/setup_20.x
        dest: /tmp/nodesource_setup.sh
        mode: '0755'
      when: node_check.rc != 0

    - name: Run Node.js setup script
      command: bash /tmp/nodesource_setup.sh
      when: node_check.rc != 0

    - name: Install Node.js package
      apt:
        name: nodejs
        state: present
        update_cache: yes
      when: node_check.rc != 0
  when: ansible_os_family == "Debian"

- name: Check if age is installed
  command: age --version
  register: age_check
  failed_when: false
  changed_when: false

- name: Install age encryption tool
  block:
    - name: Download age binary
      get_url:
        url: "https://github.com/FiloSottile/age/releases/download/v1.1.1/age-v1.1.1-linux-amd64.tar.gz"
        dest: /tmp/age.tar.gz
        mode: '0644'

    - name: Extract age binary
      unarchive:
        src: /tmp/age.tar.gz
        dest: /tmp/
        remote_src: yes

    - name: Install age binary
      copy:
        src: /tmp/age/age
        dest: /usr/local/bin/age
        mode: '0755'
        remote_src: yes

    - name: Install age-keygen binary
      copy:
        src: /tmp/age/age-keygen
        dest: /usr/local/bin/age-keygen
        mode: '0755'
        remote_src: yes
  when: age_check.rc != 0

- name: Create age key directory
  file:
    path: /opt/forgejo-runner/.age
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0700'

- name: Check if age key already exists
  stat:
    path: /opt/forgejo-runner/.age/key.txt
  register: age_key_check
  become_user: "{{ superdeploy_user }}"

- name: Remove old age key if exists (to regenerate)
  file:
    path: /opt/forgejo-runner/.age/key.txt
    state: absent
  when: 
    - age_key_check.stat.exists
    - age_key_check.stat.size == 0 or age_key_check.stat.mode != '0600'
  become_user: "{{ superdeploy_user }}"

- name: Generate age encryption key
  shell: age-keygen -o /opt/forgejo-runner/.age/key.txt 2>&1
  args:
    creates: /opt/forgejo-runner/.age/key.txt
  become_user: "{{ superdeploy_user }}"
  register: age_keygen_result

- name: Set age key file permissions
  file:
    path: /opt/forgejo-runner/.age/key.txt
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0600'

- name: Display age public key
  shell: cat /opt/forgejo-runner/.age/key.txt | grep "public key:"
  register: age_public_key_output
  changed_when: false
  become_user: "{{ superdeploy_user }}"

- name: Show age public key for GitHub secrets
  debug:
    msg:
      - "=== AGE Encryption Setup ==="
      - "Public Key (add to GitHub Secrets as AGE_PUBLIC_KEY):"
      - "{{ age_public_key_output.stdout }}"
      - "Private Key Location: /opt/forgejo-runner/.age/key.txt"
  when: age_keygen_result is changed

- name: Check if Forgejo runner is already installed
  stat:
    path: /usr/local/bin/forgejo-runner
  register: runner_binary_check

- name: Download Forgejo Actions runner
  get_url:
    url: "https://code.forgejo.org/forgejo/runner/releases/download/v3.5.0/forgejo-runner-3.5.0-linux-amd64"
    dest: /usr/local/bin/forgejo-runner
    mode: '0755'
  when: not runner_binary_check.stat.exists

- name: Create runner working directory
  file:
    path: "{{ addon_base_path }}/{{ addon_name }}/runner"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'

- name: Get Forgejo container IP
  shell: docker inspect {{ project_name }}-forgejo --format '{{"{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}"}}'
  register: forgejo_ip_result
  changed_when: false

- name: Add Forgejo hostname to /etc/hosts
  lineinfile:
    path: /etc/hosts
    line: "{{ forgejo_ip_result.stdout }} {{ project_name }}-forgejo"
    state: present
  become: yes

- name: Check if runner is already registered
  stat:
    path: "{{ addon_base_path }}/{{ addon_name }}/runner/.runner"
  register: runner_registration_check

- name: Wait for repository API to be ready
  uri:
    url: "http://{{ FORGEJO_DOMAIN }}:{{ FORGEJO_PORT }}/api/v1/repos/{{ FORGEJO_ADMIN_USER }}/{{ FORGEJO_REPO }}"
    status_code: 200
    timeout: 5
  register: repo_ready
  until: repo_ready.status == 200
  retries: 6
  delay: 1
  failed_when: false
  when: not runner_registration_check.stat.exists

- name: Generate runner registration token via Forgejo CLI
  command: docker exec -u 1000:1000 {{ project_name }}-forgejo forgejo actions generate-runner-token
  register: runner_token_cli_result
  when: not runner_registration_check.stat.exists
  changed_when: false

- name: Set runner token fact
  set_fact:
    runner_token: "{{ runner_token_cli_result.stdout | trim }}"
  when: 
    - not runner_registration_check.stat.exists
    - runner_token_cli_result is defined
    - runner_token_cli_result.stdout is defined

- name: Register Forgejo Actions runner
  command: >
    forgejo-runner register
    --no-interactive
    --instance "http://{{ forgejo_ip_result.stdout }}:3000"
    --token "{{ runner_token }}"
    --name "{{ runner_name | default(project_name + '-runner') }}"
    --labels "{{ runner_labels | default('ubuntu-latest:docker://node:20-bookworm,ubuntu-22.04:docker://node:20-bookworm') }}"
  args:
    chdir: "{{ addon_base_path }}/{{ addon_name }}/runner"
  become_user: "{{ superdeploy_user }}"
  when: 
    - not runner_registration_check.stat.exists
    - runner_token is defined
  register: runner_register_result
  async: 60
  poll: 5

- name: Update runner address to use container hostname
  shell: |
    sed -i 's|http://{{ forgejo_ip_result.stdout }}:3000|http://{{ project_name }}-forgejo:3000|g' {{ addon_base_path }}/{{ addon_name }}/runner/.runner
  when: runner_register_result is changed
  become_user: "{{ superdeploy_user }}"

- name: Display runner registration result
  debug:
    msg: "{{ 'Runner registered successfully' if (runner_register_result is defined and runner_register_result.changed) else ('Runner already registered' if runner_registration_check.stat.exists else 'Runner registration skipped (token not available)') }}"

- name: Create runner systemd service file
  template:
    src: "{{ addon_path }}/tasks/forgejo-runner.service.j2"
    dest: /etc/systemd/system/forgejo-runner.service
    mode: '0644'
  become: yes

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  become: yes

- name: Enable and start Forgejo runner service
  systemd:
    name: forgejo-runner
    enabled: yes
    state: started
  become: yes

- name: Wait for runner service to be active
  shell: systemctl is-active forgejo-runner
  register: runner_active
  until: runner_active.rc == 0
  retries: 10
  delay: 2
  changed_when: false
  failed_when: false

- name: Check runner status
  systemd:
    name: forgejo-runner
    state: started
  register: runner_status

- name: Display runner setup summary
  debug:
    msg:
      - "Forgejo Actions runner setup completed!"
      - "Runner Name: {{ runner_name | default(project_name + '-runner') }}"
      - "Runner Labels: {{ runner_labels | default('ubuntu-latest:docker://node:20-bookworm') }}"
      - "Service Status: {{ runner_status.status.ActiveState }}"
      - "Working Directory: {{ addon_base_path }}/{{ addon_name }}/runner"
