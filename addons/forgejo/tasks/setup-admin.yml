---
# Forgejo Admin Setup Tasks
# Creates admin user and organization/repository using Forgejo API

- name: Wait for Forgejo API to be fully ready
  uri:
    url: "http://localhost:{{ FORGEJO_PORT }}/api/v1/version"
    status_code: 200
    timeout: 5
  register: api_check
  until: api_check.status == 200
  retries: 20
  delay: 3

- name: Create admin user via Forgejo CLI
  shell: |
    docker exec -u 1000:1000 orchestrator-forgejo \
      forgejo admin user create \
      --username "{{ FORGEJO_ADMIN_USER }}" \
      --password "{{ FORGEJO_ADMIN_PASSWORD }}" \
      --email "{{ FORGEJO_ADMIN_EMAIL }}" \
      --admin \
      --must-change-password=false 2>&1
  register: admin_create_result
  failed_when: 
    - admin_create_result.rc != 0
    - "'already exists' not in admin_create_result.stdout"
    - "'is reserved' not in admin_create_result.stdout"
    - "'already exists' not in admin_create_result.stderr"
    - "'is reserved' not in admin_create_result.stderr"
  changed_when: 
    - admin_create_result.rc == 0
    - "'already exists' not in admin_create_result.stdout"
    - "'already exists' not in admin_create_result.stderr"

- name: Display admin user creation result
  debug:
    msg: "Admin user '{{ FORGEJO_ADMIN_USER }}' {{ 'created successfully' if admin_create_result.changed else 'already exists' }}"

- name: Create repository under user
  uri:
    url: "http://localhost:{{ FORGEJO_PORT }}/api/v1/user/repos"
    method: POST
    user: "{{ FORGEJO_ADMIN_USER }}"
    password: "{{ FORGEJO_ADMIN_PASSWORD }}"
    force_basic_auth: yes
    body_format: json
    body:
      name: "{{ FORGEJO_REPO }}"
      description: "Repository for {{ project_name }} project"
      private: true
      auto_init: false
      default_branch: "master"
    status_code: [201, 409, 422]
    timeout: 10
  register: repo_create_result
  failed_when: false

- name: Display repository creation result
  debug:
    msg: "Repository '{{ FORGEJO_ADMIN_USER }}/{{ FORGEJO_REPO }}' {{ 'created successfully' if repo_create_result.status == 201 else 'already exists' }}"

- name: Enable Actions for repository
  uri:
    url: "http://localhost:{{ FORGEJO_PORT }}/api/v1/repos/{{ FORGEJO_ORG }}/{{ FORGEJO_REPO }}"
    method: PATCH
    user: "{{ FORGEJO_ADMIN_USER }}"
    password: "{{ FORGEJO_ADMIN_PASSWORD }}"
    force_basic_auth: yes
    body_format: json
    body:
      has_actions: true
    status_code: [200, 422]
    timeout: 10
  register: actions_enable_result
  failed_when: false

- name: Display Forgejo setup summary
  debug:
    msg:
      - "Forgejo setup completed successfully!"
      - "Admin User: {{ FORGEJO_ADMIN_USER }}"
      - "Repository: {{ FORGEJO_ADMIN_USER }}/{{ FORGEJO_REPO }}"
      - "Web URL: http://{{ FORGEJO_DOMAIN }}:{{ FORGEJO_PORT }}"
      - "Git Clone: http://{{ FORGEJO_DOMAIN }}:{{ FORGEJO_PORT }}/{{ FORGEJO_ADMIN_USER }}/{{ FORGEJO_REPO }}.git"

- name: Create Personal Access Token (PAT) for CI/CD
  uri:
    url: "http://localhost:{{ FORGEJO_PORT }}/api/v1/users/{{ FORGEJO_ADMIN_USER }}/tokens"
    method: POST
    user: "{{ FORGEJO_ADMIN_USER }}"
    password: "{{ FORGEJO_ADMIN_PASSWORD }}"
    force_basic_auth: yes
    body_format: json
    body:
      name: "superdeploy-cicd-{{ ansible_date_time.epoch }}"
      scopes:
        - write:activitypub
        - write:admin
        - write:issue
        - write:misc
        - write:notification
        - write:organization
        - write:package
        - write:repository
        - write:user
    status_code: [201, 422]
    timeout: 10
  register: pat_create_result
  failed_when: false
  no_log: true

- name: Save PAT to local orchestrator .env
  lineinfile:
    path: "{{ superdeploy_root }}/shared/orchestrator/.env"
    regexp: '^FORGEJO_PAT='
    line: "FORGEJO_PAT={{ pat_create_result.json.sha1 }}"
    create: no
    mode: '0600'
  when: pat_create_result.status == 201
  delegate_to: localhost
  become: no

- name: Display PAT creation result
  debug:
    msg: "{{ 'Personal Access Token created and saved to local .env' if pat_create_result.status == 201 else 'PAT already exists or creation skipped' }}"
