---
# Forgejo Secrets Setup Tasks
# Adds repository secrets for CI/CD workflows using Forgejo API

- name: Wait for Forgejo API to be ready
  uri:
    url: "http://localhost:{{ FORGEJO_PORT }}/api/v1/version"
    status_code: 200
    timeout: 5
  register: api_check
  until: api_check.status == 200
  retries: 10
  delay: 3

- name: Define secrets to be added
  set_fact:
    forgejo_secrets:
      - name: DOCKER_USERNAME
        value: "{{ DOCKER_USERNAME | default('') }}"
        description: "Docker Hub username for image push"
      - name: DOCKER_TOKEN
        value: "{{ DOCKER_TOKEN | default('') }}"
        description: "Docker Hub access token"
      - name: FORGEJO_ADMIN_USER
        value: "{{ FORGEJO_ADMIN_USER }}"
        description: "Forgejo admin username"
      - name: FORGEJO_ADMIN_PASSWORD
        value: "{{ FORGEJO_ADMIN_PASSWORD }}"
        description: "Forgejo admin password"
      - name: FORGEJO_ORG
        value: "{{ FORGEJO_ORG }}"
        description: "Forgejo organization name"
      - name: FORGEJO_REPO
        value: "{{ FORGEJO_REPO }}"
        description: "Forgejo repository name"
      - name: PROJECT_NAME
        value: "{{ project_name }}"
        description: "Project name"
      - name: CORE_EXTERNAL_IP
        value: "{{ FORGEJO_EXTERNAL_IP }}"
        description: "External IP address of core server"

- name: Check existing secrets
  uri:
    url: "http://localhost:{{ FORGEJO_PORT }}/api/v1/repos/{{ FORGEJO_ORG }}/{{ FORGEJO_REPO }}/actions/secrets"
    method: GET
    user: "{{ FORGEJO_ADMIN_USER }}"
    password: "{{ FORGEJO_ADMIN_PASSWORD }}"
    force_basic_auth: yes
    status_code: [200, 404]
    timeout: 10
  register: existing_secrets_check
  failed_when: false

- name: Extract existing secret names
  set_fact:
    existing_secret_names: "{{ existing_secrets_check.json | default([]) | map(attribute='name') | list }}"
  when: existing_secrets_check.status == 200

- name: Set empty list if no existing secrets
  set_fact:
    existing_secret_names: []
  when: existing_secrets_check.status != 200

- name: Add or update repository secrets
  uri:
    url: "http://localhost:{{ FORGEJO_PORT }}/api/v1/repos/{{ FORGEJO_ORG }}/{{ FORGEJO_REPO }}/actions/secrets/{{ item.name }}"
    method: PUT
    user: "{{ FORGEJO_ADMIN_USER }}"
    password: "{{ FORGEJO_ADMIN_PASSWORD }}"
    force_basic_auth: yes
    body_format: json
    body:
      data: "{{ item.value }}"
    status_code: [201, 204]
    timeout: 10
  loop: "{{ forgejo_secrets }}"
  when: item.value != ""
  register: secret_add_result
  no_log: true

- name: Count secrets added
  set_fact:
    secrets_added: "{{ forgejo_secrets | selectattr('value', 'ne', '') | list | length }}"

- name: Display secrets setup summary
  debug:
    msg:
      - "Forgejo secrets setup completed!"
      - "Repository: {{ FORGEJO_ORG }}/{{ FORGEJO_REPO }}"
      - "Secrets configured: {{ secrets_added }}"
      - "Available secrets:"
      - "  - DOCKER_USERNAME (Docker Hub authentication)"
      - "  - DOCKER_TOKEN (Docker Hub authentication)"
      - "  - FORGEJO_ADMIN_USER (Forgejo admin credentials)"
      - "  - FORGEJO_ADMIN_PASSWORD (Forgejo admin credentials)"
      - "  - FORGEJO_ORG (Organization name)"
      - "  - FORGEJO_REPO (Repository name)"
      - "  - PROJECT_NAME (Project identifier)"
      - "  - CORE_EXTERNAL_IP (External IP for deployments)"

- name: Add organization-level secrets (if needed)
  block:
    - name: Check if organization secrets endpoint is available
      uri:
        url: "http://localhost:{{ FORGEJO_PORT }}/api/v1/orgs/{{ FORGEJO_ORG }}/actions/secrets"
        method: GET
        user: "{{ FORGEJO_ADMIN_USER }}"
        password: "{{ FORGEJO_ADMIN_PASSWORD }}"
        force_basic_auth: yes
        status_code: [200, 404]
        timeout: 10
      register: org_secrets_check
      failed_when: false

    - name: Add organization-level Docker credentials
      uri:
        url: "http://localhost:{{ FORGEJO_PORT }}/api/v1/orgs/{{ FORGEJO_ORG }}/actions/secrets/{{ item.name }}"
        method: PUT
        user: "{{ FORGEJO_ADMIN_USER }}"
        password: "{{ FORGEJO_ADMIN_PASSWORD }}"
        force_basic_auth: yes
        body_format: json
        body:
          data: "{{ item.value }}"
        status_code: [201, 204, 404]
        timeout: 10
      loop:
        - name: DOCKER_USERNAME
          value: "{{ DOCKER_USERNAME | default('') }}"
        - name: DOCKER_TOKEN
          value: "{{ DOCKER_TOKEN | default('') }}"
      when: 
        - org_secrets_check.status == 200
        - item.value != ""
      register: org_secret_add_result
      no_log: true
      failed_when: false
  when: DOCKER_USERNAME is defined and DOCKER_TOKEN is defined

- name: Verify secrets are accessible
  uri:
    url: "http://localhost:{{ FORGEJO_PORT }}/api/v1/repos/{{ FORGEJO_ORG }}/{{ FORGEJO_REPO }}/actions/secrets"
    method: GET
    user: "{{ FORGEJO_ADMIN_USER }}"
    password: "{{ FORGEJO_ADMIN_PASSWORD }}"
    force_basic_auth: yes
    status_code: 200
    timeout: 10
  register: final_secrets_check

- name: Display final secret count
  debug:
    msg: "Total secrets configured in repository: {{ final_secrets_check.json | length }}"
