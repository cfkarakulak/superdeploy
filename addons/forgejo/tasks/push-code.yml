---
# Push SuperDeploy code to Forgejo repository

- name: Check if Forgejo repository already has content
  uri:
    url: "http://localhost:{{ FORGEJO_PORT }}/api/v1/repos/{{ FORGEJO_ORG }}/{{ FORGEJO_REPO }}/contents?ref=main"
    method: GET
    user: "{{ FORGEJO_ADMIN_USER }}"
    password: "{{ FORGEJO_ADMIN_PASSWORD }}"
    force_basic_auth: yes
    status_code: [200, 404]
    timeout: 10
  register: repo_contents_check
  failed_when: false

- name: Skip push if repository already has content
  debug:
    msg: "Repository already has content, skipping push"
  when: 
    - repo_contents_check.status == 200
    - repo_contents_check.json | length > 0

- name: Create temporary directory for superdeploy code
  file:
    path: "/tmp/superdeploy-push"
    state: directory
    mode: '0755'
  when: repo_contents_check.status == 404 or (repo_contents_check.json | default([]) | length == 0)

- name: Copy superdeploy code from local machine to orchestrator
  synchronize:
    src: "{{ superdeploy_root }}/"
    dest: "/tmp/superdeploy-push/"
    delete: no
    recursive: yes
    rsync_opts:
      - "--exclude=venv"
      - "--exclude=.git"
      - "--exclude=__pycache__"
      - "--exclude=*.pyc"
      - "--exclude=.terraform"
      - "--exclude=terraform.tfstate*"
      - "--exclude=.env"
      - "--exclude=projects/*/secrets.yml"
  when: repo_contents_check.status == 404 or (repo_contents_check.json | default([]) | length == 0)

- name: Initialize git repository
  shell: |
    cd /tmp/superdeploy-push
    git config --global --add safe.directory /tmp/superdeploy-push
    git init
    git config user.email "{{ FORGEJO_ADMIN_EMAIL }}"
    git config user.name "{{ FORGEJO_ADMIN_USER }}"
    git add -A
    git commit -m "Initial commit from SuperDeploy"
  register: git_init_result
  changed_when: false
  failed_when: false
  when: repo_contents_check.status == 404 or (repo_contents_check.json | default([]) | length == 0)

- name: Push code to Forgejo
  shell: |
    cd /tmp/superdeploy-push
    git remote remove forgejo 2>/dev/null || true
    git remote add forgejo http://{{ FORGEJO_ADMIN_USER }}:{{ FORGEJO_ADMIN_PASSWORD }}@localhost:{{ FORGEJO_PORT }}/{{ FORGEJO_ORG }}/{{ FORGEJO_REPO }}.git
    git push forgejo master:master --force 2>&1
  environment:
    GIT_TERMINAL_PROMPT: "0"
  register: push_result
  failed_when: push_result.rc != 0
  when: repo_contents_check.status == 404 or (repo_contents_check.json | default([]) | length == 0)

- name: Display push result
  debug:
    msg: 
      - "SuperDeploy code push result:"
      - "Return code: {{ push_result.rc | default('N/A') }}"
      - "Output: {{ push_result.stdout | default('N/A') }}"
      - "Error: {{ push_result.stderr | default('N/A') }}"
  when: push_result is defined

- name: Clean up temporary directory
  file:
    path: "/tmp/superdeploy-push"
    state: absent
  when: repo_contents_check.status == 404 or (repo_contents_check.json | default([]) | length == 0)
