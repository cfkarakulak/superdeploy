---
# MongoDB Addon Deployment Tasks

- name: Create {{ addon_name }} directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/data"
    - "{{ addon_base_path }}/{{ addon_name }}/config"

# Note: docker-compose.yml is already rendered by orchestration/addon-deployer/tasks/render-templates.yml
# This keeps the deployment logic clean and focused on service-specific tasks

- name: Render {{ addon_name }} environment file
  template:
    src: "{{ addon_path }}/templates/mongodb.env.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/.env"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0600'
  when: addon_path is defined and addon_path | length > 0

- name: Deploy {{ addon_name }} with intelligent cleanup
  shell:
    cmd: |
      set -e
      cd "${ADDON_BASE_PATH}/${ADDON_NAME}"
      
      echo "Starting cleanup for ${PROJECT_NAME}-${ADDON_NAME}..."
      docker compose --project-name "${PROJECT_NAME}-${ADDON_NAME}" down --remove-orphans --timeout 30 2>&1 || true
      sleep 3
      
      for attempt in 1 2 3 4 5; do
        CONTAINER_IDS=$(docker ps -aq --filter "name=^${PROJECT_NAME}-${ADDON_NAME}$" 2>/dev/null || true)
        if [ -z "$CONTAINER_IDS" ]; then
          echo "✓ All containers removed (attempt $attempt)"
          break
        fi
        
        echo "Attempt $attempt: Removing containers: $CONTAINER_IDS"
        for cid in $CONTAINER_IDS; do
          docker kill "$cid" 2>&1 || true
          docker rm -f "$cid" 2>&1 || true
        done
        sleep 2
        
        if [ $attempt -eq 5 ]; then
          echo "ERROR: Failed to remove containers after 5 attempts"
          exit 1
        fi
      done
      
      docker container prune -f >/dev/null 2>&1 || true
      echo "✓ Cleanup completed"
      
      # Critical: Wait for Docker daemon to fully update its metadata
      echo "Waiting for Docker daemon to sync metadata..."
      sleep 5
    executable: /bin/bash
  environment:
    PROJECT_NAME: "{{ project_name }}"
    ADDON_NAME: "{{ addon_name }}"
    ADDON_BASE_PATH: "{{ addon_base_path }}"
  become: yes
  register: mongodb_cleanup_result
  changed_when: false

- name: Start {{ addon_name }} services (with explicit project name)
  community.docker.docker_compose_v2:
    project_name: "{{ project_name }}-{{ addon_name }}"
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: present
    pull: "always"
    recreate: "always"
    remove_orphans: true
  become: yes
  register: mongodb_compose_result

- name: Wait for {{ addon_name }} to be ready
  wait_for:
    host: localhost
    port: "{{ MONGODB_PORT | default(27017) }}"
    delay: 5
    timeout: 60
    state: started
  when: mongodb_compose_result.changed

- name: Verify {{ addon_name }} is accessible
  shell: |
    docker exec {{ project_name }}-{{ addon_name }} mongosh --eval 'db.runCommand({ ping: 1 })' --quiet
  register: mongodb_health_check
  until: mongodb_health_check.rc == 0
  retries: 5
  delay: 2
  changed_when: false
  failed_when: mongodb_health_check.rc != 0

- name: Create application user in {{ addon_name }}
  shell: |
    docker exec {{ project_name }}-{{ addon_name }} mongosh admin \
      --username admin \
      --password {{ MONGODB_ROOT_PASSWORD }} \
      --eval "db.createUser({user: '{{ MONGODB_USER }}', pwd: '{{ MONGODB_PASSWORD }}', roles: [{role: 'readWrite', db: '{{ MONGODB_DB }}'}]})" \
      --quiet
  register: user_creation
  failed_when: false
  changed_when: "'Successfully added user' in user_creation.stdout"

- name: Verify {{ addon_name }} database access
  shell: |
    docker exec {{ project_name }}-{{ addon_name }} mongosh {{ MONGODB_DB }} \
      --username {{ MONGODB_USER }} \
      --password {{ MONGODB_PASSWORD }} \
      --eval "db.runCommand({ ping: 1 })" \
      --quiet
  register: db_check
  changed_when: false
  failed_when: false

- name: Display {{ addon_name }} deployment status
  debug:
    msg: "MongoDB is ready and database '{{ MONGODB_DB }}' is accessible by user '{{ MONGODB_USER }}'"
  when: db_check.rc == 0
