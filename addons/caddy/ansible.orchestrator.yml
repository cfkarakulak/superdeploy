---
# Caddy Addon Deployment Tasks for Orchestrator
# Special configuration for monitoring reverse proxy

- name: Create {{ addon_name }} directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/logs"

- name: Generate Caddyfile for orchestrator
  template:
    src: "{{ addon_path }}/templates/Caddyfile.orchestrator.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/Caddyfile"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'
  vars:
    GRAFANA_DOMAIN: "{{ env_vars.GRAFANA_DOMAIN | default('') }}"
    PROMETHEUS_DOMAIN: "{{ env_vars.PROMETHEUS_DOMAIN | default('') }}"
    CADDY_EMAIL: "{{ env_vars.CADDY_EMAIL | default('admin@example.com') }}"

- name: Generate docker-compose.yml for orchestrator Caddy
  template:
    src: "{{ addon_path }}/templates/compose.orchestrator.yml.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/docker-compose.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'

- name: Generate {{ addon_name }} environment file
  template:
    src: "{{ addon_path }}/templates/caddy.env.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/.env"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0600'

- name: Deploy {{ addon_name }} with intelligent cleanup
  shell:
    cmd: |
      set -e
      cd "${ADDON_BASE_PATH}/${ADDON_NAME}"
      
      echo "Starting cleanup for orchestrator Caddy..."
      
      # Phase 1: Stop via Docker Compose (graceful shutdown with remove)
      echo "Phase 1: Stopping containers via Docker Compose..."
      docker compose down --remove-orphans --volumes --timeout 30 2>&1 || true
      
      # Phase 2: Wait for Docker daemon to sync
      echo "Phase 2: Waiting for Docker daemon to sync..."
      sleep 2
      
      # Phase 3: Force remove any remaining containers
      # Docker Compose without explicit project name uses directory name (caddy)
      # So containers are: caddy-caddy-1, caddy-*
      echo "Phase 3: Force removing any remaining containers..."
      REMAINING_CONTAINERS=$(docker ps -aq --filter "name=caddy-" 2>/dev/null || true)
      
      # Also check for legacy superdeploy-caddy naming
      LEGACY_CONTAINERS=$(docker ps -aq --filter "name=superdeploy-caddy" 2>/dev/null || true)
      ALL_CONTAINERS="${REMAINING_CONTAINERS} ${LEGACY_CONTAINERS}"
      
      if [ -n "$ALL_CONTAINERS" ]; then
        echo "Found remaining containers, removing..."
        echo "$ALL_CONTAINERS" | xargs -r docker rm -f 2>&1 || true
        sleep 2
      fi
      
      # Phase 4: Final verification
      echo "Phase 4: Final verification..."
      FINAL_CHECK=$(docker ps -aq --filter "name=caddy-" 2>/dev/null || true)
      FINAL_LEGACY=$(docker ps -aq --filter "name=superdeploy-caddy" 2>/dev/null || true)
      
      if [ -n "$FINAL_CHECK" ] || [ -n "$FINAL_LEGACY" ]; then
        echo "⚠ WARNING: Some containers still exist:"
        docker ps -a | grep -E "caddy-|superdeploy-caddy" || true
        echo "Attempting final force removal..."
        echo "$FINAL_CHECK $FINAL_LEGACY" | xargs -r docker rm -f 2>&1 || true
        sleep 2
      fi
      
      echo "✓ Cleanup completed - ready for deployment"
    executable: /bin/bash
  environment:
    ADDON_BASE_PATH: "{{ addon_base_path }}"
    ADDON_NAME: "{{ addon_name }}"
  become_user: "{{ superdeploy_user }}"
  changed_when: false

- name: Start {{ addon_name }} service (fresh deployment)
  community.docker.docker_compose_v2:
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: present
    pull: "always"
    recreate: "always"
    remove_orphans: true
  become_user: "{{ superdeploy_user }}"
  register: caddy_compose_result

- name: Wait for Caddy to be ready
  wait_for:
    host: localhost
    port: "{{ env_vars.CADDY_ADMIN_PORT | default(2019) }}"
    delay: 3
    timeout: 30
    state: started

- name: Verify Caddy is accessible
  uri:
    url: "http://localhost:{{ env_vars.CADDY_ADMIN_PORT | default(2019) }}/config/"
    status_code: 200
  register: caddy_health
  until: caddy_health.status == 200
  retries: 5
  delay: 3

- name: Display caddy deployment status
  debug:
    msg:
      - "Caddy Admin API: http://{{ ansible_host }}:{{ env_vars.CADDY_ADMIN_PORT | default(2019) }}"
      - "{% if env_vars.GRAFANA_DOMAIN is defined and env_vars.GRAFANA_DOMAIN %}Grafana: https://{{ env_vars.GRAFANA_DOMAIN }}{% else %}Grafana: http://{{ ansible_host }}:3000{% endif %}"
      - "{% if env_vars.PROMETHEUS_DOMAIN is defined and env_vars.PROMETHEUS_DOMAIN %}Prometheus: https://{{ env_vars.PROMETHEUS_DOMAIN }}{% else %}Prometheus: http://{{ ansible_host }}:9090{% endif %}"
      - "{% if (env_vars.GRAFANA_DOMAIN is defined and env_vars.GRAFANA_DOMAIN) or (env_vars.PROMETHEUS_DOMAIN is defined and env_vars.PROMETHEUS_DOMAIN) %}Note: Ensure DNS records point to {{ ansible_host }}{% endif %}"
