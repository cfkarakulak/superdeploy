version: '3.8'

services:
  caddy:
    image: caddy:{{ version | default('2-alpine') }}
    container_name: orchestrator-caddy
    restart: unless-stopped
    environment:
      CADDY_EMAIL: ${CADDY_EMAIL}
      GRAFANA_DOMAIN: ${GRAFANA_DOMAIN}
      PROMETHEUS_DOMAIN: ${PROMETHEUS_DOMAIN}
      FORGEJO_DOMAIN: ${FORGEJO_DOMAIN:-}
    volumes:
      - caddy-data:/data
      - caddy-config:/config
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./logs:/var/log/caddy
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-443}:443"
      - "${CADDY_ADMIN_PORT:-2019}:2019"
    networks:
      - monitoring-network
      - orchestrator-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:2019/config/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "superdeploy.service=caddy"
      - "superdeploy.component=reverse-proxy"
      - "prometheus.scrape=true"
      - "prometheus.port=2019"
      - "prometheus.path=/metrics"

volumes:
  caddy-data:
    name: orchestrator-caddy-data
  caddy-config:
    name: orchestrator-caddy-config

networks:
  monitoring-network:
    name: superdeploy-monitoring-network
    external: true
  orchestrator-network:
    name: orchestrator-network
    external: true
