# Caddyfile for {{ project_name }}
# Auto-generated by SuperDeploy

{
    # Global options
    email {{ CADDY_EMAIL | default('admin@example.com') }}
    
    # Admin API
    admin :{{ CADDY_ADMIN_PORT | default('2019') }}
    
    # Enable metrics for Prometheus
    servers {
        metrics
    }
    
    # TLS mode: auto (Let's Encrypt)
    # For production use with real domains
}

# Main configuration - subdomain-based routing
# Each app on this VM gets its own domain block
{% if apps is defined %}
{% for app_name, app_config in apps.items() %}
{% if app_config.vm == vm_role %}

# {{ app_name }} service
{% if app_config.get('domain') %}
# Domain-based routing (production)
{{ app_config.get('domain') }} {
    # Enable compression
    encode gzip zstd
    
    # Logging
    log {
        output file /data/logs/{{ app_name }}-access.log {
            roll_size 100mb
            roll_keep 5
        }
        format json
    }
    
    # Health check endpoint
    handle /health {
        respond "OK" 200
    }
    
    # Proxy to {{ app_name }} container
    reverse_proxy {{ project_name }}-{{ app_name }}:{{ app_config.internal_port | default(app_config.port) }} {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}
{% else %}
# Port-based routing (development - no domain yet)
:{{ app_config.port }} {
    # Simple pass-through to app
    reverse_proxy {{ project_name }}-{{ app_name }}:{{ app_config.internal_port | default(app_config.port) }}
}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}

# Metrics endpoint (Prometheus)
:{{ (monitoring | default({})).get('metrics_port', '2019') }} {
    metrics /metrics
}
