# Caddyfile for {{ project_name }}
# Auto-generated by SuperDeploy

{
    # Global options
    email {{ EMAIL | default('admin@example.com') }}
    
    # Admin API
    admin :{{ ADMIN_PORT | default('2019') }}
    
    # Enable metrics for Prometheus
    servers {
        metrics
    }
    
    # TLS mode: auto (Let's Encrypt)
    # For production use with real domains
}

# Main configuration - subdomain-based routing
# Each app on this VM gets its own domain block

# Port 80 catch-all with path-based routing (when no domains configured)
# Fallback for development/testing with IP-only access
{% set has_any_domain = namespace(value=false) %}
{% if apps is defined %}
{% for app_name, app_config in apps.items() %}
{% if app_config.get('vm') == vm_role and app_config.get('domain') %}
{% set has_any_domain.value = true %}
{% endif %}
{% endfor %}
{% endif %}

{% if not has_any_domain.value and apps is defined %}
# Port 80 unified routing (when no domains)
:80 {
{% for app_name, app_config in apps.items() %}
{% if app_config.get('vm') == vm_role and app_config.processes is defined %}
{% for process_name, process_config in app_config.processes.items() %}
{% if process_config.port is defined and process_name == 'web' %}
    # {{ app_name }} API routing
    handle /api/* {
        reverse_proxy {{ app_name }}-{{ process_name }}:{{ process_config.port }} {
            lb_policy round_robin
        }
    }
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
    
    # Default response
    respond "{{ project_name }} - SuperDeploy" 200
}

{% endif %}

{% if apps is defined %}
{% for app_name, app_config in apps.items() %}
{% if app_config.get('vm') == vm_role and app_config.processes is defined %}
{% for process_name, process_config in app_config.processes.items() %}
{% if process_config.port is defined %}

# {{ app_name }}-{{ process_name }} service (Port {{ process_config.port }})
:{{ process_config.port }} {
    reverse_proxy {{ app_name }}-{{ process_name }}:{{ process_config.port }} {
        lb_policy round_robin
    }
}
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}

# Metrics endpoint (Prometheus)
:{{ ADMIN_PORT | default('2019') }} {
    metrics /metrics
}
