# Caddyfile for {{ project_name }} on {{ vm_role }} VM
# Auto-generated by SuperDeploy
# Caddy routes to apps on the SAME VM

{
    # Global options
    email {{ email | default('admin@example.com') }}
    
    # Admin API
    admin :2019
    
    # Enable metrics for Prometheus
    servers {
        metrics
    }
    
    # TLS mode: auto (Let's Encrypt)
    # For production use with real domains
}

# Main configuration - subdomain-based routing
# Each app on THIS VM gets its own domain block
{% if domain is defined and domain %}
{% for app_name, app_config in apps.items() if app_config.vm == vm_role %}
{% if app_config.processes.web is defined and app_config.processes.web.port %}

# {{ app_name }} - {{ app_config.type | default('web') }}
{% if app_config.subdomain is defined and app_config.subdomain %}
{{ app_config.subdomain }}.{{ domain }} {
    # Route to app on THIS VM (same Docker network)
    reverse_proxy {{ app_name }}-web:{{ app_config.processes.web.port }} {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # Health check
        health_uri /
        health_interval 10s
        health_timeout 5s
    }
    
    # Access logging
    log {
        output file /var/log/caddy/{{ app_name }}.log
    }
}
{% else %}
# Skipping {{ app_name }}: No subdomain configured
{% endif %}
{% endif %}
{% endfor %}
{% else %}

# Port 80 and 443 routing (when no domains configured)
# Direct port-based routing for development/testing

# HTTP (Port 80) - Path-based routing
:80 {
    {% for app_name, app_config in apps.items() if app_config.vm == vm_role %}
    {% if app_config.processes.web is defined and app_config.processes.web.port %}
    # {{ app_name }} - {{ app_config.type | default('web') }} on port {{ app_config.processes.web.port }}
    handle /{{ app_name }}* {
        uri strip_prefix /{{ app_name }}
        reverse_proxy {{ app_name }}-web:{{ app_config.processes.web.port }} {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    {% endif %}
    {% endfor %}
    # Default response
    respond "{{ project_name }} • {{ vm_role }} VM • Apps: {% for app_name, app_config in apps.items() if app_config.vm == vm_role %}{{ app_name }} {% endfor %}" 200
}

# Direct port forwarding for each app (external access on app's port)
{% for app_name, app_config in apps.items() if app_config.vm == vm_role %}
{% if app_config.processes.web is defined and app_config.processes.web.port %}
# {{ app_name }} direct access on port {{ app_config.processes.web.port }}
:{{ app_config.processes.web.port }} {
    reverse_proxy {{ app_name }}-web:{{ app_config.processes.web.port }} {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }
    
    # Access logging
    log {
        output file /var/log/caddy/{{ app_name }}-direct.log
    }
}
{% endif %}
{% endfor %}

{% endif %}

# Metrics endpoint (Prometheus)
:2019 {
    metrics /metrics
}
