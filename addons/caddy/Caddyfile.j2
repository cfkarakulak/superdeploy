# Caddyfile for {{ project_name }}
# Auto-generated by SuperDeploy

{
    # Global options
    email {{ CADDY_EMAIL }}
    
    # Admin API
    admin :{{ CADDY_ADMIN_PORT | default('2019') }}
    
    {% if CADDY_TLS_MODE == 'off' %}
    # TLS disabled
    auto_https off
    {% elif CADDY_TLS_MODE == 'internal' %}
    # Internal TLS (self-signed)
    auto_https internal
    {% endif %}
}

# Main configuration - supports both domain and IP-based access
{% if CADDY_TLS_MODE == 'off' %}
:80 {
{% else %}
{{ CADDY_DOMAIN }} {
{% endif %}
    # Enable compression
    encode gzip zstd
    
    # Logging
    log {
        output file /data/logs/access.log {
            roll_size 100mb
            roll_keep 5
        }
        format json
    }
    
    # Health check endpoint
    handle /health {
        respond "OK" 200
    }
    
    {% if apps is defined %}
    # Application routes (path-based routing)
    {% for app_name, app_config in apps.items() %}
    {% if app_name != 'dashboard' %}
    # {{ app_name }} service on /{{ app_name }} path
    handle /{{ app_name }}* {
        uri strip_prefix /{{ app_name }}
        reverse_proxy {{ project_name }}-{{ app_name }}:{{ app_config.internal_port | default(app_config.port) }} {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    {% endif %}
    {% endfor %}
    
    # Dashboard on root path (must be last to catch all remaining requests)
    {% for app_name, app_config in apps.items() %}
    {% if app_name == 'dashboard' %}
    handle / {
        reverse_proxy {{ project_name }}-{{ app_name }}:{{ app_config.internal_port | default(app_config.port) }} {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    {% endif %}
    {% endfor %}
    {% endif %}
}

# Metrics endpoint (Prometheus)
:{{ monitoring.metrics_port | default('2019') }} {
    metrics /metrics
}

# Metrics endpoint (Prometheus)
:{{ monitoring.metrics_port | default('2019') }} {
    metrics /metrics
}
