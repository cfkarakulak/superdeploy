---
# Monitoring Addon Deployment Tasks
# Deploys Prometheus and Grafana for project monitoring

- name: Create {{ addon_name }} directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/prometheus"
    - "{{ addon_base_path }}/{{ addon_name }}/grafana"
    - "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning"
    - "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning/datasources"
    - "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning/dashboards"
    - "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning/dashboards/json"

- name: Initialize monitoring projects list
  set_fact:
    monitoring_projects: []
  
- name: Build monitoring projects from inventory
  set_fact:
    monitoring_projects: "{{ monitoring_projects + [{'name': item.split('-')[0], 'vms': {item.split('-')[1]: hostvars[item]['ansible_host']}}] }}"
  loop: "{{ groups['all'] | select('match', '^[^orchestrator].*-.*-\\d+$') | list }}"
  when: 
    - groups['all'] is defined
    - item.split('-') | length >= 2

- name: Merge VMs for same project
  set_fact:
    monitoring_projects_merged: {}

- name: Group VMs by project
  set_fact:
    monitoring_projects_merged: "{{ monitoring_projects_merged | combine({item.name: {'name': item.name, 'vms': (monitoring_projects_merged[item.name].vms | default({})) | combine(item.vms), 'environment': 'production'}}) }}"
  loop: "{{ monitoring_projects }}"
  when: monitoring_projects | length > 0

- name: Convert to list
  set_fact:
    monitoring_projects: "{{ monitoring_projects_merged.values() | list }}"
  when: monitoring_projects_merged | length > 0

- name: Generate Prometheus configuration
  template:
    src: "{{ addon_path }}/prometheus.yml.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/prometheus/prometheus.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'
  vars:
    projects: "{{ monitoring_projects | default([]) }}"
  register: prometheus_config_result

- name: Copy Prometheus config to volume
  shell: |
    docker cp {{ addon_base_path }}/{{ addon_name }}/prometheus/prometheus.yml superdeploy-prometheus:/etc/prometheus/prometheus.yml
  when: prometheus_config_result.changed
  ignore_errors: yes

- name: Generate Grafana datasource provisioning
  template:
    src: "{{ addon_path }}/grafana-datasources.yml.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning/datasources/datasources.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'
  vars:
    projects: "{{ monitoring_projects | default([]) }}"

- name: Generate Grafana dashboard provisioning
  template:
    src: "{{ addon_path }}/grafana-dashboards.yml.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning/dashboards/dashboards.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'
  vars:
    projects: "{{ monitoring_projects | default([]) }}"

- name: Copy pre-built Grafana dashboards
  copy:
    src: "{{ addon_path }}/dashboards/{{ item }}"
    dest: "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning/dashboards/json/{{ item }}"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'
  loop:
    - superdeploy-overview.json
    - project-detail.json
    - infrastructure.json
    - alerts.json
    - system-status.json
    - live-traffic.json
    - endpoint-analytics.json

- name: Copy Prometheus alert rules
  copy:
    src: "{{ addon_path }}/alert-rules.yml"
    dest: "{{ addon_base_path }}/{{ addon_name }}/prometheus/alert-rules.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'

# Note: docker-compose.yml is already rendered by orchestration/addon-deployer/tasks/render-templates.yml
# This keeps the deployment logic clean and focused on service-specific tasks

- name: Render {{ addon_name }} environment file
  template:
    src: "{{ addon_path }}/templates/monitoring.env.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/.env"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0600'
  when: addon_path is defined and addon_path | length > 0

- name: Start {{ addon_name }} services
  community.docker.docker_compose_v2:
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: present
    pull: "always"
  become_user: "{{ superdeploy_user }}"
  register: monitoring_compose_result

- name: Wait for Prometheus to be ready
  wait_for:
    host: localhost
    port: "{{ PROMETHEUS_PORT | default(9090) }}"
    delay: 5
    timeout: 60
    state: started
  when: monitoring_compose_result.changed

- name: Wait for Grafana to be ready
  wait_for:
    host: localhost
    port: "{{ GRAFANA_PORT | default(3000) }}"
    delay: 5
    timeout: 60
    state: started
  when: monitoring_compose_result.changed

- name: Verify Prometheus is accessible
  uri:
    url: "http://localhost:{{ PROMETHEUS_PORT | default(9090) }}/-/healthy"
    status_code: 200
    timeout: 5
  register: prometheus_health
  until: prometheus_health.status == 200
  retries: 10
  delay: 3
  failed_when: prometheus_health.status != 200

- name: Verify Grafana is accessible
  uri:
    url: "http://localhost:{{ GRAFANA_PORT | default(3000) }}/api/health"
    status_code: 200
    timeout: 5
  register: grafana_health
  until: grafana_health.status == 200
  retries: 10
  delay: 3
  failed_when: grafana_health.status != 200

- name: Check if Caddy is enabled for domain access
  set_fact:
    caddy_enabled: "{{ 'caddy' in enabled_addons | default([]) }}"
    grafana_domain: "{{ addon_configs.monitoring.grafana_domain | default('') }}"
    prometheus_domain: "{{ addon_configs.monitoring.prometheus_domain | default('') }}"

- name: Display {{ addon_name }} deployment status
  debug:
    msg:
      - "Grafana Direct: http://{{ ansible_host }}:{{ GRAFANA_PORT | default(3000) }}"
      - "Prometheus Direct: http://{{ ansible_host }}:{{ PROMETHEUS_PORT | default(9090) }}"
      - "Grafana Admin User: {{ GRAFANA_ADMIN_USER }}"
      - "{% if caddy_enabled and grafana_domain %}Grafana Domain: https://{{ grafana_domain }}{% endif %}"
      - "{% if caddy_enabled and prometheus_domain %}Prometheus Domain: https://{{ prometheus_domain }}{% endif %}"
      - "{% if caddy_enabled %}Note: Domain access requires DNS records and Caddy deployment{% endif %}"
