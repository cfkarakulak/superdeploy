---
# Monitoring Addon Deployment Tasks
# Deploys Prometheus and Grafana for project monitoring

- name: Create {{ addon_name }} directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/prometheus"
    - "{{ addon_base_path }}/{{ addon_name }}/grafana"
    - "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning"
    - "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning/datasources"
    - "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning/dashboards"
    - "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning/dashboards/json"

- name: Initialize monitoring projects list
  set_fact:
    monitoring_projects: []
  
- name: Build monitoring projects from inventory with app targets
  set_fact:
    monitoring_projects: "{{ monitoring_projects + [{'name': item.split('-')[0], 'vms': {item.split('-')[1]: hostvars[item]['ansible_host']}, 'app_targets': [hostvars[item]['ansible_host'] + ':' + (hostvars[item]['app_port'] | default('8000'))]}] }}"
  loop: "{{ groups['all'] | select('match', '^[^orchestrator].*-.*-\\d+$') | list }}"
  when: 
    - groups['all'] is defined
    - item.split('-') | length >= 2

- name: Merge VMs and app targets for same project
  set_fact:
    monitoring_projects_merged: {}

- name: Group VMs and app targets by project
  set_fact:
    monitoring_projects_merged: "{{ monitoring_projects_merged | combine({item.name: {'name': item.name, 'vms': (monitoring_projects_merged[item.name].vms | default({})) | combine(item.vms), 'app_targets': (monitoring_projects_merged[item.name].app_targets | default([])) + item.app_targets, 'environment': 'production'}}) }}"
  loop: "{{ monitoring_projects }}"
  when: monitoring_projects | length > 0

- name: Convert to list
  set_fact:
    monitoring_projects: "{{ monitoring_projects_merged.values() | list }}"
  when: monitoring_projects_merged | length > 0

- name: Generate Prometheus configuration
  template:
    src: "{{ addon_path }}/prometheus.yml.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/prometheus/prometheus.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'
  vars:
    projects: "{{ monitoring_projects | default([]) }}"
  register: prometheus_config_result

# Config will be copied after container starts

- name: Generate Grafana datasource provisioning
  template:
    src: "{{ addon_path }}/grafana-datasources.yml.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning/datasources/datasources.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'
  vars:
    projects: "{{ monitoring_projects | default([]) }}"

- name: Generate Grafana dashboard provisioning
  template:
    src: "{{ addon_path }}/grafana-dashboards.yml.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning/dashboards/dashboards.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'
  vars:
    projects: "{{ monitoring_projects | default([]) }}"

- name: Copy pre-built Grafana dashboards
  copy:
    src: "{{ addon_path }}/dashboards/{{ item }}"
    dest: "{{ addon_base_path }}/{{ addon_name }}/grafana/provisioning/dashboards/json/{{ item }}"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'
  loop:
    - superdeploy-overview.json
    - project-detail.json
    - infrastructure.json
    - alerts.json
    - system-status.json
    - live-traffic.json
    - endpoint-analytics.json

- name: Copy Prometheus alert rules
  copy:
    src: "{{ addon_path }}/alert-rules.yml"
    dest: "{{ addon_base_path }}/{{ addon_name }}/prometheus/alert-rules.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'

# Note: docker-compose.yml is already rendered by orchestration/addon-deployer/tasks/render-templates.yml
# This keeps the deployment logic clean and focused on service-specific tasks

- name: Render {{ addon_name }} environment file
  template:
    src: "{{ addon_path }}/templates/monitoring.env.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/.env"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0600'
  when: addon_path is defined and addon_path | length > 0

- name: Deploy {{ addon_name }} with intelligent cleanup
  shell:
    cmd: |
      set -e
      cd "${ADDON_BASE_PATH}/${ADDON_NAME}"
      
      echo "Starting cleanup for ${PROJECT_NAME}-${ADDON_NAME}..."
      
      # Phase 1: Stop via Docker Compose (graceful shutdown with remove)
      echo "Phase 1: Stopping containers via Docker Compose..."
      docker compose --project-name "${PROJECT_NAME}-${ADDON_NAME}" down --remove-orphans --volumes --timeout 30 2>&1 || true
      
      # Phase 2: Wait for Docker daemon to sync
      echo "Phase 2: Waiting for Docker daemon to sync..."
      sleep 5
      
      # Force sync by listing containers
      docker ps -a > /dev/null 2>&1
      
      # Phase 3: Force remove any remaining containers by exact name or prefix
      echo "Phase 3: Force removing any remaining containers..."
      # Get all container names matching our pattern and filter for exact/prefix match
      ALL_NAMES=$(docker ps -a --filter "name=${PROJECT_NAME}-${ADDON_NAME}" --format '{{ '{{' }}.Names{{ '}}' }}' 2>/dev/null || true)
      EXACT_CONTAINER=""
      PREFIX_CONTAINERS=""
      
      for name in $ALL_NAMES; do
        if [ "$name" = "${PROJECT_NAME}-${ADDON_NAME}" ]; then
          # Exact match
          EXACT_CONTAINER=$(docker ps -aq --filter "name=${name}" 2>/dev/null || true)
        elif [[ "$name" == ${PROJECT_NAME}-${ADDON_NAME}-* ]]; then
          # Prefix match (compose generated names)
          PREFIX_CONTAINERS="$PREFIX_CONTAINERS $(docker ps -aq --filter "name=${name}" 2>/dev/null || true)"
        fi
      done
      
      REMAINING_CONTAINERS=$(echo "$EXACT_CONTAINER $PREFIX_CONTAINERS" | tr -s ' ' | xargs)
      
      if [ -n "$REMAINING_CONTAINERS" ]; then
        echo "Found remaining containers: $REMAINING_CONTAINERS"
        # First stop, then remove
        echo "$REMAINING_CONTAINERS" | xargs -r docker stop -t 5 2>&1 || true
        echo "$REMAINING_CONTAINERS" | xargs -r docker rm -f 2>&1 || true
        sleep 5
      
      # Force sync by listing containers
      docker ps -a > /dev/null 2>&1
      fi
      
      # Phase 4: Final verification
      echo "Phase 4: Final verification..."
      ALL_NAMES_FINAL=$(docker ps -a --filter "name=${PROJECT_NAME}-${ADDON_NAME}" --format '{{ '{{' }}.Names{{ '}}' }}' 2>/dev/null || true)
      EXACT_CHECK=""
      PREFIX_CHECK=""
      
      for name in $ALL_NAMES_FINAL; do
        if [ "$name" = "${PROJECT_NAME}-${ADDON_NAME}" ]; then
          EXACT_CHECK=$(docker ps -aq --filter "name=${name}" 2>/dev/null || true)
        elif [[ "$name" == ${PROJECT_NAME}-${ADDON_NAME}-* ]]; then
          PREFIX_CHECK="$PREFIX_CHECK $(docker ps -aq --filter "name=${name}" 2>/dev/null || true)"
        fi
      done
      
      FINAL_CHECK=$(echo "$EXACT_CHECK $PREFIX_CHECK" | tr -s ' ' | xargs)
      
      if [ -n "$FINAL_CHECK" ]; then
        echo "⚠ WARNING: Some containers still exist:"
        docker ps -a | grep "${PROJECT_NAME}-${ADDON_NAME}" || true
        echo "Attempting final force removal..."
        # Stop first, then remove
        echo "$FINAL_CHECK" | xargs -r docker stop -t 5 2>&1 || true
        echo "$FINAL_CHECK" | xargs -r docker rm -f 2>&1 || true
        sleep 5
      
      # Force sync by listing containers
      docker ps -a > /dev/null 2>&1
      fi
      
      echo "✓ Cleanup completed - ready for deployment"
    executable: /bin/bash
  environment:
    PROJECT_NAME: "{{ project_name }}"
    ADDON_NAME: "{{ addon_name }}"
    ADDON_BASE_PATH: "{{ addon_base_path }}"
  become: yes
  register: monitoring_cleanup_result
  changed_when: false

- name: Display cleanup output (debug)
  debug:
    msg: "{{ monitoring_cleanup_result.stdout_lines }}"
  when: monitoring_cleanup_result.stdout_lines is defined

- name: Start {{ addon_name }} services (with explicit project name)
  community.docker.docker_compose_v2:
    project_name: "{{ project_name }}-{{ addon_name }}"
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: present
    pull: "always"
    recreate: "always"
    remove_orphans: true
  become: yes
  register: monitoring_compose_result

- name: Wait for Prometheus to be ready
  wait_for:
    host: localhost
    port: "{{ PROMETHEUS_PORT | default(9090) }}"
    delay: 5
    timeout: 60
    state: started
  when: monitoring_compose_result.changed

- name: Wait for Grafana to be ready
  wait_for:
    host: localhost
    port: "{{ GRAFANA_PORT | default(3000) }}"
    delay: 5
    timeout: 60
    state: started
  when: monitoring_compose_result.changed

- name: Verify Prometheus is accessible
  uri:
    url: "http://localhost:{{ PROMETHEUS_PORT | default(9090) }}/-/healthy"
    status_code: 200
    timeout: 5
  register: prometheus_health
  until: prometheus_health.status == 200
  retries: 10
  delay: 3
  failed_when: prometheus_health.status != 200

- name: Verify Grafana is accessible
  uri:
    url: "http://localhost:{{ GRAFANA_PORT | default(3000) }}/api/health"
    status_code: 200
    timeout: 5
  register: grafana_health
  until: grafana_health.status == 200
  retries: 10
  delay: 3
  failed_when: grafana_health.status != 200

- name: Reload Prometheus configuration (config is volume-mounted)
  uri:
    url: "http://localhost:{{ PROMETHEUS_PORT | default(9090) }}/-/reload"
    method: POST
    status_code: 200
    timeout: 5
  when: prometheus_config_result.changed
  register: prometheus_reload_result
  failed_when: false
  
- name: Restart Prometheus if reload failed
  community.docker.docker_compose_v2:
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    services:
      - prometheus
    state: restarted
  become: yes
  when: 
    - prometheus_config_result.changed
    - prometheus_reload_result.status is defined
    - prometheus_reload_result.status != 200

- name: Check if Caddy is enabled for domain access
  set_fact:
    caddy_enabled: "{{ 'caddy' in enabled_addons | default([]) }}"
    grafana_domain: "{{ addon_configs.monitoring.grafana_domain | default('') }}"
    prometheus_domain: "{{ addon_configs.monitoring.prometheus_domain | default('') }}"

- name: Display {{ addon_name }} deployment status
  debug:
    msg:
      - "Grafana Direct: http://{{ ansible_host }}:{{ GRAFANA_PORT | default(3000) }}"
      - "Prometheus Direct: http://{{ ansible_host }}:{{ PROMETHEUS_PORT | default(9090) }}"
      - "Grafana Admin User: {{ GRAFANA_ADMIN_USER }}"
      - "{% if caddy_enabled and grafana_domain %}Grafana Domain: https://{{ grafana_domain }}{% endif %}"
      - "{% if caddy_enabled and prometheus_domain %}Prometheus Domain: https://{{ prometheus_domain }}{% endif %}"
      - "{% if caddy_enabled %}Note: Domain access requires DNS records and Caddy deployment{% endif %}"
