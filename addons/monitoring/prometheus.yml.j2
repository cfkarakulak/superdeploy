# Prometheus Configuration
# Auto-generated by SuperDeploy for all projects

global:
  scrape_interval: {{ scrape_interval | default('15s') }}
  evaluation_interval: {{ evaluation_interval | default('15s') }}
  scrape_timeout: {{ scrape_timeout | default('10s') }}
  external_labels:
    monitor: 'superdeploy-monitor'
    environment: '{{ environment | default("production") }}'

# Alertmanager configuration (optional)
{% if alertmanager_url is defined %}
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - '{{ alertmanager_url }}'
{% endif %}

# Scrape configurations for all projects
scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'
          component: 'monitoring'

  # Grafana monitoring
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
        labels:
          service: 'grafana'
          component: 'monitoring'

{% for project in projects %}
  # Project: {{ project.name }}
  - job_name: '{{ project.name }}-services'
    static_configs:
      - targets: 
{% for target in project.targets %}
          - '{{ target }}'
{% endfor %}
        labels:
          project: '{{ project.name }}'
          environment: '{{ project.environment | default("production") }}'
          vm: '{{ project.vm | default("core") }}'
{% if project.tags is defined %}
{% for tag in project.tags %}
          tag_{{ loop.index }}: '{{ tag }}'
{% endfor %}
{% endif %}
    relabel_configs:
      # Add project name to instance label
      - source_labels: [__address__]
        target_label: instance
        replacement: '{{ project.name }}-${1}'
      # Preserve original address
      - source_labels: [__address__]
        target_label: __param_target
      # Set the scrape URL
      - source_labels: [__param_target]
        target_label: __address__
        replacement: '${1}'

  # Project: {{ project.name }} - Node Exporter (if enabled)
{% if project.node_exporter_enabled | default(true) %}
  - job_name: '{{ project.name }}-node'
    static_configs:
      - targets: ['{{ project.host }}:9100']
        labels:
          project: '{{ project.name }}'
          environment: '{{ project.environment | default("production") }}'
          vm: '{{ project.vm | default("core") }}'
          service: 'node-exporter'
{% endif %}

  # Project: {{ project.name }} - Docker metrics (if enabled)
{% if project.docker_metrics_enabled | default(true) %}
  - job_name: '{{ project.name }}-docker'
    static_configs:
      - targets: ['{{ project.host }}:9323']
        labels:
          project: '{{ project.name }}'
          environment: '{{ project.environment | default("production") }}'
          vm: '{{ project.vm | default("core") }}'
          service: 'docker'
{% endif %}

{% endfor %}

  # Service discovery for dynamic targets (optional)
  - job_name: 'docker-services'
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
    relabel_configs:
      # Only scrape containers with prometheus.scrape=true label
      - source_labels: [__meta_docker_container_label_prometheus_scrape]
        action: keep
        regex: true
      # Use custom port if specified
      - source_labels: [__meta_docker_container_label_prometheus_port]
        action: replace
        target_label: __address__
        regex: (.+)
        replacement: ${1}
      # Use custom path if specified
      - source_labels: [__meta_docker_container_label_prometheus_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
        replacement: ${1}
      # Add container name as instance
      - source_labels: [__meta_docker_container_name]
        action: replace
        target_label: instance
        regex: /(.+)
        replacement: ${1}
      # Add project label from container label
      - source_labels: [__meta_docker_container_label_superdeploy_project]
        action: replace
        target_label: project
      # Add service label from container label
      - source_labels: [__meta_docker_container_label_superdeploy_service]
        action: replace
        target_label: service
