---
# PostgreSQL Addon Deployment Tasks

- name: Create {{ addon_name }} directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/data"

# Note: docker-compose.yml is already rendered by orchestration/addon-deployer/tasks/render-templates.yml
# This keeps the deployment logic clean and focused on service-specific tasks

- name: Render {{ addon_name }} environment file
  template:
    src: "{{ addon_path }}/templates/postgres.env.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/.env"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0600'
  when: addon_path is defined and addon_path | length > 0

- name: Stop and remove existing {{ addon_name }} containers (idempotent cleanup)
  community.docker.docker_compose_v2:
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: absent
    remove_orphans: true
  become_user: "{{ superdeploy_user }}"
  failed_when: false
  ignore_errors: true

- name: Force remove {{ addon_name }} container if still exists (running or stopped)
  shell: |
    docker ps -a --filter "name={{ project_name }}-{{ addon_name }}" --format "{% raw %}{{.Names}}{% endraw %}" | xargs -r docker rm -f 2>/dev/null || true
  become_user: "{{ superdeploy_user }}"
  changed_when: false

- name: Start {{ addon_name }} services (fresh deployment)
  community.docker.docker_compose_v2:
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: present
    pull: "always"
    recreate: "always"
    remove_orphans: true
  become_user: "{{ superdeploy_user }}"
  register: postgres_compose_result

- name: Verify {{ addon_name }} is accessible
  shell: |
    docker exec {{ project_name }}-{{ addon_name }} pg_isready -U {{ POSTGRES_USER }}
  register: postgres_health_check
  until: postgres_health_check.rc == 0
  retries: 5
  delay: 2
  changed_when: false
  failed_when: postgres_health_check.rc != 0

- name: Verify {{ addon_name }} database exists
  shell: |
    docker exec {{ project_name }}-{{ addon_name }} psql -U {{ POSTGRES_USER }} -lqt | cut -d \| -f 1 | grep -qw {{ POSTGRES_DB }}
  register: db_check
  changed_when: false
  failed_when: false

- name: Display {{ addon_name }} deployment status
  debug:
    msg: "PostgreSQL is ready and database '{{ POSTGRES_DB }}' is accessible"
  when: db_check.rc == 0
