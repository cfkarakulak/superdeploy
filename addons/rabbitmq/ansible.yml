---
# RabbitMQ Addon Deployment Tasks

- name: Create {{ addon_name }} directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0755'
  loop:
    - "{{ addon_base_path }}/{{ addon_name }}"
    - "{{ addon_base_path }}/{{ addon_name }}/data"

- name: Render {{ addon_name }} docker-compose.yml
  template:
    src: "{{ addon_path }}/compose.yml.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/docker-compose.yml"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0644'

- name: Render {{ addon_name }} environment file
  template:
    src: "{{ addon_path }}/templates/rabbitmq.env.j2"
    dest: "{{ addon_base_path }}/{{ addon_name }}/.env"
    owner: "{{ superdeploy_user }}"
    group: "{{ superdeploy_group | default(superdeploy_user) }}"
    mode: '0600'
  when: addon_path is defined and addon_path | length > 0

- name: Start {{ addon_name }} services
  community.docker.docker_compose:
    project_src: "{{ addon_base_path }}/{{ addon_name }}"
    state: present
    pull: true
  become_user: "{{ superdeploy_user }}"
  register: rabbitmq_compose_result

- name: Wait for {{ addon_name }} to be ready
  wait_for:
    host: localhost
    port: "{{ RABBITMQ_PORT | default(5672) }}"
    delay: 10
    timeout: 120
    state: started
  when: rabbitmq_compose_result.changed

- name: Verify {{ addon_name }} is accessible
  shell: |
    docker exec {{ project_name }}-{{ addon_name }} rabbitmq-diagnostics -q ping
  register: rabbitmq_health_check
  until: rabbitmq_health_check.rc == 0
  retries: 10
  delay: 6
  changed_when: false
  failed_when: rabbitmq_health_check.rc != 0

- name: Wait for {{ addon_name }} management plugin
  shell: |
    docker exec {{ project_name }}-{{ addon_name }} rabbitmq-plugins list -e | grep -q rabbitmq_management
  register: management_check
  until: management_check.rc == 0
  retries: 5
  delay: 3
  changed_when: false

- name: Verify {{ addon_name }} virtual host exists
  shell: |
    docker exec {{ project_name }}-{{ addon_name }} rabbitmqctl list_vhosts | grep -qw /
  register: vhost_check
  changed_when: false
  failed_when: false

- name: Set permissions for user on virtual host
  shell: |
    docker exec {{ project_name }}-{{ addon_name }} rabbitmqctl set_permissions -p / {{ RABBITMQ_USER }} ".*" ".*" ".*"
  changed_when: false

- name: Display {{ addon_name }} deployment status
  debug:
    msg: "RabbitMQ is ready - Management UI available on port {{ RABBITMQ_MANAGEMENT_PORT | default(15672) }}, AMQP on port {{ RABBITMQ_PORT | default(5672) }}"
